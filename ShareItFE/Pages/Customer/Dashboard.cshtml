@page
@model ShareItFE.Pages.Customer.DashboardModel
@{
    ViewData["Title"] = "Customer Dashboard";
}

@section Styles {
    <link rel="stylesheet" href="~/css/customer-dashboard.css" asp-append-version="true" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
}

<div class="dashboard-container">
    <!-- Header -->
    <div class="dashboard-header">
        <div>
            <h1 class="dashboard-title">Customer Dashboard</h1>
            <p class="dashboard-subtitle">Track your spending, view rental history, and manage finances</p>
        </div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-navigation">
        <a href="/Customer/Dashboard" class="tab-link active">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
            </svg>
            Spending Overview
        </a>
        <a href="/Customer/DepositManagement" class="tab-link">
            <svg class="tab-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            Deposit Management
        </a>
    </div>

    <!-- Filters and Actions -->
    <div class="controls-bar">
        <div class="filter-buttons">
            <button class="filter-btn @(Model.Period == "week" ? "active" : "")" onclick="location.href='?period=week'">Week</button>
            <button class="filter-btn @(Model.Period == "month" ? "active" : "")" onclick="location.href='?period=month'">Month</button>
            <button class="filter-btn @(Model.Period == "year" ? "active" : "")" onclick="location.href='?period=year'">Year</button>
        </div>
        @* Export Report button - hidden for now
        <form method="post" asp-page-handler="ExportReport">
            <button type="submit" class="export-btn">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Export Report
            </button>
        </form>
        *@
        </div>

    <!-- Statistics Cards -->
        <div class="stats-grid">
        <!-- Spending Card (Rent + Purchase) -->
            <div class="stat-card">
            <div class="stat-content">
                <div class="stat-info">
                    <p class="stat-label">@Model.PeriodLabel Spending</p>
                    <h3 class="stat-value">@Model.Stats.ThisPeriodSpending.ToString("N0")₫</h3>
                    <div class="stat-change @(Model.Stats.SpendingChangePercentage >= 0 ? "positive" : "negative")">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                        <span>@(Model.Stats.SpendingChangePercentage >= 0 ? "+" : "")@Model.Stats.SpendingChangePercentage.ToString("N1")%</span>
                        <span class="vs-text">vs last @Model.Period</span>
                    </div>
                </div>
                <div class="stat-icon green">
                    <svg viewBox="0 0 24 24" fill="currentColor">
                        <text x="50%" y="50%" text-anchor="middle" dominant-baseline="central" font-size="20" font-weight="bold" fill="currentColor">₫</text>
                    </svg>
                    </div>
                </div>
            </div>

        <!-- Orders Card -->
            <div class="stat-card">
                <div class="stat-content">
                <div class="stat-info">
                    <p class="stat-label">Orders</p>
                    <h3 class="stat-value">@Model.Stats.OrdersCount</h3>
                    <div class="stat-change @(Model.Stats.OrdersChangePercentage >= 0 ? "positive" : "negative")">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                        <span>@(Model.Stats.OrdersChangePercentage >= 0 ? "+" : "")@Model.Stats.OrdersChangePercentage.ToString("N1")%</span>
                        <span class="vs-text">vs last @Model.Period</span>
                    </div>
                </div>
                <div class="stat-icon blue">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                    </svg>
                    </div>
                </div>
            </div>

        <!-- Penalty Paid Card -->
            <div class="stat-card">
            <div class="stat-content">
                <div class="stat-info">
                    <p class="stat-label">@Model.PeriodLabel Penalty Paid</p>
                    <h3 class="stat-value">@Model.Stats.PenaltyPaidThisPeriod.ToString("N0")₫</h3>
                    <div class="stat-change @(Model.Stats.PenaltyPaidChangePercentage >= 0 ? "positive" : "negative")">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                        </svg>
                        <span>@(Model.Stats.PenaltyPaidChangePercentage >= 0 ? "+" : "")@Model.Stats.PenaltyPaidChangePercentage.ToString("N1")%</span>
                        <span class="vs-text">vs last @Model.Period</span>
                    </div>
                </div>
                <div class="stat-icon purple">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    </div>
                </div>
            </div>

        <!-- Most Rented Category Card -->
            <div class="stat-card">
            <div class="stat-content">
                <div class="stat-info">
                    <p class="stat-label">Most Rented Category</p>
                    <h3 class="stat-value category-name">@Model.Stats.FavoriteCategory</h3>
                    <p class="stat-detail">@Model.Stats.FavoriteCategoryRentalCount returned orders this @Model.Period</p>
                </div>
                <div class="stat-icon yellow">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                    </svg>
                </div>
                </div>
            </div>
        </div>

    <!-- Summary Section - All Time Totals -->
    <div class="totals-grid" style="margin: 2rem 0; display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
        
        <!-- Total Rental + Purchase -->
        <div class="total-card" style="padding: 1.5rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                <div>
                    <p style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Rental + Purchase</p>
                    <h3 style="font-size: 1.75rem; font-weight: bold; margin: 0;">@Model.Stats.TotalRentalPurchaseAllTime.ToString("N0")₫</h3>
                    <p style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;">All time rentals and purchases</p>
                </div>
                <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 32px; height: 32px;" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Total Deposited -->
        <div class="total-card" style="padding: 1.5rem; background: linear-gradient(135deg, #2980b9 0%, #3498db 100%); border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                <div>
                    <p style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Deposited</p>
                    <h3 style="font-size: 1.75rem; font-weight: bold; margin: 0;">@Model.Stats.TotalDepositedAllTime.ToString("N0")₫</h3>
                    <p style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;">All time security deposits paid</p>
                </div>
                <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 32px; height: 32px;" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" />
                    </svg>
                </div>
            </div>
        </div>

        <!-- Total Penalties -->
        <div class="total-card" style="padding: 1.5rem; background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); border-radius: 1rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <div style="display: flex; justify-content: space-between; align-items: center; color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.3);">
                <div>
                    <p style="font-size: 0.875rem; opacity: 0.9; margin-bottom: 0.5rem;">Total Penalties</p>
                    <h3 style="font-size: 1.75rem; font-weight: bold; margin: 0;">@Model.Stats.TotalPenaltiesAllTime.ToString("N0")₫</h3>
                    <p style="font-size: 0.75rem; opacity: 0.8; margin-top: 0.5rem;">All time penalties paid</p>
                </div>
                <div style="width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                    <svg style="width: 32px; height: 32px;" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                </div>
            </div>
        </div>
    </div>

        <!-- Charts Section -->
        <div class="charts-grid">
        <!-- Spending Charts with Tabs -->
            <div class="chart-card">
            <div class="chart-tabs">
                <button class="chart-tab active" data-chart="trend">Spending Trend</button>
                <button class="chart-tab" data-chart="category">Spending by Category</button>
            </div>
            <div class="chart-container" id="trendChartContainer">
                <canvas id="spendingTrendChart"></canvas>
            </div>
            <div class="chart-container" id="categoryChartContainer" style="display: none;">
                <canvas id="spendingCategoryChart"></canvas>
                </div>
            </div>

        <!-- Order Status Breakdown Chart -->
            <div class="chart-card">
                <h3 class="chart-title">Order Status Breakdown</h3>
            <div class="chart-container">
                <canvas id="orderStatusChart"></canvas>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Tab switching functionality
        document.querySelectorAll('.chart-tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const chartType = this.getAttribute('data-chart');
                
                // Update active tab
                document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Show/hide chart containers
                if (chartType === 'trend') {
                    document.getElementById('trendChartContainer').style.display = 'block';
                    document.getElementById('categoryChartContainer').style.display = 'none';
                } else {
                    document.getElementById('trendChartContainer').style.display = 'none';
                    document.getElementById('categoryChartContainer').style.display = 'block';
                }
            });
        });

        // Spending Trend Chart
        const spendingCtx = document.getElementById('spendingTrendChart').getContext('2d');
        const spendingData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.SpendingTrend, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }));
        
        console.log('Spending Data:', spendingData);
        
        if (spendingData && spendingData.length > 0) {
            new Chart(spendingCtx, {
                type: 'line',
                data: {
                    labels: spendingData.map(d => d.date),
                    datasets: [{
                        label: 'Spending',
                        data: spendingData.map(d => d.amount),
                        borderColor: 'rgb(147, 51, 234)',
                        backgroundColor: 'rgba(147, 51, 234, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('vi-VN') + '₫';
                                }
                            }
                        }
                    }
                }
            });
        } else {
            // Show "No data" message
            const spendingChartContainer = spendingCtx.canvas.parentElement;
            spendingChartContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 300px; color: #6b7280; font-size: 1rem;">No spending data for this period</div>';
        }

        // Spending by Category Chart (Bar Chart)
        const categoryCtx = document.getElementById('spendingCategoryChart').getContext('2d');
        const categoryData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.SpendingByCategory, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }));
        
        console.log('Category Data:', categoryData);
        
        if (categoryData && categoryData.length > 0) {
            new Chart(categoryCtx, {
                type: 'bar',
                data: {
                    labels: categoryData.map(d => d.categoryName),
                    datasets: [{
                        label: 'Total Spending',
                        data: categoryData.map(d => d.totalSpending),
                        backgroundColor: [
                            'rgba(147, 51, 234, 0.8)',   // Purple
                            'rgba(59, 130, 246, 0.8)',   // Blue
                            'rgba(34, 197, 94, 0.8)',    // Green
                            'rgba(234, 179, 8, 0.8)',    // Yellow
                            'rgba(239, 68, 68, 0.8)',    // Red
                            'rgba(168, 85, 247, 0.8)',   // Light Purple
                            'rgba(236, 72, 153, 0.8)'    // Pink
                        ],
                        borderColor: [
                            'rgb(147, 51, 234)',
                            'rgb(59, 130, 246)',
                            'rgb(34, 197, 94)',
                            'rgb(234, 179, 8)',
                            'rgb(239, 68, 68)',
                            'rgb(168, 85, 247)',
                            'rgb(236, 72, 153)'
                        ],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const category = categoryData[context.dataIndex];
                                    return [
                                        'Total: ' + context.parsed.y.toLocaleString('vi-VN') + '₫',
                                        'Orders: ' + category.orderCount
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('vi-VN') + '₫';
                                }
                            }
                        }
                    }
                }
            });
        } else {
            const categoryChartContainer = categoryCtx.canvas.parentElement;
            categoryChartContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 300px; color: #6b7280; font-size: 1rem;">No category spending data for this period</div>';
        }

        // Order Status Breakdown Chart
        const statusCtx = document.getElementById('orderStatusChart').getContext('2d');
        const statusData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.OrderStatusBreakdown, new System.Text.Json.JsonSerializerOptions { PropertyNamingPolicy = System.Text.Json.JsonNamingPolicy.CamelCase }));
        
        console.log('Status Data:', statusData);
        
        // Check if we have data
        if (statusData && statusData.length > 0) {
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: statusData.map(d => d.status),
                    datasets: [{
                        data: statusData.map(d => d.count),
                        backgroundColor: [
                            'rgb(34, 197, 94)',   // Green
                            'rgb(59, 130, 246)',   // Blue
                            'rgb(234, 179, 8)',    // Yellow
                            'rgb(239, 68, 68)',    // Red
                            'rgb(168, 85, 247)',   // Purple
                            'rgb(236, 72, 153)'    // Pink
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        } else {
            // Show "No data" message
            const chartContainer = statusCtx.canvas.parentElement;
            chartContainer.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 300px; color: #6b7280; font-size: 1rem;">No order data for this period</div>';
        }
    </script>
}

