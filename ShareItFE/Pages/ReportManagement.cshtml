@page
@model ShareItFE.Pages.ReportManagementModel
@{
    ViewData["Title"] = "Report Management";
    Layout = Model.CurrentUserRole == "admin" ? "_AdminLayout" : "_Layout";

    string GetPriorityClass(BusinessObject.Enums.ReportPriority priority)
    {
        return priority switch
        {
            BusinessObject.Enums.ReportPriority.Critical => "priority-critical",
            BusinessObject.Enums.ReportPriority.High => "priority-high",
            BusinessObject.Enums.ReportPriority.Medium => "priority-medium",
            BusinessObject.Enums.ReportPriority.Low => "priority-low",
            _ => ""
        };
    }

    string GetStatusIcon(string status)
    {
        return status.ToLower() switch
        {
            "open" => "bi-clock",
            "inprogress" => "bi-arrow-repeat",
            "in_progress" => "bi-arrow-repeat", // optional
            "resolved" => "bi-check-circle-fill",
            "awaitingcustomerresponse" => "bi-person-vcard",
            "awaiting_customer_response" => "bi-person-vcard", // optional
            "resolutionnote" => "bi-journal-check",
            _ => "bi-question-circle"
        };
    }

}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
<link rel="stylesheet" href="~/css/report-management.css" asp-append-version="true" />

<style>
    /* Product Card Styles */
    .product-card {
        display: flex;
        gap: 12px;
        padding: 16px;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        background: #ffffff;
        transition: all 0.2s ease;
    }
    
    .product-card.reported-product {
        border: 2px solid #dc2626;
        background: #fef2f2;
        position: relative;
    }
    
    .product-card.reported-product::before {
        content: "REPORTED";
        position: absolute;
        top: -8px;
        right: 12px;
        background: #dc2626;
        color: white;
        padding: 2px 8px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
    }
    
    .product-card.clickable:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        border-color: #3b82f6;
    }
    
    .product-card.clickable:hover .product-name {
        color: #3b82f6;
    }
    
    .product-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 6px;
        border: 1px solid #e5e7eb;
        flex-shrink: 0;
    }
    
    .product-details {
        flex: 1;
        min-width: 0;
    }
    
    .product-name {
        font-weight: 600;
        font-size: 1rem;
        margin: 0 0 4px 0;
        color: #111827;
        line-height: 1.4;
    }
    
    .product-meta {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        margin: 8px 0;
        font-size: 0.875rem;
        color: #6b7280;
    }
    
    .product-meta span {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    
    .product-price {
        font-weight: 600;
        font-size: 1rem;
        color: #059669;
        margin: 4px 0 0 0;
    }
    
    /* Evidence Gallery Styles */
    .evidence-gallery {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
        gap: 12px;
        margin-top: 8px;
    }
    
    .evidence-item {
        position: relative;
        aspect-ratio: 1;
        border-radius: 8px;
        overflow: hidden;
        border: 2px solid #e5e7eb;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .evidence-item:hover {
        border-color: #3b82f6;
        transform: scale(1.02);
    }
    
    .evidence-item img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .evidence-item .overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    
    .evidence-item:hover .overlay {
        opacity: 1;
    }
    
    .evidence-item .overlay i {
        color: white;
        font-size: 1.5rem;
    }
    
    /* Products List Styles */
    .products-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    
    .product-card.normal {
        border-color: #e5e7eb;
        background: #f9fafb;
    }
    
    /* Image Modal Styles */
    .image-modal {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        opacity: 0;
        visibility: hidden;
        transition: all 0.3s ease;
    }
    
    .image-modal.show {
        opacity: 1;
        visibility: visible;
    }
    
    .image-modal img {
        max-width: 90vw;
        max-height: 90vh;
        object-fit: contain;
        border-radius: 8px;
    }
    
    .image-modal .close-btn {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(220, 38, 38, 0.9);
        border: 2px solid white;
        color: white;
        font-size: 2rem;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        font-weight: bold;
    }
    
    .image-modal .close-btn:hover {
        background: rgba(220, 38, 38, 1);
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }
    
    /* Modal Layout - Keep 1:1 columns, but move Order Information to right column above Actions */
    .modal-grid.has-order-info {
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
    }
    
    /* Evidence Counter Styles */
    .evidence-counter {
        position: absolute;
        top: 5px;
        right: 5px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: 12px;
        font-weight: bold;
    }
    
    .multiple-evidence .overlay {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 4px;
    }
    
    /* Evidence Carousel Modal */
    .evidence-carousel-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
    }
    
    .carousel-container {
        position: relative;
        max-width: 90%;
        max-height: 90%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .carousel-image {
        max-width: 100%;
        max-height: 80vh;
        object-fit: contain;
        border-radius: 8px;
    }
    
    .carousel-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(255, 255, 255, 0.2);
        border: none;
        color: white;
        font-size: 24px;
        padding: 10px 15px;
        cursor: pointer;
        border-radius: 50%;
        transition: background 0.2s ease;
    }
    
    .carousel-nav:hover {
        background: rgba(255, 255, 255, 0.3);
    }
    
    .carousel-nav.prev {
        left: -60px;
    }
    
    .carousel-nav.next {
        right: -60px;
    }
    
    .carousel-close {
        position: absolute;
        top: 20px;
        right: 20px;
        background: rgba(220, 38, 38, 0.9);
        border: 2px solid white;
        color: white;
        font-size: 28px;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        border-radius: 50%;
        transition: all 0.2s ease;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        font-weight: bold;
    }
    
    .carousel-close:hover {
        background: rgba(220, 38, 38, 1);
        transform: scale(1.1);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4);
    }
    
    .carousel-counter {
        position: absolute;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 14px;
    }
</style>
@Html.AntiForgeryToken()

<div class="page-container">
    @if (!string.IsNullOrEmpty(Model.NotificationMessage))
    {
        <div id="toast-notification" class="notification-toast @Model.NotificationType">
            @Model.NotificationMessage
        </div>
    }

    <div class="page-header">
        <div>
            <h1>Report Management</h1>
            <p>Manage and respond to user-submitted reports</p>
        </div>
        <div class="header-actions">
            <div id="realtime-status" class="status-indicator status-disconnected">
                <div class="dot"></div>
                <span>Connecting...</span>
            </div>
        </div>
    </div>
    <div class="card search-card">
        <form method="get" class="search-bar">
            <i class="bi bi-search"></i>
            <input type="hidden" name="tab" value="@Model.Tab" />
            <input asp-for="SearchQuery" placeholder="Search reports by ID, subject, or email " />
        </form>
    </div>
    <div class="card">
        <div class="tabs" style="display:flex; gap:.5rem; align-items:center;">
            <a asp-page="/ReportManagement" asp-route-tab="all" class="@(Model.Tab == "all" ? "active" : "")" style="display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .875rem; border-radius:.5rem; border:1px solid #e5e7eb; color:#374151; text-decoration:none;">
                <i class="bi bi-list-task"></i>
                <span>All Reports</span>
                <span style="background:#eef2ff; color:#4f46e5; font-weight:600; padding:0 .5rem; border-radius:9999px;">@Model.AllReportsCount</span>
            </a>
            <a asp-page="/ReportManagement" asp-route-tab="mytasks" class="@(Model.Tab == "mytasks" ? "active" : "")" style="display:inline-flex; align-items:center; gap:.5rem; padding:.5rem .875rem; border-radius:.5rem; border:1px solid #e5e7eb; color:#374151; text-decoration:none;">
                <i class="bi bi-person-check"></i>
                <span>My Tasks</span>
                <span style="background:#ecfeff; color:#0891b2; font-weight:600; padding:0 .5rem; border-radius:9999px;">@Model.MyTasksCount</span>
            </a>
        </div>
        <div class="table-container">
            <table class="report-table">
                <thead>
                    <tr>
                        <th>Report Info</th>
                        <th>Reporter</th>
                        <th>Date</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="reports-table-body">
                    @if (Model.Reports.Any())
                    {
                        @foreach (var report in Model.Reports)
                        {
                            <tr data-report-id="@report.Id">
                                <td>
                                    <div class="id-info">
                                        <div class="priority-dot @GetPriorityClass(report.Priority)" title="@report.Priority Priority"></div>
                                        <div>
                                            <div class="reporter-name">@report.Id.ToString("N").Substring(0, 8)</div>
                                            <div class="report-subject" title="@report.Subject">@report.Subject</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="reporter-info">
                                        <i class="bi bi-person-circle" style="font-size: 1.5rem; color: #9ca3af;"></i>
                                        <div>
                                            <div class="reporter-name">@report.ReporterName</div>
                                            <div class="reporter-email">@report.ReporterEmail</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div class="date-info">
                                        <i class="bi bi-calendar-event"></i>
                                        <span>@report.DateCreated.ToString("dd/MM/yyyy HH:mm")</span>
                                    </div>
                                </td>
                                <td>
                                    @{
                                        var statusString = report.Status ?? "Unknown";
                                    }
                                    <span class="status-badge status-@statusString.ToLower().Replace(" ", "-")">
                                        <i class="@GetStatusIcon(statusString)"></i>
                                        <span>@statusString</span>
                                    </span>

                                </td>
                                <td>
                                    @if (Model.Tab == "all")
                                    {
                                        <form method="post" asp-page-handler="TakeTask" asp-route-reportId="@report.Id" style="display:inline;">
                                            @Html.AntiForgeryToken()
                                            <button type="submit" class="btn-action btn-take-task"><i class="bi bi-person-check-fill"></i> Take Task</button>
                                        </form>
                                    }
                                    else
                                    {
                                        <button class="btn-action btn-view-details" data-report-id="@report.Id"><i class="bi bi-eye"></i> View Details</button>
                                    }
                                </td>
                            </tr>
                        }
                    }
                    else
                    {
                        <tr><td colspan="5"><div class="empty-state"><div class="icon"><i class="bi bi-folder2-open"></i></div><h3>No reports found</h3><p>There are no reports to display in this view.</p></div></td></tr>
                    }
                </tbody>
            </table>
        </div>
        @if (Model.TotalPages > 0)
        {
            <div class="pagination-container">
                <div class="pagination-info">Showing <strong>@((Model.CurrentPage - 1) * Model.PageSize + 1)</strong> to <strong>@Math.Min(Model.CurrentPage * Model.PageSize, Model.TotalCount)</strong> of <strong>@Model.TotalCount</strong> results</div>
                <div class="pagination-controls">
                    <a asp-page="/ReportManagement" asp-route-tab="@Model.Tab" asp-route-SearchQuery="@Model.SearchQuery" asp-route-CurrentPage="@(Model.CurrentPage - 1)" class="@(Model.CurrentPage <= 1 ? "disabled" : "")"><i class="bi bi-chevron-left"></i></a>
                    @{
                        var reportPaginationItems = ShareItFE.Utilities.PaginationHelper.GetPaginationItems(Model.CurrentPage, Model.TotalPages);
                    }
                    @foreach (var item in reportPaginationItems)
                    {
                        if (item.ToString() == "...")
                        {
                            <span class="disabled">...</span>
                        }
                        else
                        {
                            var pageNum = (int)item;
                            <a asp-page="/ReportManagement" asp-route-tab="@Model.Tab" asp-route-SearchQuery="@Model.SearchQuery" asp-route-CurrentPage="@pageNum" class="@(pageNum == Model.CurrentPage ? "active" : "")">@pageNum</a>
                        }
                    }
                    <a asp-page="/ReportManagement" asp-route-tab="@Model.Tab" asp-route-SearchQuery="@Model.SearchQuery" asp-route-CurrentPage="@(Model.CurrentPage + 1)" class="@(Model.CurrentPage >= Model.TotalPages ? "disabled" : "")"><i class="bi bi-chevron-right"></i></a>
                </div>
            </div>
        }
    </div>
</div>

<div id="report-detail-modal" class="modal-overlay hidden">
    <div class="modal-content">
        <div class="modal-header">
            <div class="header-info">
                <div id="modal-priority-dot" class="priority-dot"></div>
                <div>
                    <h2>Report Details</h2>
                    <p>ID: <span id="modal-report-id-display"></span></p>
                </div>
            </div>
            <button id="modal-close-btn" type="button" style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">&times;</button>
        </div>

        <div class="modal-body">
            <div class="modal-grid">
                <div class="modal-col">
                    <div class="modal-section">
                        <h3>Report Information</h3>
                        <div class="info-card">
                            <div><label>Subject</label><p id="modal-subject"></p></div>
                            <div><label>Description</label><p id="modal-description"></p></div>
                            <div class="grid-2">
                                <div><label>Priority</label><p id="modal-priority"></p></div>
                                <div><label>Date Created</label><p id="modal-date"></p></div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-section">
                        <h3>Reporter</h3>
                        <div class="user-card reporter-card" style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                            <div style="display:flex; align-items:center; gap:12px;">
                                <div class="icon-wrapper"><i class="bi bi-person-fill"></i></div>
                                <div>
                                    <p class="reporter-name" id="modal-reporter-name"></p>
                                    <p class="reporter-email" id="modal-reporter-email"></p>
                                </div>
                            </div>
                            <button type="button" id="btn-message-reporter" class="btn btn-sm btn-outline-primary">Message</button>
                        </div>
                    </div>
                    <div class="modal-section">
                        <h3>Reported User</h3>
                        <div class="user-card reportee-card" style="display:flex; align-items:center; justify-content:space-between; gap:8px;">
                            <div style="display:flex; align-items:center; gap:12px;">
                                <div class="icon-wrapper"><i class="bi bi-exclamation-triangle-fill"></i></div>
                                <div>
                                    <p class="reporter-name" id="modal-reportee-name"></p>
                                    <p class="reporter-email" id="modal-reportee-email"></p>
                                </div>
                            </div>
                            <button type="button" id="btn-message-reportee" class="btn btn-sm btn-outline-primary">Message</button>
                        </div>
                    </div>
                    
                    <!-- Order Information Section (only for OrderItem reports) -->
                    <div class="modal-section" id="order-info-section" style="display:none;">
                        <h3><i class="bi bi-box-seam"></i> Order Information</h3>
                        <div class="info-card">
                            <div><label>Order Code</label><p id="modal-order-code"></p></div>
                            <div><label>Report Type</label><p id="modal-report-type"></p></div>
                        </div>
                        
                        <!-- Reported Product (for OrderItem reports) -->
                        <div id="reported-product-container" style="margin-top: 1rem; display: none;">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: #dc2626;">
                                <i class="bi bi-exclamation-triangle-fill"></i> Reported Product
                            </label>
                            <div id="reported-product-info" class="product-card reported-product">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <!-- Evidence Images -->
                        <div id="evidence-images-container" style="margin-top: 1rem; display: none;">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: #059669;">
                                <i class="bi bi-camera-fill"></i> Evidence Images
                            </label>
                            <div id="evidence-images-list" class="evidence-gallery">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                        
                        <div id="order-products-container" style="margin-top: 1rem;">
                            <label style="font-weight: 600; margin-bottom: 0.5rem; display: block; color: #374151;">
                                <i class="bi bi-box-seam"></i> All Products in Order
                            </label>
                            <div id="order-products-list" class="products-list">
                                <!-- Content will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-col">
                    <div class="modal-section">
                        <h3>Actions</h3>
                        <div class="info-card" style="margin-bottom: 1rem;">
                            <label>Current Status</label>
                            <p>Assigned to: <strong id="modal-assigned-admin"></strong></p>
                            <div id="modal-current-status-badge"></div>
                        </div>

                        <div class="action-control" style="margin-bottom: 1rem;">
                            <select id="modal-status-select" class="form-control">
                                @foreach (var statusValue in Enum.GetValues(typeof(BusinessObject.Enums.ReportStatus)))
                                {
                                    // Lấy tên dạng chuỗi của Enum (ví dụ: "InProgress")
                                    var statusName = Enum.GetName(typeof(BusinessObject.Enums.ReportStatus), statusValue);

                                    // Dùng tên chuỗi này làm "value" cho option
                                    // và thay thế gạch dưới bằng khoảng trắng để hiển thị đẹp hơn
                                    <option value="@statusName">@statusName.Replace("_", " ")</option>
                                }
                            </select>
                            <button id="btn-update-status" class="btn-action btn-update-status">Update</button>
                        </div>
                        <div class="action-control" style="margin-bottom: 1rem;">
                            <select id="modal-admin-select" class="form-control">
                                <option value="">Select admin or staff...</option>
                                @foreach (var admin in Model.Admins)
                                {
                                    <option value="@admin.Id" data-role="@admin.Role">@admin.Email (@admin.Role)</option>
                                }
                            </select>
                            <button id="btn-assign-admin" class="btn-action btn-assign-admin">Assign</button>
                        </div>
                        <div>
                            <textarea id="modal-response-message" rows="4" placeholder="Write your response..."></textarea>
                            <div style="text-align: right; margin-top: 0.5rem;">
                                <button id="btn-send-response" class="btn-action btn-send-response"><i class="bi bi-send-fill"></i> Send & Update</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button id="modal-footer-close-btn" class="btn-close-modal">Close</button>
        </div>
    </div>
</div>

<!-- Image Modal for Evidence Photos -->
<div id="image-modal" class="image-modal">
    <button class="close-btn" onclick="closeImageModal()">&times;</button>
    <img id="modal-image" src="" alt="Evidence Image">
</div>

<!-- Evidence Carousel Modal -->
<div id="evidence-carousel-modal" class="evidence-carousel-modal" style="display: none;">
    <div class="carousel-container">
        <button class="carousel-nav prev" onclick="prevEvidenceImage()">
            <i class="bi bi-chevron-left"></i>
        </button>
        <img id="carousel-image" class="carousel-image" src="" alt="Evidence">
        <button class="carousel-nav next" onclick="nextEvidenceImage()">
            <i class="bi bi-chevron-right"></i>
        </button>
        <button class="carousel-close" onclick="closeEvidenceCarousel()">
            <i class="bi bi-x"></i>
        </button>
        <div class="carousel-counter">
            <span id="carousel-current">1</span> / <span id="carousel-total">1</span>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/dist/browser/signalr.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {

            // --- Globals and Constants ---
            const modal = document.getElementById('report-detail-modal');
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            let currentReport = null; // To store the data of the currently opened report
            
            // Check URL params for auto-opening detail modal
            const urlParams = new URLSearchParams(window.location.search);
            const reportIdParam = urlParams.get('reportId');
            const openDetail = urlParams.get('openDetail');
            
            if (reportIdParam && openDetail === 'true') {
                // Wait a bit for the page to fully render, then trigger the view details
                setTimeout(async function() {
                    const response = await fetch(`?handler=ReportDetails&id=${reportIdParam}`);
                    if (response.ok) {
                        try {
                            currentReport = await response.json();
                            populateModal(currentReport);
                            modal.classList.remove('hidden');
                            // Clean up URL without page reload
                            window.history.replaceState({}, document.title, window.location.pathname + '?tab=' + (urlParams.get('tab') || 'mytasks'));
                        } catch(err) {
                            console.error("Error loading report details:", err);
                        }
                    }
                }, 500);
            }

            const adminsList = @Json.Serialize(Model.Admins);
            // === SỬA LỖI Ở ĐÂY: Thêm lại logic SignalR đã bị thiếu ===
            const statusDiv = document.getElementById('realtime-status');
            const hubUrl = `@Model.ApiRootUrl/reportHub`;
            const accessToken = @Json.Serialize(Model.AccessToken);

            const connection = new signalR.HubConnectionBuilder()
                .withUrl(hubUrl, { accessTokenFactory: () => accessToken })
                .withAutomaticReconnect()
                .build();

            async function startSignalR() {
                try {
                    await connection.start();
                    statusDiv.classList.remove('status-disconnected');
                    statusDiv.classList.add('status-connected');
                    statusDiv.querySelector('span').textContent = 'Connected';
                } catch (err) {
                    console.error('SignalR Connection Error: ', err);
                    statusDiv.classList.remove('status-connected');
                    statusDiv.classList.add('status-disconnected');
                    statusDiv.querySelector('span').textContent = 'Disconnected';
                }
            }
            startSignalR(); // Bắt đầu kết nối


            // --- Function to populate Admin Dropdown ---
            function populateAdminDropdown() {
                const adminSelect = document.getElementById('modal-admin-select');
                // Xóa các option cũ (trừ option đầu tiên "Select admin or staff...")
                while (adminSelect.options.length > 1) {
                    adminSelect.remove(1);
                }
                // Thêm các admin/staff mới từ danh sách với role
                adminsList.forEach(admin => {
                    const option = document.createElement('option');
                    option.value = admin.id;
                    option.dataset.role = admin.role || 'admin';
                    // Hiển thị email và role
                    option.textContent = `${admin.email || 'No Email'} (${admin.role || 'admin'})`;
                    adminSelect.appendChild(option);
                });
            }
            

            // --- Function to show toast notifications ---
            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `notification-toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = 0;
                    setTimeout(() => toast.remove(), 500);
                }, 4000);
            }

            // --- Function to update a row in the main table ---
            function updateTableRow(reportData) {
                const row = document.querySelector(`tr[data-report-id='${reportData.id}']`);
                if (!row) return;

                const statusCell = row.querySelector('td:nth-child(4)');
                const statusString = reportData.status.toString();
                const statusIcon = getStatusIcon(statusString);

                statusCell.innerHTML = `
                    <span class="status-badge status-${statusString.toLowerCase()}">
                        <i class="${statusIcon}"></i>
                        <span>${statusString.replace(/_/g, " ")}</span>
                    </span>`;
            }

            // --- Function to map status string to icon class ---
            function getStatusIcon(status) {
                 switch(status) {
                    case 'open': return 'bi-clock';
                    case 'in_progress': return 'bi-arrow-repeat';
                    case 'resolved': return 'bi-check-circle-fill';
                    case 'awaiting_customer_response': return 'bi-person-vcard';
                    case 'ResolutionNote': return 'bi-journal-check';
                    default: return 'bi-question-circle';
                }
            }

            // --- Main update function via Fetch ---
            async function updateReportAction(action, data) {
                const response = await fetch('?handler=UpdateReportJson', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': token
                    },
                    body: JSON.stringify({ ...data, Action: action })
                });

                if (!response.ok) {
                    return showToast('An error occurred while updating.', 'error');
                }

                const result = await response.json();

                if (result.success) {
                    showToast(result.message, 'success');
                    currentReport = result.data;
                    populateModal(currentReport);
                    updateTableRow(currentReport);
                } else {
                    showToast(result.message, 'error');
                }
            }

            // --- Function to populate the modal with data ---
            function populateModal(report) {
                console.log("Data received in modal:", report);
                if (!report) {
                    console.error("populateModal was called with null or undefined report data.");
                    return;
                }
                // Helper: get property value using both camelCase and PascalCase fallback
                const getValue = (prop) => report[prop] ?? report[prop.charAt(0).toUpperCase() + prop.slice(1)] ?? 'N/A';

                // Sửa lỗi: Kiểm tra cả 'id' và 'Id' để đảm bảo an toàn
                const reportId = report.id || report.Id || '';
                const reportPriority = String(report.priority || report.Priority || '').toLowerCase();

                // Header
                document.getElementById('modal-report-id-display').textContent = reportId.substring(0, 8);
                const priorityDot = document.getElementById('modal-priority-dot');
                priorityDot.className = 'priority-dot'; // Reset
                if (reportPriority === 'critical') priorityDot.classList.add('priority-critical');
                else if (reportPriority === 'high') priorityDot.classList.add('priority-high');
                else if (reportPriority === 'medium') priorityDot.classList.add('priority-medium');
                else priorityDot.classList.add('priority-low');

                        // Left Column
                document.getElementById('modal-subject').textContent = getValue('subject');
                document.getElementById('modal-description').textContent = getValue('description');
                document.getElementById('modal-priority').textContent = getValue('priority');

                const dateCreated = report.dateCreated ?? report.DateCreated;
                document.getElementById('modal-date').textContent = dateCreated ? new Date(dateCreated).toLocaleString() : 'N/A';

                document.getElementById('modal-reporter-name').textContent = getValue('reporterName');
                document.getElementById('modal-reporter-email').textContent = getValue('reporterEmail');
                document.getElementById('modal-reportee-name').textContent = getValue('reporteeName');
                document.getElementById('modal-reportee-email').textContent = getValue('reporteeEmail');

                // Store ids for messaging
                const reporterId = report.reporterId ?? report.ReporterId ?? null;
                const reporteeId = report.reporteeId ?? report.ReporteeId ?? null;
                const btnReporter = document.getElementById('btn-message-reporter');
                const btnReportee = document.getElementById('btn-message-reportee');
                btnReporter.dataset.userId = reporterId || '';
                btnReportee.dataset.userId = reporteeId || '';

                // Right Column
                document.getElementById('modal-assigned-admin').textContent = getValue('assignedAdminName') || 'Not Assigned';
                document.getElementById('modal-status-select').value = report.status ?? 'open';
                document.getElementById('modal-admin-select').value = report.assignedAdminId ?? '';
                document.getElementById('modal-response-message').value = '';

                const statusBadge = document.getElementById('modal-current-status-badge');
                const statusString = String(getValue('status'));
                statusBadge.innerHTML = `
                    <span class="status-badge status-${statusString.toLowerCase()}">
                        <i class="${getStatusIcon(statusString)}"></i>
                        <span>${statusString.replace(/_/g, " ")}</span>
                    </span>`;

                populateAdminDropdown();
                            const statusValue = getValue('status');
                document.getElementById('modal-status-select').value = statusValue;
                const adminSelect = document.getElementById('modal-admin-select');
                adminSelect.value = report.assignedAdminId ?? '';

                // Order Information (for OrderItem reports)
                const reportType = report.reportType ?? report.ReportType;
                const orderInfoSection = document.getElementById('order-info-section');
                const modalGrid = document.querySelector('.modal-grid');
                
                console.log('Report Type:', reportType);
                console.log('Full Report Data:', report);
                console.log('Order ID:', report.orderId ?? report.OrderId);
                console.log('Order Code:', report.orderCode ?? report.OrderCode);
                
                // Check if report is order-related (handle both string and number formats)
                const isOrderItem = reportType === 'OrderItem' || 
                                   reportType === 1 || 
                                   reportType?.toLowerCase() === 'orderitem' ||
                                   (report.orderItemId ?? report.OrderItemId) != null;
                
                // Toggle modal layout based on Order Information presence
                if (isOrderItem) {
                    modalGrid.classList.add('has-order-info');
                    // Move Order Information to right column (above Actions)
                    const orderInfoSection = document.getElementById('order-info-section');
                    const rightColumn = document.querySelector('.modal-col:last-child');
                    const actionsSection = rightColumn.querySelector('.modal-section');
                    rightColumn.insertBefore(orderInfoSection, actionsSection);
                } else {
                    modalGrid.classList.remove('has-order-info');
                    // Move Order Information back to left column if needed
                    const orderInfoSection = document.getElementById('order-info-section');
                    const leftColumn = document.querySelector('.modal-col:first-child');
                    leftColumn.appendChild(orderInfoSection);
                }
                
                if (isOrderItem) {
                    console.log('Showing order info section');
                    orderInfoSection.style.display = 'block';
                    document.getElementById('modal-order-code').textContent = getValue('orderCode') || 'N/A';
                    document.getElementById('modal-report-type').textContent = 'Order Item Report';
                    
                    // Display reported product (specific product being reported)
                    const reportedProduct = report.reportedProduct ?? report.ReportedProduct;
                    const reportedProductContainer = document.getElementById('reported-product-container');
                    const reportedProductInfo = document.getElementById('reported-product-info');
                    
                    if (reportedProduct) {
                        reportedProductContainer.style.display = 'block';
                        
                        // Determine rental type and details
                        console.log('Reported Product Data:', reportedProduct);
                        const transactionType = reportedProduct.transactionType || reportedProduct.TransactionType;
                        const rentalDays = reportedProduct.rentalDays || reportedProduct.RentalDays;
                        const isRental = transactionType === 0 || transactionType === 'rental' || transactionType === 'Rental'; // 0 = rental enum value
                        const rentalInfo = isRental 
                            ? `<span><i class="bi bi-calendar-check"></i> Rental: ${rentalDays || 1} days</span>`
                            : `<span><i class="bi bi-cart-check"></i> Purchase</span>`;
                        
                        const depositPerUnit = reportedProduct.depositAmount || reportedProduct.DepositAmount || 0;
                        const quantity = reportedProduct.quantity || reportedProduct.Quantity || 1;
                        const totalDeposit = depositPerUnit * quantity;
                        const depositInfo = totalDeposit > 0
                            ? `<span><i class="bi bi-shield-check"></i> Deposit: ${totalDeposit.toLocaleString('vi-VN')} VND</span>`
                            : '';
                        
                        const totalAmount = isRental 
                            ? (reportedProduct.price || reportedProduct.Price) * (rentalDays || 1) * quantity
                            : (reportedProduct.price || reportedProduct.Price) * quantity;
                        
                        reportedProductInfo.innerHTML = `
                            <img src="${reportedProduct.primaryImageUrl || reportedProduct.PrimaryImageUrl || '/images/placeholder.png'}" 
                                 alt="${reportedProduct.productName || reportedProduct.ProductName}" 
                                 class="product-image">
                            <div class="product-details">
                                <h4 class="product-name">${reportedProduct.productName || reportedProduct.ProductName}</h4>
                                <div class="product-meta">
                                    <span><i class="bi bi-box"></i> Qty: ${reportedProduct.quantity || reportedProduct.Quantity}</span>
                                    ${rentalInfo}
                                    ${depositInfo}
                                </div>
                                <div class="product-price">Subtotal: ${totalAmount.toLocaleString('vi-VN')} VND</div>
                            </div>
                        `;
                    } else {
                        reportedProductContainer.style.display = 'none';
                    }
                    
                    // Display evidence images
                    const evidenceImages = report.evidenceImages ?? report.EvidenceImages ?? [];
                    const evidenceContainer = document.getElementById('evidence-images-container');
                    const evidenceList = document.getElementById('evidence-images-list');
                    
                    if (evidenceImages && evidenceImages.length > 0) {
                        evidenceContainer.style.display = 'block';
                        
                        if (evidenceImages.length === 1) {
                            // Single image - show normally
                            evidenceList.innerHTML = `
                                <div class="evidence-item single-evidence" onclick="openEvidenceCarousel(${JSON.stringify(evidenceImages).replace(/"/g, '&quot;')}, 0)">
                                    <img src="${evidenceImages[0]}" alt="Evidence">
                                    <div class="overlay">
                                        <i class="bi bi-zoom-in"></i>
                                    </div>
                                </div>
                            `;
                        } else {
                            // Multiple images - show first image with counter
                            evidenceList.innerHTML = `
                                <div class="evidence-item multiple-evidence" onclick="openEvidenceCarousel(${JSON.stringify(evidenceImages).replace(/"/g, '&quot;')}, 0)">
                                    <img src="${evidenceImages[0]}" alt="Evidence 1">
                                    <div class="overlay">
                                        <i class="bi bi-images"></i>
                                        <span class="evidence-counter">+${evidenceImages.length - 1}</span>
                                    </div>
                                </div>
                            `;
                        }
                    } else {
                        evidenceContainer.style.display = 'none';
                    }
                    
                    // Display all products in order
                    const orderProducts = report.orderProducts ?? report.OrderProducts ?? [];
                    console.log('Order Products:', orderProducts);
                    const productsListDiv = document.getElementById('order-products-list');
                    
                    if (orderProducts && orderProducts.length > 0) {
                        productsListDiv.innerHTML = orderProducts.map(product => `
                            <div class="product-card normal clickable" onclick="window.open('/Products/Detail/${product.productId || product.ProductId}', '_blank')" style="cursor: pointer;">
                                <img src="${product.primaryImageUrl || product.PrimaryImageUrl || '/images/placeholder.png'}" 
                                     alt="${product.productName || product.ProductName}" 
                                     class="product-image">
                                <div class="product-details">
                                    <h4 class="product-name">${product.productName || product.ProductName}</h4>
                                    <div class="product-meta">
                                        <span><i class="bi bi-tag"></i> ID: ${(product.productId || product.ProductId || '').toString().substring(0, 8)}</span>
                                        <span><i class="bi bi-arrow-up-right-square"></i> Click to view details</span>
                                    </div>
                                </div>
                            </div>
                        `).join('');
                    } else {
                        productsListDiv.innerHTML = '<p style="color: #6b7280; font-style: italic; text-align: center; padding: 2rem;">No products found in this order</p>';
                    }
                } else {
                    orderInfoSection.style.display = 'none';
                    // Ẩn các container con khi không phải OrderItem report
                    document.getElementById('reported-product-container').style.display = 'none';
                    document.getElementById('evidence-images-container').style.display = 'none';
                }

            }

            // --- Event Listeners ---
            document.querySelectorAll('.btn-view-details').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const reportId = e.currentTarget.dataset.reportId;
                    const response = await fetch(`?handler=ReportDetails&id=${reportId}`);
                    if (!response.ok) { return showToast('Could not load report details.', 'error'); }

                    try {
                        currentReport = await response.json();
                        populateModal(currentReport);
                        modal.classList.remove('hidden');
                    } catch(err) {
                        console.error("Error parsing report details JSON:", err);
                        showToast("Error processing server response.", 'error');
                    }
                });
            });
            // Open floating chat to start conversation with a user
            function openFloatingChatWith(userId, userName) {
                if (!userId) return;
                
                // Check if openFloatingChat function exists (from floating-chat-manager.js)
                if (typeof window.openFloatingChat === 'function') {
                    // Open floating chat with the specific user
                    window.openFloatingChat(userId, userName || 'User', null);
                } else if (typeof window.FloatingChatManager !== 'undefined' && typeof window.FloatingChatManager.openChatWith === 'function') {
                    // Fallback to static method
                    window.FloatingChatManager.openChatWith(userId, userName || 'User', null);
                } else {
                    console.error('FloatingChatManager not found. Make sure floating-chat-manager.js is loaded.');
                    showToast('Chat feature is not available at the moment.', 'error');
                }
            }

            document.addEventListener('click', (e) => {
                if (e.target && e.target.id === 'btn-message-reporter') {
                    const id = e.target.dataset.userId;
                    const name = document.getElementById('modal-reporter-name')?.textContent || 'Reporter';
                    openFloatingChatWith(id, name);
                }
                if (e.target && e.target.id === 'btn-message-reportee') {
                    const id = e.target.dataset.userId;
                    const name = document.getElementById('modal-reportee-name')?.textContent || 'Reportee';
                    openFloatingChatWith(id, name);
                }
            });

            document.getElementById('modal-close-btn').addEventListener('click', () => modal.classList.add('hidden'));
            document.getElementById('modal-footer-close-btn').addEventListener('click', () => modal.classList.add('hidden'));
            modal.addEventListener('click', (e) => { if (e.target === modal) modal.classList.add('hidden'); });

            document.getElementById('btn-update-status').addEventListener('click', () => {
                const newStatus = document.getElementById('modal-status-select').value;
                updateReportAction('updateStatus', { reportId: (currentReport.id || currentReport.Id), newStatus: newStatus });
            });

            document.getElementById('btn-assign-admin').addEventListener('click', () => {
                const newAdminId = document.getElementById('modal-admin-select').value;
                if (!newAdminId) return showToast('Please select an admin or staff member.', 'warning');
                updateReportAction('assign', { reportId: (currentReport.id || currentReport.Id), newAdminId: newAdminId });
            });

            document.getElementById('btn-send-response').addEventListener('click', () => {
                const responseMessage = document.getElementById('modal-response-message').value;
                const newStatus = document.getElementById('modal-status-select').value;
                if (!responseMessage.trim()) return showToast('Response message cannot be empty.', 'warning');
                updateReportAction('respond', { reportId: (currentReport.id || currentReport.Id), responseMessage: responseMessage, newStatus: newStatus });
            });

            // --- Helper Functions outside DOMContentLoaded ---
            function showToast(message, type = 'success') {
                const toast = document.createElement('div');
                toast.className = `notification-toast ${type}`;
                toast.textContent = message;
                document.body.appendChild(toast);
                setTimeout(() => {
                    toast.style.opacity = 0;
                    setTimeout(() => toast.remove(), 500);
                }, 4000);
            }

            function updateTableRow(reportData) {
                const reportId = reportData.id || reportData.Id;
                const row = document.querySelector(`tr[data-report-id='${reportId}']`);
                if (!row) return;

                const statusCell = row.querySelector('td:nth-child(4)');
                const statusString = reportData.status.toString();
                const statusIcon = getStatusIcon(statusString);

                statusCell.innerHTML = `
                    <span class="status-badge status-${statusString.toLowerCase()}">
                        <i class="${statusIcon}"></i>
                        <span>${statusString.replace(/_/g, " ")}</span>
                    </span>`;
            }

            function getStatusIcon(status) {
                 switch(status) {
                    case 'open': return 'bi-clock';
                    case 'in_progress': return 'bi-arrow-repeat';
                    case 'resolved': return 'bi-check-circle-fill';
                    case 'awaiting_customer_response': return 'bi-person-vcard';
                    case 'ResolutionNote': return 'bi-journal-check';
                    default: return 'bi-question-circle';
                }
            }
            
            // Image Modal Functions
            window.openImageModal = function(imageUrl) {
                const modal = document.getElementById('image-modal');
                const modalImage = document.getElementById('modal-image');
                modalImage.src = imageUrl;
                modal.classList.add('show');
                
                // Close on click outside image
                modal.onclick = function(e) {
                    if (e.target === modal) {
                        closeImageModal();
                    }
                };
                
                // Close on Escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape') {
                        closeImageModal();
                    }
                });
            };
            
            window.closeImageModal = function() {
                const modal = document.getElementById('image-modal');
                modal.classList.remove('show');
                document.getElementById('modal-image').src = '';
            };
            
            // Evidence Carousel Functions
            let currentEvidenceImages = [];
            let currentEvidenceIndex = 0;
            
            window.openEvidenceCarousel = function(images, startIndex = 0) {
                currentEvidenceImages = images;
                currentEvidenceIndex = startIndex;
                
                const modal = document.getElementById('evidence-carousel-modal');
                const carouselImage = document.getElementById('carousel-image');
                const currentSpan = document.getElementById('carousel-current');
                const totalSpan = document.getElementById('carousel-total');
                
                // Update image and counter
                carouselImage.src = currentEvidenceImages[currentEvidenceIndex];
                currentSpan.textContent = currentEvidenceIndex + 1;
                totalSpan.textContent = currentEvidenceImages.length;
                
                // Show/hide navigation buttons
                const prevBtn = document.querySelector('.carousel-nav.prev');
                const nextBtn = document.querySelector('.carousel-nav.next');
                
                if (currentEvidenceImages.length <= 1) {
                    prevBtn.style.display = 'none';
                    nextBtn.style.display = 'none';
                } else {
                    prevBtn.style.display = 'block';
                    nextBtn.style.display = 'block';
                }
                
                modal.style.display = 'flex';
            };
            
            window.closeEvidenceCarousel = function() {
                const modal = document.getElementById('evidence-carousel-modal');
                modal.style.display = 'none';
                currentEvidenceImages = [];
                currentEvidenceIndex = 0;
            };
            
            window.nextEvidenceImage = function() {
                if (currentEvidenceIndex < currentEvidenceImages.length - 1) {
                    currentEvidenceIndex++;
                } else {
                    currentEvidenceIndex = 0; // Loop to first image
                }
                updateCarouselImage();
            };
            
            window.prevEvidenceImage = function() {
                if (currentEvidenceIndex > 0) {
                    currentEvidenceIndex--;
                } else {
                    currentEvidenceIndex = currentEvidenceImages.length - 1; // Loop to last image
                }
                updateCarouselImage();
            };
            
            function updateCarouselImage() {
                const carouselImage = document.getElementById('carousel-image');
                const currentSpan = document.getElementById('carousel-current');
                
                carouselImage.src = currentEvidenceImages[currentEvidenceIndex];
                currentSpan.textContent = currentEvidenceIndex + 1;
            }
            
            // Keyboard navigation for carousel
            document.addEventListener('keydown', function(e) {
                const modal = document.getElementById('evidence-carousel-modal');
                if (modal.style.display === 'flex') {
                    if (e.key === 'ArrowLeft') {
                        prevEvidenceImage();
                    } else if (e.key === 'ArrowRight') {
                        nextEvidenceImage();
                    } else if (e.key === 'Escape') {
                        closeEvidenceCarousel();
                    }
                }
            });
        });
    </script>
}