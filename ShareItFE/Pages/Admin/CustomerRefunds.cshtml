@page
@model ShareItFE.Pages.Admin.CustomerRefundsModel
@{
    ViewData["Title"] = "Customer Refunds";
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
}

<link rel="stylesheet" href="~/css/customer-refunds.css" asp-append-version="true" />

<!-- CSRF Token -->
<form method="post">
    @Html.AntiForgeryToken()
</form>

<div class="refunds-container">
    <!-- Header -->
    <div class="refunds-header">
        <div class="header-left">
            <i class="fas fa-hand-holding-usd header-icon"></i>
            <h1 class="refunds-title">Customer <span class="highlight">Deposit Refunds</span></h1>
            <span class="pending-badge" id="header-pending-badge" style="display: none;">
                <span id="header-pending-count">0</span> Pending
            </span>
        </div>
    </div>


    <!-- Search and Filter -->
    <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
        <div class="flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="relative w-full md:flex-grow">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <i class="fas fa-search text-gray-400"></i>
                </div>
                <input type="text" id="searchInput" 
                       placeholder="Search by Order Code, Customer Name/Email..." 
                       class="w-full pl-10 pr-10 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all" />
                <button type="button" id="clear-search" class="absolute inset-y-0 right-0 pr-3 flex items-center hidden">
                    <i class="fas fa-times text-gray-400 hover:text-gray-600 cursor-pointer"></i>
                </button>
            </div>

            <div class="flex items-center gap-2 sm:gap-3 w-full md:w-auto">
                <button type="button" id="filterBtn" class="flex items-center gap-2 px-4 py-2.5 border border-gray-300 rounded-lg bg-white text-gray-700 hover:bg-gray-50 transition-colors w-full justify-center sm:w-auto">
                    <i class="fas fa-sliders-h"></i>
                    <span>Filters</span>
                </button>

                <button type="button" id="reset-filters" class="flex items-center gap-2 px-4 py-2.5 border border-gray-300 rounded-lg bg-white text-gray-700 hover:bg-gray-50 transition-colors">
                    <i class="fas fa-redo"></i>
                    <span class="hidden sm:inline">Reset</span>
                </button>
            </div>
        </div>

        <!-- Filter Panel -->
        <div id="filterPanel" class="hidden pt-6 border-t border-gray-200 mt-6">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div>
                    <label for="statusSelect" class="block text-sm font-medium text-gray-700 mb-1.5">Status</label>
                    <select id="statusSelect" class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all">
                        <option value="">All Statuses</option>
                        <option value="initiated">Initiated</option>
                        <option value="completed">Completed</option>
                        <option value="failed">Failed</option>
                    </select>
                </div>
            </div>
        </div>
    </div>

    <!-- Results Info -->
    <div class="bg-white p-4 rounded-lg shadow-sm mb-4">
        <p id="results-info" class="text-sm text-gray-600 mb-0">Loading...</p>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs refunds-tabs" id="refundsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="pending-tab" data-bs-toggle="tab" data-bs-target="#pending" type="button" role="tab">
                <i class="fas fa-clock"></i> Pending Requests
                <span class="tab-count" id="pending-count-badge">0</span>
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="processed-tab" data-bs-toggle="tab" data-bs-target="#processed" type="button" role="tab">
                <i class="fas fa-history"></i> History
                <span class="tab-count" id="processed-count-badge">0</span>
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content" id="refundsTabContent">
        <!-- Pending Tab -->
        <div class="tab-pane fade show active" id="pending" role="tabpanel">
            <div class="table-responsive">
                <table class="refunds-table">
                    <thead>
                        <tr>
                            <th>REQUEST DATE</th>
                            <th>CUSTOMER NAME</th>
                            <th>ORDER CODE</th>
                            <th>AMOUNT</th>
                            <th>PAYMENT METHOD</th>
                            <th>STATUS</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="pending-tbody">
                        <tr>
                            <td colspan="7" class="text-center py-12">
                                <i class="fas fa-spinner fa-spin fa-2x text-gray-400 mb-3"></i>
                                <p class="text-gray-500">Loading refund requests...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- History Tab -->
        <div class="tab-pane fade" id="processed" role="tabpanel">
            <div class="table-responsive">
                <table class="refunds-table">
                    <thead>
                        <tr>
                            <th>REQUEST DATE</th>
                            <th>CUSTOMER NAME</th>
                            <th>ORDER CODE</th>
                            <th>AMOUNT</th>
                            <th>STATUS</th>
                            <th>PROCESSED DATE</th>
                            <th>ACTIONS</th>
                        </tr>
                    </thead>
                    <tbody id="processed-tbody">
                        <tr>
                            <td colspan="7" class="text-center py-12">
                                <i class="fas fa-spinner fa-spin fa-2x text-gray-400 mb-3"></i>
                                <p class="text-gray-500">Loading refund history...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Pagination -->
    <div class="mt-4">
        <div id="pagination-container" class="pagination-controls"></div>
    </div>
</div>

<!-- Refund Detail Modal -->
<div class="modal fade" id="refundDetailModal" tabindex="-1" aria-labelledby="refundDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="refundDetailModalLabel">
                    <i class="fas fa-receipt"></i> Deposit Refund Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Request Information -->
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Refund Code</label>
                        <p class="fw-bold" id="modalRefundCode">-</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Request Date</label>
                        <p id="modalRequestDate">-</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Customer Name</label>
                        <p class="fw-semibold" id="modalCustomerName">-</p>
                        <p class="text-muted small" id="modalCustomerEmail">-</p>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label text-muted small">Order Code</label>
                        <p class="order-code" id="modalOrderCode">-</p>
                    </div>
                </div>

                <!-- Amount Details -->
                <div class="bg-light rounded p-3 mb-4">
                    <h6 class="fw-bold mb-3"><i class="fas fa-money-bill-wave text-success"></i> Amount Breakdown</h6>
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label text-muted small">Original Deposit</label>
                            <p class="fs-5 fw-bold text-primary" id="modalOriginalDeposit">0 ₫</p>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small">Total Penalty</label>
                            <p class="fs-5 fw-bold text-danger" id="modalPenaltyAmount">0 ₫</p>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-muted small">Refund Amount</label>
                            <p class="fs-4 fw-bold text-success" id="modalRefundAmount">0 ₫</p>
                        </div>
                    </div>
                </div>

                <!-- Bank Transfer Information (Payment Details) -->
                <div class="bg-white rounded border border-primary p-4 mb-4">
                    <div class="d-flex align-items-center mb-3">
                        <i class="fas fa-credit-card text-primary fs-4 me-2"></i>
                        <h6 class="fw-bold mb-0">Bank Transfer Information</h6>
                    </div>
                    <div id="bankDetailsSection">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label text-muted small fw-semibold">Bank Name:</label>
                                <p class="mb-0 fs-6" id="modalBankName">-</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small fw-semibold">Account Holder:</label>
                                <p class="mb-0 fs-6" id="modalAccountHolder">-</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small fw-semibold">Account Number:</label>
                                <p class="mb-0 fs-5 fw-bold text-primary font-monospace" id="modalAccountNumber">-</p>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label text-muted small fw-semibold">Routing Number:</label>
                                <p class="mb-0 fs-6 font-monospace" id="modalRoutingNumber">-</p>
                            </div>
                        </div>
                    </div>
                    <div id="noBankInfo" class="d-none">
                        <div class="alert alert-warning mb-0 d-flex align-items-start">
                            <i class="fas fa-exclamation-triangle me-2 mt-1"></i>
                            <small>Customer has not registered any bank account. Please contact the customer to provide bank account information before processing this refund.</small>
                        </div>
                    </div>
                </div>

                <!-- Notes -->
                <div class="mb-4">
                    <label class="form-label fw-bold">Notes</label>
                    <p class="bg-info bg-opacity-10 border border-info rounded p-3" id="modalNotes">-</p>
                </div>

                <!-- Admin Action Section (Only for Pending) -->
                <div id="adminActionSection" class="d-none">
                    <hr class="my-4" />
                    <h6 class="fw-bold mb-3"><i class="fas fa-tasks me-2"></i>Processing Actions</h6>
                    <div class="mb-3">
                        <label for="adminNotesInput" class="form-label fw-semibold">Admin Notes</label>
                        <textarea class="form-control" id="adminNotesInput" rows="3" placeholder="Add processing notes (optional for approval, required for rejection)"></textarea>
                        <small class="text-muted">For approval: Note that refund has been transferred. For rejection: Explain the reason.</small>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div>
                        <span class="text-muted small me-2">Status:</span>
                        <span id="modalStatus" class="status-badge">-</span>
                    </div>
                    <div>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <div id="modalActionButtons" class="d-none d-inline">
                            <button type="button" class="btn btn-outline-danger ms-2" onclick="rejectRefund()">
                                <i class="fas fa-times-circle"></i> Reject Request
                            </button>
                            <button type="button" class="btn btn-success ms-2" onclick="approveRefund()">
                                <i class="fas fa-check-circle"></i> Confirm & Mark as Paid
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <script>
        const apiBaseUrl = '@Model.ApiBaseUrl';
        const accessToken = '@Request.Cookies["AccessToken"]';
    </script>
    <script src="~/js/customer-refunds.js" asp-append-version="true"></script>
}
