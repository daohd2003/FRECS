@page
@model ShareItFE.Pages.Admin.PolicyManagementModel
@{
    ViewData["Title"] = "Policy Rule Management";
    Layout = "_AdminLayout";
}

@section Styles {
    <style>
        .policy-management-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        .page-header { margin-bottom: 2rem; }
        .page-title { font-size: 2rem; font-weight: 700; color: #1a202c; margin-bottom: 0.5rem; }
        .page-subtitle { color: #718096; font-size: 1rem; }
        .alert { padding: 1rem; border-radius: 0.5rem; margin-bottom: 1.5rem; }
        .alert-success { background-color: #c6f6d5; border: 1px solid #9ae6b4; color: #22543d; }
        .alert-error { background-color: #fed7d7; border: 1px solid #fc8181; color: #742a2a; }
        .policy-card { background: white; border-radius: 1rem; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1); padding: 2rem; }
        .form-group { margin-bottom: 1.5rem; }
        .form-label { display: block; font-size: 1rem; font-weight: 600; color: #2d3748; margin-bottom: 0.5rem; }
        .form-select, .form-input { width: 100%; padding: 0.75rem 1rem; border: 1px solid #e2e8f0; border-radius: 0.5rem; font-size: 0.875rem; background-color: white; transition: all 0.2s; }
        .form-select:focus, .form-input:focus { outline: none; border-color: #7c3aed; box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1); }
        .form-select option { font-size: 0.875rem !important; font-weight: normal !important; font-family: inherit !important; }
        .form-select option * { font-size: 0.875rem !important; font-weight: normal !important; }
        .editor-hint { font-size: 0.75rem; color: #718096; margin-top: 0.5rem; }
        .checkbox-group { display: flex; align-items: center; gap: 0.75rem; }
        .checkbox-input { width: 1.25rem; height: 1.25rem; cursor: pointer; }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; font-size: 0.875rem; cursor: pointer; transition: all 0.2s; border: none; display: inline-flex; align-items: center; gap: 0.5rem; }
        .btn-primary { background: #7c3aed; color: white; }
        .btn-primary:hover { background: #6d28d9; }
        .btn-secondary { background: #e2e8f0; color: #2d3748; }
        .btn-secondary:hover { background: #cbd5e0; }
        .btn-danger { background: #ef4444; color: white; }
        .btn-danger:hover { background: #dc2626; }
        .btn-danger:disabled { background: #fca5a5; cursor: not-allowed; opacity: 0.6; }
        .form-actions { display: flex; gap: 1rem; margin-top: 2rem; }
        .tox-tinymce { border: 1px solid #e2e8f0 !important; border-radius: 0.5rem !important; }
    </style>
}

<div class="policy-management-container">
    <div class="page-header">
        <h1 class="page-title">Policy Rule Management</h1>
        <p class="page-subtitle">Edit and update platform policies and legal documents</p>
    </div>

    <!-- Alert Container for AJAX messages -->
    <div id="alertContainer"></div>

    <div class="policy-card">
        <form method="post" asp-page-handler="Save" id="policyForm" onsubmit="return handleFormSubmit(event)">
            <div class="form-group">
                <label class="form-label">Select Policy to Edit</label>
                <select class="form-select" asp-for="SelectedPolicyId" id="policySelector" onchange="loadPolicyData()">
                    <option value="new">-- Create New Policy --</option>
                    @foreach (var policy in Model.Policies)
                    {
                        <option value="@policy.Id" 
                                data-name="@policy.PolicyName" 
                                data-content="@System.Web.HttpUtility.HtmlEncode(policy.Content)" 
                                data-active="@policy.IsActive.ToString().ToLower()">
                            @policy.PolicyName @(policy.IsActive ? "" : "(Inactive)")
                        </option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Policy Name</label>
                <input type="text" class="form-input" asp-for="PolicyName" id="policyName" placeholder="Enter policy name" required />
            </div>

            <div class="form-group">
                <label class="form-label">Policy Content</label>
                <!-- TinyMCE Editor -->
                <textarea asp-for="PolicyContent" id="policyContent"></textarea>
                <p class="editor-hint">Full-featured editor with advanced formatting options, tables, media, and more.</p>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" class="checkbox-input" asp-for="IsActive" id="isActive" />
                    <label class="form-label" for="isActive" style="margin-bottom: 0;">Active (visible to users)</label>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save Policy
                </button>
                <button type="button" class="btn btn-danger" id="deleteBtn" onclick="deletePolicy()" disabled>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="3 6 5 6 21 6"></polyline>
                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                        <line x1="10" y1="11" x2="10" y2="17"></line>
                        <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                    Delete Policy
                </button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <!-- TinyMCE Configuration -->
    <script>
        // ============================================
        // TinyMCE API Key Configuration
        // Change this value if you need to update the API key
        // ============================================
        const TINYMCE_API_KEY = 'jegcrh9wlz6y0amfpc51xftk0kqhhyqk2y2g1ljhqhgf3m1r';
    </script>
    
    <!-- TinyMCE CDN -->
    <script>
        // Dynamically load TinyMCE with the configured API key
        (function() {
            const script = document.createElement('script');
            script.src = `https://cdn.tiny.cloud/1/${TINYMCE_API_KEY}/tinymce/6/tinymce.min.js`;
            script.referrerPolicy = 'origin';
            script.onload = function() {
                initializeTinyMCE();
            };
            document.head.appendChild(script);
        })();
        
        let editorInstance = null;
        
        function initializeTinyMCE() {
            tinymce.init({
            selector: '#policyContent',
            height: 600,
            menubar: 'file edit view insert format tools table help',
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'code', 'help', 'wordcount',
                'emoticons', 'template', 'codesample', 'directionality', 'visualchars',
                'nonbreaking', 'pagebreak', 'quickbars', 'save'
            ],
            toolbar: [
                'undo redo | styleselect | bold italic underline strikethrough | forecolor backcolor',
                'fontfamily fontsize | alignleft aligncenter alignright alignjustify',
                'bullist numlist outdent indent | link image media table | removeformat code fullscreen'
            ],
            toolbar_mode: 'sliding',
            inline_styles: true,
            // Custom style formats - Word-like behavior (inline styles)
            style_formats: [
                { title: 'Normal', inline: 'span', styles: { 'font-size': '14px', 'font-weight': 'normal' } },
                { title: 'Heading 1', inline: 'span', styles: { 'font-size': '32px', 'font-weight': 'bold' } },
                { title: 'Heading 2', inline: 'span', styles: { 'font-size': '24px', 'font-weight': 'bold' } },
                { title: 'Heading 3', inline: 'span', styles: { 'font-size': '18px', 'font-weight': 'bold' } },
                { title: 'Heading 4', inline: 'span', styles: { 'font-size': '16px', 'font-weight': 'bold' } },
                { title: 'Heading 5', inline: 'span', styles: { 'font-size': '14px', 'font-weight': 'bold' } },
                { title: 'Heading 6', inline: 'span', styles: { 'font-size': '12px', 'font-weight': 'bold' } }
            ],
            formats: {
                // Override default formats to use inline styles ONLY for selection
                bold: { inline: 'strong' },
                italic: { inline: 'em' },
                underline: { inline: 'u' },
                strikethrough: { inline: 'strike' },
                // Force font family and size to be inline span with style
                fontname: { inline: 'span', styles: { 'font-family': '%value' } },
                fontsize: { inline: 'span', styles: { 'font-size': '%value' } },
                forecolor: { inline: 'span', styles: { 'color': '%value' } },
                hilitecolor: { inline: 'span', styles: { 'background-color': '%value' } },
                // Custom inline heading formats
                heading1style: { inline: 'span', styles: { 'font-size': '32px', 'font-weight': 'bold' } },
                heading2style: { inline: 'span', styles: { 'font-size': '24px', 'font-weight': 'bold' } },
                heading3style: { inline: 'span', styles: { 'font-size': '18px', 'font-weight': 'bold' } },
                heading4style: { inline: 'span', styles: { 'font-size': '16px', 'font-weight': 'bold' } },
                heading5style: { inline: 'span', styles: { 'font-size': '14px', 'font-weight': 'bold' } },
                heading6style: { inline: 'span', styles: { 'font-size': '12px', 'font-weight': 'bold' } }
            },
            font_family_formats: 'Arial=arial,helvetica,sans-serif; ' +
                                'Arial Black=arial black,avant garde; ' +
                                'Book Antiqua=book antiqua,palatino; ' +
                                'Comic Sans MS=comic sans ms,sans-serif; ' +
                                'Courier New=courier new,courier; ' +
                                'Georgia=georgia,palatino; ' +
                                'Helvetica=helvetica; ' +
                                'Impact=impact,chicago; ' +
                                'Symbol=symbol; ' +
                                'Tahoma=tahoma,arial,helvetica,sans-serif; ' +
                                'Terminal=terminal,monaco; ' +
                                'Times New Roman=times new roman,times; ' +
                                'Trebuchet MS=trebuchet ms,geneva; ' +
                                'Verdana=verdana,geneva; ' +
                                'Webdings=webdings; ' +
                                'Wingdings=wingdings,zapf dingbats',
            font_size_formats: '8pt 9pt 10pt 11pt 12pt 14pt 16pt 18pt 20pt 24pt 28pt 32pt 36pt 48pt 72pt',
            font_size_input_default_unit: 'pt',
            // Remove block_formats to prevent block-level heading conversion
            style_formats_merge: false,
            // Apply formatting to selection only
            apply_source_formatting: false,
            forced_root_block: 'p',
            forced_root_block_attrs: {
                'style': 'margin: 0;'
            },
            // Prevent block-level formatting for inline styles
            valid_children: '+body[style],+p[span|strong|em|u|strike|a|br]',
            extended_valid_elements: 'span[style|class]',
            // Only apply to selected text, not entire blocks
            inline_boundaries_selector: 'a[href],code,span,strong,em,u,strike',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-size: 14px; line-height: 1.6; } p { margin: 0 0 1em 0; }',
            quickbars_selection_toolbar: 'styleselect | bold italic underline | forecolor backcolor | fontfamily fontsize',
            quickbars_insert_toolbar: 'quickimage quicktable',
            contextmenu: 'link image table',
            image_advtab: true,
            image_caption: true,
            image_title: true,
            automatic_uploads: false,
            file_picker_types: 'image',
            templates: [
                { title: 'Policy Section', description: 'Standard policy section', content: '<h2>Section Title</h2><p>Section content goes here...</p>' },
                { title: 'Numbered List', description: 'Numbered list template', content: '<ol><li>First item</li><li>Second item</li><li>Third item</li></ol>' },
                { title: 'Important Notice', description: 'Highlighted notice box', content: '<div style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0;"><strong>Important:</strong> Notice content here</div>' }
            ],
            setup: function(editor) {
                // Add custom menu items for inline heading styles
                editor.ui.registry.addNestedMenuItem('heading1', {
                    text: 'Heading 1',
                    onAction: function() {
                        editor.formatter.apply('heading1style');
                    }
                });
                
                editor.ui.registry.addNestedMenuItem('heading2', {
                    text: 'Heading 2',
                    onAction: function() {
                        editor.formatter.apply('heading2style');
                    }
                });
                
                editor.ui.registry.addNestedMenuItem('heading3', {
                    text: 'Heading 3',
                    onAction: function() {
                        editor.formatter.apply('heading3style');
                    }
                });
                
                editor.ui.registry.addNestedMenuItem('heading4', {
                    text: 'Heading 4',
                    onAction: function() {
                        editor.formatter.apply('heading4style');
                    }
                });
                
                editor.ui.registry.addNestedMenuItem('heading5', {
                    text: 'Heading 5',
                    onAction: function() {
                        editor.formatter.apply('heading5style');
                    }
                });
                
                editor.ui.registry.addNestedMenuItem('heading6', {
                    text: 'Heading 6',
                    onAction: function() {
                        editor.formatter.apply('heading6style');
                    }
                });
                
                editor.on('init', function() {
                    // Store editor instance globally
                    editorInstance = editor;
                    
                    // Load existing content if available
                    const existingContent = document.getElementById('policyContent').value;
                    if (existingContent) {
                        editor.setContent(existingContent);
                    }
                });
                
                // Sync content on change
                editor.on('change keyup', function() {
                    document.getElementById('policyContent').value = editor.getContent();
                });
            }
            });
        }

        function handleFormSubmit(event) {
            event.preventDefault(); // Prevent default form submission
            
            // Sync TinyMCE content to textarea
            const editor = tinymce.get('policyContent');
            if (editor) {
                const content = editor.getContent();
                document.getElementById('policyContent').value = content;
                
                // Validate content is not empty
                if (!content || content.trim() === '' || content === '<p></p>' || content === '<p><br></p>') {
                    showAlert('Please enter policy content', 'error');
                    return false;
                }
            }
            
            // Get form data
            const form = document.getElementById('policyForm');
            const formData = new FormData(form);
            
            // Disable submit button to prevent double submission
            const submitBtn = form.querySelector('button[type="submit"]');
            const originalBtnText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span>Saving...</span>';
            
            // Submit via AJAX
            fetch(form.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert(data.message || 'Policy saved successfully!', 'success');
                    
                    // Reload policies dropdown without page refresh
                    if (data.policyId) {
                        reloadPoliciesDropdown(data.policyId);
                    }
                } else {
                    showAlert(data.message || 'Failed to save policy', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('An error occurred while saving the policy', 'error');
            })
            .finally(() => {
                // Re-enable submit button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalBtnText;
            });
            
            return false;
        }
        
        function showAlert(message, type) {
            const alertContainer = document.getElementById('alertContainer');
            const alertClass = type === 'success' ? 'alert-success' : 'alert-error';
            
            alertContainer.innerHTML = `
                <div class="alert ${alertClass}">
                    ${message}
                </div>
            `;
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alertContainer.innerHTML = '';
            }, 5000);
        }
        
        async function reloadPoliciesDropdown(selectedId) {
            try {
                // Fetch updated policies list from API
                const response = await fetch('/Admin/PolicyManagement?handler=GetPolicies', {
                    method: 'GET',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Update dropdown options
                    const selector = document.getElementById('policySelector');
                    const currentOptions = selector.innerHTML;
                    
                    // Keep "Create New Policy" option
                    let newOptions = '<option value="new">-- Create New Policy --</option>';
                    
                    // Add all policies
                    if (data.policies && data.policies.length > 0) {
                        data.policies.forEach(policy => {
                            const isActive = policy.isActive ? '' : '(Inactive)';
                            const selected = policy.id === selectedId ? 'selected' : '';
                            newOptions += `<option value="${policy.id}" 
                                                  data-name="${escapeHtml(policy.policyName)}" 
                                                  data-content="${escapeHtml(policy.content)}" 
                                                  data-active="${policy.isActive}" 
                                                  ${selected}>
                                              ${escapeHtml(policy.policyName)} ${isActive}
                                          </option>`;
                        });
                    }
                    
                    selector.innerHTML = newOptions;
                    
                    // Select the saved policy
                    if (selectedId) {
                        selector.value = selectedId;
                        loadPolicyData();
                    }
                } else {
                    // Fallback to page reload if API call fails
                    const scrollPosition = window.scrollY;
                    sessionStorage.setItem('scrollPosition', scrollPosition);
                    sessionStorage.setItem('selectedPolicyId', selectedId);
                    window.location.reload();
                }
            } catch (error) {
                console.error('Error reloading policies:', error);
                // Fallback to page reload
                const scrollPosition = window.scrollY;
                sessionStorage.setItem('scrollPosition', scrollPosition);
                sessionStorage.setItem('selectedPolicyId', selectedId);
                window.location.reload();
            }
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function loadPolicyData() {
            const selector = document.getElementById('policySelector');
            const selectedOption = selector.options[selector.selectedIndex];
            const deleteBtn = document.getElementById('deleteBtn');
            
            // Get editor instance
            const editor = editorInstance || tinymce.get('policyContent');
            
            if (selectedOption.value === 'new') {
                document.getElementById('policyName').value = '';
                document.getElementById('isActive').checked = true;
                deleteBtn.disabled = true;
                
                // Clear editor content
                if (editor) {
                    editor.setContent('');
                } else {
                    // Fallback if editor not ready
                    setTimeout(() => {
                        const ed = editorInstance || tinymce.get('policyContent');
                        if (ed) ed.setContent('');
                    }, 100);
                }
            } else {
                document.getElementById('policyName').value = selectedOption.dataset.name || '';
                const content = selectedOption.dataset.content || '';
                const decodedContent = decodeHtmlEntities(content);
                document.getElementById('isActive').checked = selectedOption.dataset.active === 'true';
                deleteBtn.disabled = false;
                
                // Set editor content
                if (editor) {
                    // Sanitize content to prevent normalize errors
                    try {
                        editor.setContent(decodedContent || '');
                    } catch (e) {
                        console.error('Error setting content:', e);
                        // Fallback: set as plain text
                        editor.setContent('<p>' + decodedContent.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p>');
                    }
                } else {
                    // Fallback if editor not ready
                    setTimeout(() => {
                        const ed = editorInstance || tinymce.get('policyContent');
                        if (ed) {
                            try {
                                ed.setContent(decodedContent || '');
                            } catch (e) {
                                console.error('Error setting content:', e);
                                ed.setContent('<p>' + decodedContent.replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p>');
                            }
                        }
                    }, 100);
                }
            }
        }

        function decodeHtmlEntities(text) {
            if (!text) return '';
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }
        
        function resetForm() {
            document.getElementById('policySelector').value = 'new';
            loadPolicyData();
        }

        async function deletePolicy() {
            const selector = document.getElementById('policySelector');
            const selectedPolicyId = selector.value;
            
            if (selectedPolicyId === 'new') {
                showAlert('Please select a policy to delete', 'error');
                return;
            }
            
            const selectedOption = selector.options[selector.selectedIndex];
            const policyName = selectedOption.dataset.name || 'this policy';
            
            // Confirmation dialog
            if (!confirm(`Are you sure you want to delete "${policyName}"?\n\nThis action cannot be undone.`)) {
                return;
            }
            
            const deleteBtn = document.getElementById('deleteBtn');
            const originalBtnText = deleteBtn.innerHTML;
            deleteBtn.disabled = true;
            deleteBtn.innerHTML = '<span>Deleting...</span>';
            
            try {
                const response = await fetch(`/Admin/PolicyManagement?handler=Delete&id=${selectedPolicyId}`, {
                    method: 'POST',
                    headers: {
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        showAlert(data.message || 'Policy deleted successfully!', 'success');
                        
                        // Remove the deleted option from dropdown
                        selectedOption.remove();
                        
                        // Reset to "Create New Policy"
                        selector.value = 'new';
                        loadPolicyData();
                    } else {
                        showAlert(data.message || 'Failed to delete policy', 'error');
                        deleteBtn.disabled = false;
                        deleteBtn.innerHTML = originalBtnText;
                    }
                } else {
                    showAlert('Failed to delete policy', 'error');
                    deleteBtn.disabled = false;
                    deleteBtn.innerHTML = originalBtnText;
                }
            } catch (error) {
                console.error('Error deleting policy:', error);
                showAlert('An error occurred while deleting the policy', 'error');
                deleteBtn.disabled = false;
                deleteBtn.innerHTML = originalBtnText;
            }
        }
        
        // Restore scroll position and selected policy after page reload
        window.addEventListener('load', function() {
            const scrollPosition = sessionStorage.getItem('scrollPosition');
            if (scrollPosition) {
                window.scrollTo(0, parseInt(scrollPosition));
                sessionStorage.removeItem('scrollPosition');
            }
            
            const selectedPolicyId = sessionStorage.getItem('selectedPolicyId');
            if (selectedPolicyId) {
                const selector = document.getElementById('policySelector');
                selector.value = selectedPolicyId;
                loadPolicyData();
                sessionStorage.removeItem('selectedPolicyId');
            }
        });
    </script>
}
