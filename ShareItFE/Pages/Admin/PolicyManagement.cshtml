@page
@model ShareItFE.Pages.Admin.PolicyManagementModel
@{
    ViewData["Title"] = "Policy Rule Management";
    Layout = "_AdminLayout";
}

@section Styles {
    <style>
        .policy-management-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1a202c;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: #718096;
            font-size: 1rem;
        }

        .alert {
            padding: 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .alert-success {
            background-color: #c6f6d5;
            border: 1px solid #9ae6b4;
            color: #22543d;
        }

        .alert-error {
            background-color: #fed7d7;
            border: 1px solid #fc8181;
            color: #742a2a;
        }

        .policy-card {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 0.5rem;
        }

        .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            background-color: white;
            transition: all 0.2s;
        }

        .form-select:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #7c3aed;
            box-shadow: 0 0 0 3px rgba(124, 58, 237, 0.1);
        }

        .editor-toolbar {
            background: #f7fafc;
            border: 1px solid #e2e8f0;
            border-bottom: none;
            border-radius: 0.5rem 0.5rem 0 0;
            padding: 0.75rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .toolbar-btn {
            padding: 0.5rem 0.75rem;
            border: 1px solid #e2e8f0;
            background: white;
            border-radius: 0.375rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .toolbar-btn:hover {
            background: #edf2f7;
        }

        .editor-textarea {
            width: 100%;
            min-height: 400px;
            padding: 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0 0 0.5rem 0.5rem;
            font-family: 'Courier New', monospace;
            font-size: 0.875rem;
            resize: vertical;
        }

        .editor-textarea:focus {
            outline: none;
            border-color: #7c3aed;
        }

        .editor-hint {
            font-size: 0.75rem;
            color: #718096;
            margin-top: 0.5rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .checkbox-input {
            width: 1.25rem;
            height: 1.25rem;
            cursor: pointer;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: #7c3aed;
            color: white;
        }

        .btn-primary:hover {
            background: #6d28d9;
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #2d3748;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        .btn-danger {
            background: #f56565;
            color: white;
        }

        .btn-danger:hover {
            background: #e53e3e;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            margin-top: 2rem;
        }

        .preview-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: #f7fafc;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
        }

        .preview-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 1rem;
        }

        .preview-content {
            background: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            min-height: 200px;
        }

        .preview-content h1 {
            font-size: 1.875rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .preview-content h2 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .preview-content h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 1.25rem;
            margin-bottom: 0.5rem;
        }

        .preview-content p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .preview-content ul, .preview-content ol {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .preview-content li {
            margin-bottom: 0.5rem;
        }
    </style>
}

<div class="policy-management-container">
    <div class="page-header">
        <h1 class="page-title">Policy Rule Management</h1>
        <p class="page-subtitle">Edit and update platform policies and legal documents</p>
    </div>

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success">
            @Model.SuccessMessage
        </div>
    }

    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-error">
            @Model.ErrorMessage
        </div>
    }

    <div class="policy-card">
        <form method="post" asp-page-handler="Save">
            <div class="form-group">
                <label class="form-label">Select Policy to Edit</label>
                <select class="form-select" asp-for="SelectedPolicyId" id="policySelector" onchange="loadPolicyData()">
                    <option value="new">-- Create New Policy --</option>
                    @foreach (var policy in Model.Policies)
                    {
                        <option value="@policy.Id" 
                                data-name="@policy.PolicyName" 
                                data-content="@System.Web.HttpUtility.HtmlEncode(policy.Content)" 
                                data-active="@policy.IsActive.ToString().ToLower()">
                            @policy.PolicyName @(policy.IsActive ? "" : "(Inactive)")
                        </option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label class="form-label">Policy Name</label>
                <input type="text" class="form-input" asp-for="PolicyName" id="policyName" placeholder="Enter policy name" required />
            </div>

            <div class="form-group">
                <label class="form-label">Policy Content</label>
                <div class="editor-toolbar">
                    <button type="button" class="toolbar-btn" onclick="insertTag('h1')"><strong>H1</strong></button>
                    <button type="button" class="toolbar-btn" onclick="insertTag('h2')"><strong>H2</strong></button>
                    <button type="button" class="toolbar-btn" onclick="insertTag('h3')"><strong>H3</strong></button>
                    <button type="button" class="toolbar-btn" onclick="insertTag('p')">P</button>
                    <button type="button" class="toolbar-btn" onclick="insertTag('strong')"><strong>B</strong></button>
                    <button type="button" class="toolbar-btn" onclick="insertTag('em')"><em>I</em></button>
                    <button type="button" class="toolbar-btn" onclick="insertTag('u')"><u>U</u></button>
                    <button type="button" class="toolbar-btn" onclick="insertList('ul')">â€¢ List</button>
                    <button type="button" class="toolbar-btn" onclick="insertList('ol')">1. List</button>
                    <button type="button" class="toolbar-btn" onclick="insertLink()">ðŸ”— Link</button>
                </div>
                <textarea class="editor-textarea" asp-for="PolicyContent" id="policyContent" placeholder="Enter policy content with HTML formatting..." required></textarea>
                <p class="editor-hint">Use HTML tags for formatting. Preview will be shown below.</p>
            </div>

            <div class="form-group">
                <div class="checkbox-group">
                    <input type="checkbox" class="checkbox-input" asp-for="IsActive" id="isActive" />
                    <label class="form-label" for="isActive" style="margin-bottom: 0;">Active (visible to users)</label>
                </div>
            </div>

            <div class="form-actions">
                <button type="submit" class="btn btn-primary">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                        <polyline points="17 21 17 13 7 13 7 21"></polyline>
                        <polyline points="7 3 7 8 15 8"></polyline>
                    </svg>
                    Save Policy
                </button>
                <button type="button" class="btn btn-secondary" onclick="resetForm()">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                    Reset
                </button>
            </div>
        </form>

        <div class="preview-section">
            <h3 class="preview-title">Preview</h3>
            <div class="preview-content" id="previewContent">
                <p style="color: #a0aec0;">Preview will appear here...</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function loadPolicyData() {
            const selector = document.getElementById('policySelector');
            const selectedOption = selector.options[selector.selectedIndex];
            
            if (selectedOption.value === 'new') {
                document.getElementById('policyName').value = '';
                document.getElementById('policyContent').value = '';
                document.getElementById('isActive').checked = true;
                updatePreview();
            } else {
                document.getElementById('policyName').value = selectedOption.dataset.name || '';
                const content = selectedOption.dataset.content || '';
                document.getElementById('policyContent').value = decodeHtmlEntities(content);
                document.getElementById('isActive').checked = selectedOption.dataset.active === 'true';
                updatePreview();
            }
        }

        function decodeHtmlEntities(text) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = text;
            return textarea.value;
        }

        function insertTag(tag) {
            const textarea = document.getElementById('policyContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);
            
            const newText = `<${tag}>${selectedText || 'Text here'}</${tag}>`;
            textarea.value = beforeText + newText + afterText;
            
            textarea.focus();
            textarea.selectionStart = start + tag.length + 2;
            textarea.selectionEnd = start + tag.length + 2 + (selectedText || 'Text here').length;
            
            updatePreview();
        }

        function insertList(listType) {
            const textarea = document.getElementById('policyContent');
            const start = textarea.selectionStart;
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(start);
            
            const listHtml = `<${listType}>\n  <li>Item 1</li>\n  <li>Item 2</li>\n  <li>Item 3</li>\n</${listType}>`;
            textarea.value = beforeText + listHtml + afterText;
            
            updatePreview();
        }

        function insertLink() {
            const textarea = document.getElementById('policyContent');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);
            
            const linkHtml = `<a href="https://example.com">${selectedText || 'Link text'}</a>`;
            textarea.value = beforeText + linkHtml + afterText;
            
            updatePreview();
        }

        function updatePreview() {
            const content = document.getElementById('policyContent').value;
            const preview = document.getElementById('previewContent');
            
            if (content.trim() === '') {
                preview.innerHTML = '<p style="color: #a0aec0;">Preview will appear here...</p>';
            } else {
                preview.innerHTML = content;
            }
        }

        function resetForm() {
            document.getElementById('policySelector').value = 'new';
            loadPolicyData();
        }

        // Update preview on content change
        document.getElementById('policyContent').addEventListener('input', updatePreview);

        // Load initial data if policy is selected
        document.addEventListener('DOMContentLoaded', function() {
            const selector = document.getElementById('policySelector');
            if (selector.value && selector.value !== 'new') {
                loadPolicyData();
            }
        });
    </script>
}
