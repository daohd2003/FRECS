@page
@model ShareItFE.Pages.Admin.Compensation.IndexModel
@{
    ViewData["Title"] = "Dispute Resolution Center";
    Layout = "~/Pages/Shared/_AdminLayout.cshtml";
}

<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
    .dispute-table-container {
        background: white;
        border-radius: 0.5rem;
        box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1);
        overflow: hidden;
    }

    .dispute-header {
        background: linear-gradient(to right, #dc2626, #b91c1c);
        color: white;
        padding: 2rem;
    }

    .filter-panel {
        transition: max-height 0.3s ease-out, opacity 0.3s ease-out;
        max-height: 0;
        opacity: 0;
        overflow: hidden;
    }

    .filter-panel.active {
        max-height: 500px;
        opacity: 1;
    }

    .case-row:hover {
        background-color: #f9fafb;
    }
</style>

<div class="min-h-screen bg-gray-50 py-8 px-4 sm:px-6 lg:px-8">
    <div class="max-w-7xl mx-auto">
        <div class="dispute-table-container">
            <!-- Header -->
            <div class="dispute-header">
                <div class="flex items-center gap-3">
                    <i data-lucide="alert-circle" class="w-8 h-8"></i>
                    <div>
                        <h1 class="text-3xl font-bold">Dispute Resolution Center</h1>
                        <p class="text-red-100 mt-1">Review and resolve compensation disputes</p>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Section -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="relative w-full md:flex-grow">
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
                        </div>
                        <input type="text" id="search-input" placeholder="Search by Case ID, Product Name, Provider, or Customer..." 
                               class="w-full pl-10 pr-10 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" />
                        <button id="clear-search" class="absolute inset-y-0 right-0 pr-3 flex items-center hidden">
                            <i data-lucide="x" class="h-5 w-5 text-gray-400 hover:text-gray-600 cursor-pointer"></i>
                        </button>
                    </div>

                    <div class="flex items-center gap-2 sm:gap-3 w-full md:w-auto">
                        <button type="button" id="filter-btn" class="flex items-center gap-2 px-4 py-2.5 border border-gray-300 rounded-lg bg-white text-gray-700 hover:bg-gray-50 transition-colors w-full justify-center sm:w-auto">
                            <i data-lucide="sliders-horizontal" class="h-5 w-5"></i>
                            <span>Filters</span>
                        </button>

                        <button id="reset-filters" class="flex items-center gap-2 px-4 py-2.5 border border-gray-300 rounded-lg bg-white text-gray-700 hover:bg-gray-50 transition-colors">
                            <i data-lucide="rotate-ccw" class="h-5 w-5"></i>
                            <span class="hidden sm:inline">Reset</span>
                        </button>
                    </div>
                </div>

                <!-- Filter Panel -->
                <div id="filter-panel" class="filter-panel pt-6 border-t border-gray-200 mt-6">
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
                        <div>
                            <label for="filter-status" class="block text-sm font-medium text-gray-700 mb-1.5">Status</label>
                            <select id="filter-status" class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all">
                                <option value="">All Status</option>
                                <option value="PENDING_ADMIN_REVIEW">Pending Admin Review</option>
                            </select>
                        </div>
                        <div>
                            <label for="filter-date-from" class="block text-sm font-medium text-gray-700 mb-1.5">Complaint From</label>
                            <input type="date" id="filter-date-from" class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" />
                        </div>
                        <div>
                            <label for="filter-date-to" class="block text-sm font-medium text-gray-700 mb-1.5">Complaint To</label>
                            <input type="date" id="filter-date-to" class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" />
                        </div>
                        <div>
                            <label for="filter-amount-min" class="block text-sm font-medium text-gray-700 mb-1.5">Min Amount</label>
                            <input type="number" id="filter-amount-min" placeholder="0.00" step="0.01" class="w-full rounded-lg border-gray-300 focus:ring-2 focus:ring-red-500 focus:border-red-500 transition-all" />
                        </div>
                    </div>
                </div>
            </div>

            <!-- Results Info -->
            <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                <div>
                    <p id="results-info" class="text-sm text-gray-600">Loading...</p>
                </div>
            </div>

            <!-- Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Case ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Product Name</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Provider</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Customer</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date of Complaint</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Requested Amount</th>
                            <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="dispute-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Loading state -->
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center">
                                <div class="flex flex-col items-center justify-center">
                                    <i data-lucide="loader" class="h-8 w-8 text-gray-400 animate-spin mb-2"></i>
                                    <p class="text-gray-500">Loading pending cases...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Pagination and Footer -->
            <div class="px-6 py-4 border-t border-gray-200">
                <div class="flex flex-col sm:flex-row items-center justify-between gap-4">
                    <p id="footer-info" class="text-sm text-gray-600"></p>
                    
                    <!-- Pagination -->
                    <div id="pagination-container" class="flex items-center gap-2">
                        <!-- Pagination buttons will be inserted here -->
                    </div>
                    
                    <div class="flex items-center gap-2 text-sm text-gray-600">
                        <span class="w-3 h-3 bg-red-600 rounded-full"></span>
                        <span>Priority: Oldest cases first</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        let allDisputes = [];
        let filteredDisputes = [];
        let currentPage = 1;
        const itemsPerPage = 8;

        // Load disputes on page load
        $(document).ready(function() {
            loadDisputes();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Filter button toggle
            $('#filter-btn').click(function() {
                $('#filter-panel').toggleClass('active');
            });

            // Search
            $('#search-input').on('input', function() {
                const searchTerm = $(this).val();
                if (searchTerm) {
                    $('#clear-search').removeClass('hidden');
                } else {
                    $('#clear-search').addClass('hidden');
                }
                applyFilters();
            });

            $('#clear-search').click(function() {
                $('#search-input').val('');
                $(this).addClass('hidden');
                applyFilters();
            });

            // Filter inputs
            $('#filter-status, #filter-date-from, #filter-date-to, #filter-amount-min').on('change input', function() {
                applyFilters();
            });

            // Reset filters
            $('#reset-filters').click(function() {
                $('#search-input').val('');
                $('#filter-status').val('');
                $('#filter-date-from').val('');
                $('#filter-date-to').val('');
                $('#filter-amount-min').val('');
                $('#clear-search').addClass('hidden');
                applyFilters();
            });
        }

        async function loadDisputes() {
            try {
                const apiBaseUrl = window.apiSettings?.baseUrl || 'https://localhost:7256/api';
                
                // Get access token - try multiple sources
                let accessToken = window.adminChatConfig?.accessToken || getCookie('AccessToken');
                
                console.log('Access Token Available:', !!accessToken);
                console.log('Token (first 20 chars):', accessToken ? accessToken.substring(0, 20) + '...' : 'NONE');
                
                const headers = {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                };
                
                if (accessToken) {
                    headers['Authorization'] = `Bearer ${accessToken}`;
                } else {
                    console.error('No access token found! User may not be authenticated.');
                }
                
                const response = await fetch(`${apiBaseUrl}/CompensationDispute/pending`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: headers
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API Error:', response.status, errorText);
                    console.error('Request Headers:', headers);
                    throw new Error(`Failed to load disputes: ${response.status}`);
                }

                allDisputes = await response.json();
                filteredDisputes = [...allDisputes];
                renderDisputes();
            } catch (error) {
                console.error('Error loading disputes:', error);
                showError('Failed to load pending cases. Please try again.');
            }
        }
        
        // Helper function to get cookie value
        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
            return null;
        }

        function applyFilters() {
            const searchTerm = $('#search-input').val().toLowerCase();
            const statusFilter = $('#filter-status').val();
            const dateFrom = $('#filter-date-from').val();
            const dateTo = $('#filter-date-to').val();
            const amountMin = parseFloat($('#filter-amount-min').val()) || 0;

            filteredDisputes = allDisputes.filter(dispute => {
                // Search filter
                if (searchTerm) {
                    const searchMatch = 
                        dispute.violationId.toLowerCase().includes(searchTerm) ||
                        dispute.productName.toLowerCase().includes(searchTerm) ||
                        dispute.providerName.toLowerCase().includes(searchTerm) ||
                        dispute.customerName.toLowerCase().includes(searchTerm);
                    
                    if (!searchMatch) return false;
                }

                // Status filter
                if (statusFilter && dispute.status !== statusFilter) {
                    return false;
                }

                // Date range filter
                const complaintDate = new Date(dispute.complaintDate);
                if (dateFrom) {
                    const fromDate = new Date(dateFrom);
                    if (complaintDate < fromDate) return false;
                }
                if (dateTo) {
                    const toDate = new Date(dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    if (complaintDate > toDate) return false;
                }

                // Amount filter
                if (amountMin > 0 && dispute.requestedCompensation < amountMin) {
                    return false;
                }

                return true;
            });

            currentPage = 1; // Reset to first page when filters change
            renderDisputes();
        }

        function renderDisputes() {
            const tbody = $('#dispute-table-body');
            tbody.empty();

            if (filteredDisputes.length === 0) {
                tbody.append(`
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center">
                            <div class="flex flex-col items-center justify-center">
                                <i data-lucide="alert-circle" class="h-16 w-16 text-gray-400 mb-4"></i>
                                <h3 class="text-xl font-semibold text-gray-700 mb-2">No Pending Cases</h3>
                                <p class="text-gray-600">All disputes have been resolved or no cases match your filters</p>
                            </div>
                        </td>
                    </tr>
                `);
            } else {
                filteredDisputes.forEach(dispute => {
                    const row = `
                        <tr class="case-row transition-colors">
                            <td class="px-6 py-4">
                                <span class="font-mono text-sm text-gray-900">${dispute.violationId.substring(0, 8)}...</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="font-medium text-gray-900">${escapeHtml(dispute.productName)}</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-gray-700">${escapeHtml(dispute.providerName)}</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-gray-700">${escapeHtml(dispute.customerName)}</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="text-gray-700">${formatDate(dispute.complaintDate)}</span>
                            </td>
                            <td class="px-6 py-4">
                                <span class="font-semibold text-red-600">$${dispute.requestedCompensation.toFixed(2)}</span>
                            </td>
                            <td class="px-6 py-4 text-center">
                                <a href="/Admin/Compensation/Details/${dispute.violationId}" 
                                   class="inline-flex items-center gap-2 bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg font-medium transition-colors">
                                    <i data-lucide="eye" class="w-4 h-4"></i>
                                    View Details
                                </a>
                            </td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }

            // Re-initialize Lucide icons
            lucide.createIcons();

            // Update info
            updateInfo();
        }

        function updateInfo() {
            const total = filteredDisputes.length;
            const startIndex = (currentPage - 1) * itemsPerPage + 1;
            const endIndex = Math.min(currentPage * itemsPerPage, total);
            
            let resultsText;
            if (total === 0) {
                resultsText = 'No pending cases';
            } else if (total === 1) {
                resultsText = 'Showing 1 pending case';
            } else {
                resultsText = `Showing ${startIndex}-${endIndex} of ${total} pending cases`;
            }
            
            $('#results-info').text(resultsText);
            $('#footer-info').text(resultsText);
        }

        function showError(message) {
            const tbody = $('#dispute-table-body');
            tbody.html(`
                <tr>
                    <td colspan="7" class="px-6 py-12 text-center">
                        <div class="flex flex-col items-center justify-center">
                            <i data-lucide="alert-triangle" class="h-16 w-16 text-red-500 mb-4"></i>
                            <p class="text-red-600 font-semibold">${message}</p>
                        </div>
                    </td>
                </tr>
            `);
            lucide.createIcons();
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
    <script src="~/js/Index_Pagination.js"></script>
}

