@page "/revenue"
@model ShareItFE.Pages.RevenueModel
@{
    ViewData["Title"] = "Revenue Dashboard";
}

<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<script src="https://unpkg.com/lucide@latest"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
    .revenue-dashboard {
        overflow-x: hidden;
        width: 100%;
    }
    
    .chart-container {
        position: relative;
        height: 320px;
        width: 100%;
        overflow: hidden;
    }
    
    .chart-container canvas {
        position: absolute;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
    }
</style>

<div class="min-h-screen bg-gray-50 revenue-dashboard">
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        
        <!-- Header -->
        <div class="mb-8">
            @if (string.Equals(Model.UserRole, "provider", StringComparison.OrdinalIgnoreCase))
            {
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Provider Dashboard</h1>
                <p class="text-gray-600">Track your earnings, manage payouts, and view rental insights</p>
            }
            else
            {
                <h1 class="text-3xl font-bold text-gray-900 mb-2">Customer Dashboard</h1>
                <p class="text-gray-600">Track your spending, view rental history, and manage finances</p>
            }
        </div>

        <!-- Toast Container -->
        <div id="toastContainer" class="fixed top-4 right-4 z-[70] space-y-2"></div>
        @if (!string.IsNullOrEmpty(Model.SuccessMessage))
        {
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('Success message:', '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.SuccessMessage))');
                    showToast('@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.SuccessMessage))', 'success');
                });
            </script>
        }
        else if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <script>
                document.addEventListener('DOMContentLoaded', function() {
                    console.log('Error message:', '@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ErrorMessage))');
                    showToast('@Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.ErrorMessage))', 'error');
                });
            </script>
        }

        <!-- Tab Navigation -->
        <div class="mb-8">
            <nav class="flex space-x-8 border-b border-gray-200">
                @if (string.Equals(Model.UserRole, "provider", StringComparison.OrdinalIgnoreCase))
                {
                    <a href="?tab=overview&period=@Model.Period" 
                       class="py-2 px-1 border-b-2 font-medium text-sm @(Model.Tab == "overview" ? "border-purple-500 text-purple-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300")">
                        <i data-lucide="bar-chart-3" class="h-4 w-4 inline mr-2"></i>
                        Revenue & Insights
                    </a>
                    <a href="?tab=payout&period=@Model.Period" 
                       class="py-2 px-1 border-b-2 font-medium text-sm @(Model.Tab == "payout" ? "border-purple-500 text-purple-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300")">
                        <i data-lucide="credit-card" class="h-4 w-4 inline mr-2"></i>
                        Payout Management
                    </a>
                }
                else
                {
                    <a href="?tab=overview&period=@Model.Period" 
                       class="py-2 px-1 border-b-2 font-medium text-sm @(Model.Tab == "overview" ? "border-purple-500 text-purple-600" : "border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300")">
                        <i data-lucide="bar-chart-3" class="h-4 w-4 inline mr-2"></i>
                        Spending Overview
                    </a>
                }
            </nav>
        </div>

        @if (Model.Tab == "overview")
        {
            
            <!-- Period Selector -->
            <div class="mb-6 flex justify-between items-center">
                <div class="flex space-x-4">
                    <a href="?tab=overview&period=week" 
                       class="px-4 py-2 rounded-lg text-sm font-medium @(Model.Period == "week" ? "bg-purple-600 text-white" : "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50")">
                        Week
                    </a>
                    <a href="?tab=overview&period=month" 
                       class="px-4 py-2 rounded-lg text-sm font-medium @(Model.Period == "month" ? "bg-purple-600 text-white" : "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50")">
                        Month
                    </a>
                    <a href="?tab=overview&period=year" 
                       class="px-4 py-2 rounded-lg text-sm font-medium @(Model.Period == "year" ? "bg-purple-600 text-white" : "bg-white text-gray-700 border border-gray-300 hover:bg-gray-50")">
                        Year
                    </a>
                </div>
                <form method="post" asp-page-handler="ExportReport" class="inline">
                    <input type="hidden" name="period" value="@Model.Period" />
                    <input type="hidden" name="startDate" value="@(Model.StartDate?.ToString("yyyy-MM-dd"))" />
                    <input type="hidden" name="endDate" value="@(Model.EndDate?.ToString("yyyy-MM-dd"))" />
                    <button type="submit" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center transition-colors">
                        <i data-lucide="download" class="h-4 w-4 mr-2"></i>
                        Export Report
                    </button>
                </form>
            </div>

            <!-- Key Metrics -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <!-- Revenue Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Revenue</p>
                            <p class="text-2xl font-bold text-gray-900">@Model.RevenueStats.CurrentPeriodRevenue.ToString("N0")₫</p>
                        </div>
                        <div class="h-12 w-12 bg-green-100 rounded-lg flex items-center justify-center">
                            <span class="text-2xl font-bold text-green-600">₫</span>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center">
                        @if (Model.RevenueStats.RevenueGrowthPercentage >= 0)
                        {
                            <i data-lucide="trending-up" class="h-4 w-4 text-green-500 mr-1"></i>
                            <span class="text-sm text-green-600 font-medium">+@Model.RevenueStats.RevenueGrowthPercentage.ToString("F1")%</span>
                        }
                        else
                        {
                            <i data-lucide="trending-down" class="h-4 w-4 text-red-500 mr-1"></i>
                            <span class="text-sm text-red-600 font-medium">@Model.RevenueStats.RevenueGrowthPercentage.ToString("F1")%</span>
                        }
                        <span class="text-sm text-gray-500 ml-2">vs last @Model.Period.ToLower()</span>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <span class="text-xs text-gray-500">From completed orders</span>
                    </div>
                </div>

                <!-- Orders Card -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-600">Orders</p>
                            <p class="text-2xl font-bold text-gray-900">@Model.RevenueStats.CurrentPeriodOrders</p>
                        </div>
                        <div class="h-12 w-12 bg-blue-100 rounded-lg flex items-center justify-center">
                            <i data-lucide="shopping-bag" class="h-6 w-6 text-blue-600"></i>
                        </div>
                    </div>
                    <div class="mt-4 flex items-center">
                        @if (Model.RevenueStats.OrderGrowthPercentage >= 0)
                        {
                            <i data-lucide="trending-up" class="h-4 w-4 text-green-500 mr-1"></i>
                            <span class="text-sm text-green-600 font-medium">+@Model.RevenueStats.OrderGrowthPercentage.ToString("F1")%</span>
                        }
                        else
                        {
                            <i data-lucide="trending-down" class="h-4 w-4 text-red-500 mr-1"></i>
                            <span class="text-sm text-red-600 font-medium">@Model.RevenueStats.OrderGrowthPercentage.ToString("F1")%</span>
                        }
                        <span class="text-sm text-gray-500 ml-2">vs last @Model.Period.ToLower()</span>
                    </div>
                    <div class="mt-3 pt-3 border-t border-gray-100">
                        <span class="text-xs text-gray-500">Exclude pending & cancelled</span>
                    </div>
                </div>

                @if (string.Equals(Model.UserRole, "provider", StringComparison.OrdinalIgnoreCase))
                {
                    <!-- Net Revenue (Provider) -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Net Revenue</p>
                                <p class="text-2xl font-bold text-gray-900">@Model.RevenueStats.NetRevenue.ToString("N0")₫</p>
                            </div>
                            <div class="h-12 w-12 bg-emerald-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="wallet" class="h-6 w-6 text-emerald-600"></i>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center">
                            @if (Model.RevenueStats.NetRevenueGrowthPercentage >= 0)
                            {
                                <i data-lucide="trending-up" class="h-4 w-4 text-green-500 mr-1"></i>
                                <span class="text-sm text-green-600 font-medium">+@Model.RevenueStats.NetRevenueGrowthPercentage.ToString("F1")%</span>
                            }
                            else
                            {
                                <i data-lucide="trending-down" class="h-4 w-4 text-red-500 mr-1"></i>
                                <span class="text-sm text-red-600 font-medium">@Model.RevenueStats.NetRevenueGrowthPercentage.ToString("F1")%</span>
                            }
                            <span class="text-sm text-gray-500 ml-2">vs last @Model.Period.ToLower()</span>
                        </div>
                        <div class="mt-3 pt-3 border-t border-gray-100 space-y-1">
                            <span class="text-xs text-gray-500 block mb-2">After platform fees</span>
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-gray-500">From orders:</span>
                                <span class="text-gray-700 font-medium">@Model.RevenueStats.NetRevenueFromOrders.ToString("N0")₫</span>
                            </div>
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-gray-500">From penalties:</span>
                                <span class="text-gray-700 font-medium">@Model.RevenueStats.NetRevenueFromPenalties.ToString("N0")₫</span>
                            </div>
                        </div>
                    </div>

                    <!-- Platform Fee (Provider) -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Platform Fee</p>
                                <p class="text-2xl font-bold text-gray-900">@Model.RevenueStats.PlatformFee.ToString("N0")₫</p>
                            </div>
                            <div class="h-12 w-12 bg-orange-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="percent" class="h-6 w-6 text-orange-600"></i>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center">
                            @if (Model.RevenueStats.PlatformFeeGrowthPercentage >= 0)
                            {
                                <i data-lucide="trending-up" class="h-4 w-4 text-green-500 mr-1"></i>
                                <span class="text-sm text-green-600 font-medium">+@Model.RevenueStats.PlatformFeeGrowthPercentage.ToString("F1")%</span>
                            }
                            else
                            {
                                <i data-lucide="trending-down" class="h-4 w-4 text-red-500 mr-1"></i>
                                <span class="text-sm text-red-600 font-medium">@Model.RevenueStats.PlatformFeeGrowthPercentage.ToString("F1")%</span>
                            }
                            <span class="text-sm text-gray-500 ml-2">vs last @Model.Period.ToLower()</span>
                        </div>
                        <!-- Breakdown Detail -->
                        <div class="mt-3 pt-3 border-t border-gray-100 space-y-1">
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-gray-500">Rental fee (20%):</span>
                                <span class="text-gray-700 font-medium">@Model.RevenueStats.RentalFee.ToString("N0")₫</span>
                            </div>
                            <div class="flex justify-between items-center text-xs">
                                <span class="text-gray-500">Sales fee (10%):</span>
                                <span class="text-gray-700 font-medium">@Model.RevenueStats.PurchaseFee.ToString("N0")₫</span>
                            </div>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Total Spent (Customer) -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Total Spent</p>
                                <p class="text-2xl font-bold text-gray-900">@Model.RevenueStats.TotalSpent.ToString("N0")₫</p>
                            </div>
                            <div class="h-12 w-12 bg-purple-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="credit-card" class="h-6 w-6 text-purple-600"></i>
                            </div>
                        </div>
                        <div class="mt-4 flex items-center">
                            @if (Model.RevenueStats.TotalSpentGrowthPercentage >= 0)
                            {
                                <i data-lucide="trending-up" class="h-4 w-4 text-green-500 mr-1"></i>
                                <span class="text-sm text-green-600 font-medium">+@Model.RevenueStats.TotalSpentGrowthPercentage.ToString("F1")%</span>
                            }
                            else
                            {
                                <i data-lucide="trending-down" class="h-4 w-4 text-red-500 mr-1"></i>
                                <span class="text-sm text-red-600 font-medium">@Model.RevenueStats.TotalSpentGrowthPercentage.ToString("F1")%</span>
                            }
                            <span class="text-sm text-gray-500 ml-2">vs last @Model.Period.ToLower()</span>
                        </div>
                    </div>

                    <!-- Favorite Category (Customer) -->
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm font-medium text-gray-600">Favorite Category</p>
                                <p class="text-2xl font-bold text-gray-900">@(!string.IsNullOrEmpty(Model.RevenueStats.FavoriteCategory) ? Model.RevenueStats.FavoriteCategory : "None")</p>
                            </div>
                            <div class="h-12 w-12 bg-yellow-100 rounded-lg flex items-center justify-center">
                                <i data-lucide="heart" class="h-6 w-6 text-yellow-600"></i>
                            </div>
                        </div>
                        <div class="mt-4">
                            <span class="text-sm text-gray-500">@Model.RevenueStats.FavoriteCategoryCount rentals this @Model.Period.ToLower()</span>
                        </div>
                    </div>
                }
            </div>

            <!-- Charts Row -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <!-- Revenue Chart -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Revenue Trend</h3>
                    <div class="chart-container">
                        <canvas id="revenueChart"></canvas>
                    </div>
                </div>

                <!-- Order Status Breakdown -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <h3 class="text-lg font-semibold text-gray-900 mb-4">Order Status Breakdown</h3>
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        }
        else if (string.Equals(Model.UserRole, "provider", StringComparison.OrdinalIgnoreCase))
        {
            
            <!-- Payout Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Available Balance</h3>
                        <i data-lucide="wallet" class="h-6 w-6 text-green-600"></i>
                    </div>
                    <p class="text-3xl font-bold text-gray-900 mb-2">@Model.AvailableBalance.ToString("N0")₫</p>
                    <p class="text-sm text-gray-600">Ready for withdrawal</p>
                    @if (Model.AvailableBalance >= 50000)
                    {
                        <button type="button" onclick="openWithdrawalModal()" class="mt-4 w-full bg-purple-600 text-white py-2 px-4 rounded-lg hover:bg-purple-700 flex items-center justify-center">
                                <i data-lucide="send" class="h-4 w-4 mr-2"></i>
                                Request Payout
                            </button>
                    }
                    else
                    {
                        <p class="mt-4 text-xs text-red-600">Minimum withdrawal: 50,000₫</p>
                    }
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Total Earnings</h3>
                        <i data-lucide="trending-up" class="h-6 w-6 text-blue-600"></i>
                    </div>
                    <p class="text-3xl font-bold text-gray-900 mb-2">@Model.PayoutSummary.TotalEarnings.ToString("N0")₫</p>
                    <p class="text-sm text-gray-600">Lifetime earnings</p>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900">Total Payouts</h3>
                        <i data-lucide="arrow-down-left" class="h-6 w-6 text-purple-600"></i>
                    </div>
                    <p class="text-3xl font-bold text-gray-900 mb-2">@Model.PayoutSummary.TotalPayouts.ToString("N0")₫</p>
                    <p class="text-sm text-gray-600">Total paid out</p>
                </div>
            </div>

            <!-- Bank Accounts Section -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-semibold text-gray-900">Bank Accounts</h3>
                    <button type="button" onclick="openAddBankAccountModal()" class="bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 flex items-center">
                        <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                        Add Account
                    </button>
                </div>

                @if (Model.BankAccounts.Any())
                {
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        @foreach (var account in Model.BankAccounts)
                        {
                            <div class="relative border @(account.IsPrimary ? "border-purple-500 bg-purple-50" : "border-gray-200 bg-white") rounded-xl p-6 hover:shadow-lg transition-shadow">
                                @if (account.IsPrimary)
                                {
                                    <div class="absolute top-4 right-4">
                                        <span class="bg-purple-600 text-white text-xs font-medium px-3 py-1 rounded-full">Primary</span>
                                    </div>
                                }
                                <div class="flex items-start mb-4">
                                    <div class="h-12 w-12 bg-gray-100 rounded-lg flex items-center justify-center flex-shrink-0">
                                        <i data-lucide="building-2" class="h-6 w-6 text-gray-600"></i>
                                    </div>
                                </div>

                                <div class="mb-4 space-y-2">
                                    <h4 class="text-lg font-semibold text-gray-900">@account.BankName</h4>
                                    <p class="text-sm text-gray-600">Account: ****@account.Last4Digits</p>
                                    @if (!string.IsNullOrEmpty(account.RoutingNumber))
                                    {
                                        <p class="text-sm text-gray-500">Routing: @account.RoutingNumber</p>
                                    }
                                    <p class="text-sm text-gray-600">Holder: @account.AccountHolderName</p>
                                </div>

                                <div class="flex items-center space-x-3 pt-4 border-t border-gray-200">
                                    @if (!account.IsPrimary)
                                    {
                                        <form method="post" asp-page-handler="SetPrimaryAccount" class="inline-flex">
                                            <input type="hidden" name="accountId" value="@account.Id" />
                                            <button type="submit" class="text-purple-600 hover:text-purple-800 text-sm font-medium underline">
                                                Set as Primary
                                            </button>
                                        </form>
                                    }
                                    <button type="button" onclick="editBankAccount('@account.Id', '@account.BankName', '@account.AccountNumber', '@account.AccountHolderName', '@(account.RoutingNumber ?? "")')" class="text-blue-600 hover:text-blue-800 text-sm font-medium underline">
                                        Edit
                                    </button>
                                    <form method="post" asp-page-handler="DeleteBankAccount" class="inline-flex" onsubmit="return confirm('Are you sure you want to delete this account?')">
                                        <input type="hidden" name="accountId" value="@account.Id" />
                                        <button type="submit" class="text-red-600 hover:text-red-800 text-sm font-medium underline">
                                            Delete
                                        </button>
                                    </form>
                                </div>
                            </div>
                            }
                    </div>
                }
                else
                {
                    <div class="text-center py-12 border-2 border-dashed border-gray-300 rounded-lg">
                        <i data-lucide="building-2" class="h-16 w-16 mx-auto text-gray-300 mb-4"></i>
                        <p class="text-gray-500 font-medium">No bank accounts added yet</p>
                        <p class="text-sm text-gray-400 mt-2">Add a bank account to receive payouts</p>
                        <button type="button" onclick="openAddBankAccountModal()" class="mt-4 bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 inline-flex items-center">
                            <i data-lucide="plus" class="h-4 w-4 mr-2"></i>
                            Add Your First Account
                        </button>
                    </div>
                }
                </div>

            <!-- Bank Account Modal -->
            <div id="bankAccountModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-xl font-semibold text-gray-900" id="modalTitle">Add New Bank Account</h4>
                            <button type="button" onclick="closeBankAccountModal()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="h-6 w-6"></i>
                            </button>
                        </div>
                        <form method="post" id="bankAccountForm" asp-page-handler="CreateBankAccount">
                            <input type="hidden" id="accountIdField" name="accountId" value="" />
                            <input type="hidden" asp-for="Tab" />
                            <input type="hidden" asp-for="Period" />
                            <div class="space-y-4">
                                <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Bank Name</label>
                                <div class="relative">
                                    <input type="text" 
                                           id="bankNameField" 
                                           asp-for="NewBankAccount.BankName" 
                                           list="vietnamBanksList"
                                           required 
                                           class="w-full px-3 py-2 pr-28 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                                           placeholder="Type to search Vietnamese banks..." 
                                           autocomplete="off" />
                                    <button type="button" 
                                            id="changeBankBtn" 
                                            class="hidden absolute right-2 top-1/2 transform -translate-y-1/2 px-3 py-1.5 text-xs font-semibold text-purple-600 hover:text-purple-800 hover:bg-purple-50 rounded transition-colors z-10 bg-white shadow-sm"
                                            onclick="unlockBankName()">
                                        Change
                                    </button>
                                </div>
                                <div id="bankNameWarning" class="hidden mt-1 text-xs text-amber-600 flex items-center">
                                    <i data-lucide="alert-triangle" class="h-3 w-3 mr-1"></i>
                                    <span>Bank name doesn't match our list. Please select from the dropdown to ensure accuracy.</span>
                                </div>
                                <datalist id="vietnamBanksList">
                                    <!-- Top Vietnamese Banks -->
                                    <option value="Ngân hàng TMCP Ngoại thương Việt Nam (Vietcombank)">Vietcombank</option>
                                    <option value="Ngân hàng TMCP Đầu tư và Phát triển Việt Nam (BIDV)">BIDV</option>
                                    <option value="Ngân hàng TMCP Công thương Việt Nam (VietinBank)">VietinBank</option>
                                    <option value="Ngân hàng Nông nghiệp và Phát triển Nông thôn Việt Nam (Agribank)">Agribank</option>
                                    <option value="Ngân hàng TMCP Kỹ thương Việt Nam (Techcombank)">Techcombank</option>
                                    
                                    <!-- Commercial Banks -->
                                    <option value="Ngân hàng TMCP Á Châu (ACB)">ACB</option>
                                    <option value="Ngân hàng TMCP Quân đội (MB Bank)">MB Bank</option>
                                    <option value="Ngân hàng TMCP Việt Nam Thịnh Vượng (VPBank)">VPBank</option>
                                    <option value="Ngân hàng TMCP Tiên Phong (TPBank)">TPBank</option>
                                    <option value="Ngân hàng TMCP Sài Gòn Thương Tín (Sacombank)">Sacombank</option>
                                    <option value="Ngân hàng TMCP Phát triển Thành phố Hồ Chí Minh (HDBank)">HDBank</option>
                                    <option value="Ngân hàng TMCP Sài Gòn - Hà Nội (SHB)">SHB</option>
                                    <option value="Ngân hàng TMCP Quốc tế Việt Nam (VIB)">VIB</option>
                                    <option value="Ngân hàng TMCP Bưu điện Liên Việt (LienVietPostBank)">LienVietPostBank</option>
                                    <option value="Ngân hàng TMCP Phương Đông (OCB)">OCB</option>
                                    <option value="Ngân hàng TMCP Hàng Hải Việt Nam (MSB)">MSB</option>
                                    <option value="Ngân hàng TMCP Xuất Nhập khẩu Việt Nam (Eximbank)">Eximbank</option>
                                    <option value="Ngân hàng TMCP Đông Nam Á (SeABank)">SeABank</option>
                                    <option value="Ngân hàng TMCP Đại Chúng Việt Nam (PVcomBank)">PVcomBank</option>
                                    <option value="Ngân hàng TMCP Bắc Á (BacABank)">BacABank</option>
                                    
                                    <!-- Other Banks -->
                                    <option value="Ngân hàng TMCP Việt Nam Thương Tín (VietBank)">VietBank</option>
                                    <option value="Ngân hàng TMCP Nam Á (NamABank)">NamABank</option>
                                    <option value="Ngân hàng TMCP Xăng dầu Petrolimex (PGBank)">PGBank</option>
                                    <option value="Ngân hàng TMCP Bản Việt (VietCapitalBank)">VietCapitalBank</option>
                                    <option value="Ngân hàng TMCP Sài Gòn (SCB)">SCB</option>
                                    <option value="Ngân hàng TMCP An Bình (ABBank)">ABBank</option>
                                    <option value="Ngân hàng TMCP Quốc Dân (NCB)">NCB</option>
                                    <option value="Ngân hàng TMCP Bảo Việt (BaoVietBank)">BaoVietBank</option>
                                    <option value="Ngân hàng TMCP Kiên Long (KienLongBank)">KienLongBank</option>
                                    <option value="Ngân hàng TMCP Đông Á (DongABank)">DongABank</option>
                                    <option value="Ngân hàng TMCP Việt Á (VietABank)">VietABank</option>
                                    <option value="Ngân hàng TMCP Bưu Điện Việt Nam (LPBank)">LPBank</option>
                                    <option value="Ngân hàng TMCP Đại Dương (OceanBank)">OceanBank</option>
                                    <option value="Ngân hàng TMCP Quốc tế (VIB)">VIB</option>
                                    
                                    <!-- Foreign Banks in Vietnam -->
                                    <option value="HSBC Vietnam">HSBC</option>
                                    <option value="Standard Chartered Bank Vietnam">Standard Chartered</option>
                                    <option value="Citibank Vietnam">Citibank</option>
                                    <option value="Shinhan Bank Vietnam">Shinhan Bank</option>
                                    <option value="ANZ Vietnam">ANZ</option>
                                    <option value="Hong Leong Bank Vietnam">Hong Leong Bank</option>
                                    <option value="Public Bank Vietnam">Public Bank</option>
                                    <option value="CIMB Bank Vietnam">CIMB Bank</option>
                                    <option value="UOB Vietnam">UOB</option>
                                    <option value="Woori Bank Vietnam">Woori Bank</option>
                                </datalist>
                                <p class="text-xs text-gray-500 mt-1">
                                    <i data-lucide="info" class="h-3 w-3 inline"></i>
                                    Type to search from 40+ Vietnamese banks
                                </p>
                                </div>
                                <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Account Holder Name</label>
                                <input type="text" 
                                       id="accountHolderNameField" 
                                       asp-for="NewBankAccount.AccountHolderName" 
                                       required 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                                       placeholder="e.g. John Doe" 
                                       autocomplete="off" />
                                <div id="accountHolderNameError" class="hidden mt-1 text-xs text-red-600 flex items-center">
                                    <i data-lucide="alert-circle" class="h-3 w-3 mr-1"></i>
                                    <span id="accountHolderNameErrorText"></span>
                                </div>
                            </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Account Number</label>
                                    <input type="text" 
                                           id="accountNumberField" 
                                           asp-for="NewBankAccount.AccountNumber" 
                                           required 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                                           placeholder="e.g. 1234567890" 
                                           autocomplete="off"
                                           maxlength="17" />
                                    <div id="accountNumberError" class="hidden mt-1 text-xs text-red-600 flex items-center">
                                        <i data-lucide="alert-circle" class="h-3 w-3 mr-1"></i>
                                        <span id="accountNumberErrorText"></span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">
                                        Must be 8-17 digits
                                    </p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Routing Number (Optional)</label>
                                    <input type="text" 
                                           id="routingNumberField" 
                                           asp-for="NewBankAccount.RoutingNumber" 
                                           class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" 
                                           placeholder="e.g. 021000021" 
                                           autocomplete="off"
                                           maxlength="50" />
                                    <div id="routingNumberError" class="hidden mt-1 text-xs text-red-600 flex items-center">
                                        <i data-lucide="alert-circle" class="h-3 w-3 mr-1"></i>
                                        <span id="routingNumberErrorText"></span>
                                    </div>
                                </div>
                                <div>
                                    <label class="flex items-center">
                                        <input type="checkbox" id="setAsPrimaryField" asp-for="NewBankAccount.SetAsPrimary" class="rounded border-gray-300 text-purple-600 focus:ring-purple-500" />
                                        <span class="ml-2 text-sm text-gray-700">Set as primary account</span>
                                    </label>
                                </div>
                            </div>
                            <div class="flex space-x-3 mt-6">
                                <button type="submit" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 font-medium">
                                    Save Account
                                </button>
                                <button type="button" onclick="closeBankAccountModal()" class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-medium">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Request Withdrawal Modal -->
            <div id="withdrawalModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-xl max-w-md w-full mx-4">
                    <div class="p-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-xl font-semibold text-gray-900">Request Withdrawal</h4>
                            <button type="button" onclick="closeWithdrawalModal()" class="text-gray-400 hover:text-gray-600">
                                <i data-lucide="x" class="h-6 w-6"></i>
                            </button>
                        </div>
                        <form method="post" asp-page-handler="RequestWithdrawal" id="withdrawalForm" onsubmit="return confirmWithdrawal(event)">
                            <input type="hidden" asp-for="Tab" />
                            <input type="hidden" asp-for="Period" />
                            <div class="space-y-4">
                                <div class="bg-purple-50 border border-purple-200 rounded-lg p-4 mb-4">
                                    <p class="text-sm text-gray-700"><strong>Available Balance:</strong></p>
                                    <p class="text-2xl font-bold text-purple-600" id="availableBalanceDisplay">@Model.AvailableBalance.ToString("N0")₫</p>
                                    <input type="hidden" id="availableBalance" value="@Model.AvailableBalance" />
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Bank Account *</label>
                                    <select asp-for="WithdrawalRequest.BankAccountId" id="withdrawalBankAccount" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                        @foreach (var account in Model.BankAccounts)
                                        {
                                            var isPrimary = account.IsPrimary ? "true" : "false";
                                            var selected = account.IsPrimary ? "selected" : "";
                                           // <option value="@account.Id" data-bank-name="@account.BankName" data-last4="@account.Last4Digits" data-is-primary="@isPrimary" @selected>@account.BankName - ****@account.Last4Digits @(account.IsPrimary ? "(Primary)" : "")</option>
                                            <option value="@account.Id" data-bank-name="@account.BankName" data-last4="@account.Last4Digits" data-is-primary="@isPrimary" selected="@isPrimary">@account.BankName - ****@account.Last4Digits @(account.IsPrimary ? "(Primary)" : "")</option>
                                        }
                                    </select>
                                    @if (!Model.BankAccounts.Any())
                                    {
                                        <p class="mt-2 text-sm text-red-600">Please add a bank account first.</p>
                                    }
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Amount (VND) *</label>
                                    <input type="text" id="withdrawalAmountInput" name="withdrawalAmountDisplay" required class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Minimum 50,000₫" oninput="formatAndValidateAmount(this)" />
                                    <input type="hidden" id="withdrawalAmountHidden" asp-for="WithdrawalRequest.Amount" />
                                    <div class="mt-2 space-y-1">
                                        <p class="text-xs text-gray-500">Minimum withdrawal: <span class="font-semibold">50,000₫</span></p>
                                        <div id="remainingBalance" class="text-xs font-medium"></div>
                                        <div id="amountError" class="text-xs text-red-600 hidden"></div>
                                    </div>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional)</label>
                                    <textarea asp-for="WithdrawalRequest.Notes" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" placeholder="Add any notes about this withdrawal..."></textarea>
                                </div>
                            </div>
                            <div class="flex space-x-3 mt-6">
                                <button type="submit" id="submitWithdrawalBtn" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 font-medium disabled:bg-gray-300 disabled:cursor-not-allowed transition-all" disabled>
                                    <span id="submitBtnText">Submit Request</span>
                                    <span id="submitBtnLoader" class="hidden">
                                        <svg class="animate-spin h-5 w-5 inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                        </svg>
                                        Processing...
                                    </span>
                                </button>
                                <button type="button" onclick="closeWithdrawalModal()" class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-medium">
                                    Cancel
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Confirmation Modal -->
            <div id="confirmationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-[60] flex items-center justify-center">
                <div class="bg-white rounded-xl shadow-xl max-w-sm w-full mx-4">
                    <div class="p-6">
                        <div class="text-center mb-4">
                            <div class="mx-auto w-12 h-12 bg-yellow-100 rounded-full flex items-center justify-center mb-3">
                                <i data-lucide="alert-triangle" class="h-6 w-6 text-yellow-600"></i>
                            </div>
                            <h4 class="text-lg font-semibold text-gray-900">Confirm Withdrawal</h4>
                        </div>
                        <div class="space-y-2 mb-6 text-sm">
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">Amount:</span>
                                <span class="font-semibold" id="confirmAmount"></span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">Bank Account:</span>
                                <span class="font-semibold" id="confirmBank"></span>
                            </div>
                            <div class="flex justify-between py-2 border-b">
                                <span class="text-gray-600">Current Balance:</span>
                                <span class="font-semibold" id="confirmCurrentBalance"></span>
                            </div>
                            <div class="flex justify-between py-2">
                                <span class="text-gray-600">Remaining Balance:</span>
                                <span class="font-semibold text-purple-600" id="confirmRemainingBalance"></span>
                            </div>
                        </div>
                        <p class="text-xs text-gray-600 mb-4 text-center">Are you sure you want to proceed with this withdrawal?</p>
                        <div class="flex space-x-3">
                            <button type="button" onclick="proceedWithdrawal()" class="flex-1 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 font-medium">
                                Yes, Proceed
                            </button>
                            <button type="button" onclick="closeConfirmationModal()" class="flex-1 bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 font-medium">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Withdrawal History -->
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
                <h3 class="text-lg font-semibold text-gray-900 mb-6">Withdrawal History</h3>
                
                @if (Model.WithdrawalHistory.Any())
                {
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Request Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Amount</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Bank Account</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Processed Date</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
                                @foreach (var withdrawal in Model.WithdrawalHistory)
                                {
                                    <tr>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            @withdrawal.RequestDate.ToString("MMM dd, yyyy HH:mm")
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                                            @withdrawal.Amount.ToString("N0")₫
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                                            @withdrawal.BankName - ****@withdrawal.AccountLast4
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap">
                                            <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full 
                                                @(withdrawal.Status == "Completed" ? "bg-green-100 text-green-800" : 
                                                  withdrawal.Status == "Initiated" ? "bg-yellow-100 text-yellow-800" : 
                                                  "bg-red-100 text-red-800")">
                                                @withdrawal.Status.ToUpper()
                                            </span>
                                            @if (!string.IsNullOrEmpty(withdrawal.RejectionReason))
                                            {
                                                <p class="mt-1 text-xs text-red-600">@withdrawal.RejectionReason</p>
                                            }
                                        </td>
                                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                                            @(withdrawal.ProcessedAt.HasValue ? withdrawal.ProcessedAt.Value.ToString("MMM dd, yyyy HH:mm") : "-")
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-8 text-gray-500">
                        <i data-lucide="file-text" class="h-12 w-12 mx-auto text-gray-300 mb-4"></i>
                        <p>No withdrawal history</p>
                        <p class="text-sm">Your withdrawal requests will appear here</p>
                    </div>
                }
            </div>
        }
    </div>
</div>

@section Scripts {
    <script>
        // Initialize Lucide icons
        lucide.createIcons();

        // Toast Notification System
        function showToast(message, type = 'info', duration = 5000) {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            const toastId = 'toast-' + Date.now();
            toast.id = toastId;
            
            // Define colors and icons based on type
            let bgColor, borderColor, textColor, iconSvg;
            switch(type) {
                case 'success':
                    bgColor = 'bg-green-50';
                    borderColor = 'border-green-200';
                    textColor = 'text-green-800';
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                    break;
                case 'error':
                    bgColor = 'bg-red-50';
                    borderColor = 'border-red-200';
                    textColor = 'text-red-800';
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>';
                    break;
                case 'warning':
                    bgColor = 'bg-yellow-50';
                    borderColor = 'border-yellow-200';
                    textColor = 'text-yellow-800';
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>';
                    break;
                default:
                    bgColor = 'bg-blue-50';
                    borderColor = 'border-blue-200';
                    textColor = 'text-blue-800';
                    iconSvg = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>';
            }
            
            toast.className = `${bgColor} ${borderColor} border-l-4 ${textColor} px-6 py-4 rounded-lg shadow-lg transform transition-all duration-300 ease-in-out opacity-0 translate-x-full max-w-md`;
            toast.innerHTML = `
                <div class="flex items-center justify-between">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mr-3 mt-0.5">
                            ${iconSvg}
                        </div>
                        <div class="flex-1">
                            <p class="text-sm font-medium">${message}</p>
                        </div>
                    </div>
                    <button onclick="closeToast('${toastId}')" class="ml-4 flex-shrink-0 text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                    </button>
                </div>
            `;
            
            container.appendChild(toast);
            
            // Trigger animation
            setTimeout(() => {
                toast.classList.remove('opacity-0', 'translate-x-full');
                toast.classList.add('opacity-100', 'translate-x-0');
            }, 10);
            
            // Auto remove after duration
            setTimeout(() => {
                closeToast(toastId);
            }, duration);
        }

        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (toast) {
                toast.classList.add('opacity-0', 'translate-x-full');
                setTimeout(() => {
                    toast.remove();
                }, 300);
            }
        }

        // Make toast functions global
        window.showToast = showToast;
        window.closeToast = closeToast;

        // Bank Account Modal Functions
        function openAddBankAccountModal() {
            const form = document.getElementById('bankAccountForm');
            const modal = document.getElementById('bankAccountModal');
            
            // Set title and form action
            document.getElementById('modalTitle').textContent = 'Add New Bank Account';
            form.setAttribute('action', '?handler=CreateBankAccount');
            
            // Clear all fields
            document.getElementById('accountIdField').value = '';
            document.getElementById('bankNameField').value = '';
            document.getElementById('accountHolderNameField').value = '';
            document.getElementById('accountNumberField').value = '';
            document.getElementById('routingNumberField').value = '';
            document.getElementById('setAsPrimaryField').checked = false;
            
            // Clear all error messages
            clearAllFieldErrors();
            
            // Show modal
            modal.classList.remove('hidden');
            lucide.createIcons();
            
            // Initialize bank name autocomplete helper
            initBankNameAutocomplete();
            
            // Initialize field validations
            initFieldValidations();
            
            // Add form submit validation
            setupBankAccountFormValidation();
        }
        
        let formValidationHandler = null;
        
        function setupBankAccountFormValidation() {
            const form = document.getElementById('bankAccountForm');
            if (!form) return;
            
            // Remove existing handler if any
            if (formValidationHandler) {
                form.removeEventListener('submit', formValidationHandler, true);
            }
            
            // Create new validation handler
            formValidationHandler = function(e) {
                let hasErrors = false;
                let firstErrorField = null;
                
                // 1. Validate Bank Name
                const bankNameInput = document.getElementById('bankNameField');
                if (bankNameInput) {
                    const value = bankNameInput.value.trim();
                    if (value.length === 0) {
                        // HTML5 required will handle this
                        hasErrors = true;
                        if (!firstErrorField) firstErrorField = bankNameInput;
                    } else {
                        // Check if bank name matches datalist
                        const datalist = document.getElementById('vietnamBanksList');
                        if (datalist) {
                            const options = datalist.querySelectorAll('option');
                            let exactMatch = false;
                            options.forEach(option => {
                                if (option.value.toLowerCase() === value.toLowerCase()) {
                                    exactMatch = true;
                                }
                            });
                            
                            // If not locked and doesn't match, show warning and confirmation
                            if (!bankNameLocked && !exactMatch) {
                                showBankNameWarning();
                                if (!firstErrorField) firstErrorField = bankNameInput;
                                hasErrors = true;
                            }
                        }
                    }
                }
                
                // 2-4. Validate all form fields
                const fieldOrder = ['accountHolderName', 'accountNumber', 'routingNumber'];
                fieldOrder.forEach(fieldName => {
                    if (!FieldValidator.validate(fieldName)) {
                        hasErrors = true;
                        if (!firstErrorField) {
                            const config = FieldValidator.fields[fieldName];
                            firstErrorField = document.getElementById(config.inputId);
                        }
                    }
                });
                
                // If there are errors, prevent submission
                if (hasErrors) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    // Scroll to first error field
                    if (firstErrorField) {
                        firstErrorField.focus();
                        firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    
                    // If only bank name warning (not locked), show confirmation
                    const bankNameValue = bankNameInput ? bankNameInput.value.trim() : '';
                    if (bankNameValue.length > 0 && !bankNameLocked) {
                        const datalist = document.getElementById('vietnamBanksList');
                        if (datalist) {
                            const options = datalist.querySelectorAll('option');
                            let exactMatch = false;
                            options.forEach(option => {
                                if (option.value.toLowerCase() === bankNameValue.toLowerCase()) {
                                    exactMatch = true;
                                }
                            });
                            
                            if (!exactMatch) {
                                const proceed = confirm('⚠️ Warning: The bank name you entered is not in our list.\n\nThis may cause issues with bank account verification.\n\nDo you want to continue anyway?\n\n• Click OK to proceed with custom bank name\n• Click Cancel to select from the dropdown');
                                
                                if (proceed) {
                                    // User confirmed - remove validation and submit
                                    hideBankNameWarning();
                                    form.removeEventListener('submit', formValidationHandler, true);
                                    formValidationHandler = null;
                                    // Re-validate all fields before submitting
                                    if (FieldValidator.validateAll()) {
                                        form.submit();
                                    } else {
                                        // Other fields still have errors, show them
                                        setupBankAccountFormValidation();
                                    }
                                }
                            }
                        }
                    }
                    
                    return false;
                }
            };
            
            // Add submit validation
            form.addEventListener('submit', formValidationHandler, true);
        }
        
        // Bank Name Autocomplete Helper
        let bankNameLocked = false;
        let lastLockedValue = '';
        
        function initBankNameAutocomplete() {
            const bankNameInput = document.getElementById('bankNameField');
            if (!bankNameInput) return;
            
            // Reset lock state when modal opens
            bankNameLocked = false;
            lastLockedValue = '';
            unlockBankName();
            
            // Add icon to indicate searchable
            bankNameInput.addEventListener('focus', function() {
                if (!bankNameLocked) {
                    this.placeholder = 'Type: Vietcombank, BIDV, Techcombank...';
                }
            });
            
            bankNameInput.addEventListener('blur', function() {
                if (!bankNameLocked) {
                    this.placeholder = 'Type to search Vietnamese banks...';
                    validateBankName();
                }
            });
            
            // Detect when user selects from datalist or types
            bankNameInput.addEventListener('input', function() {
                const value = this.value.trim();
                const datalist = document.getElementById('vietnamBanksList');
                const options = datalist.querySelectorAll('option');
                
                // Check if current value exactly matches any option
                let exactMatch = false;
                options.forEach(option => {
                    if (option.value.toLowerCase() === value.toLowerCase()) {
                        exactMatch = true;
                    }
                });
                
                // If locked and user tries to edit
                if (bankNameLocked && value !== lastLockedValue) {
                    // User is editing locked value - unlock and show warning
                    unlockBankName();
                    if (value.length > 0 && !exactMatch) {
                        showBankNameWarning();
                    } else {
                        hideBankNameWarning();
                    }
                }
                
                // Visual feedback
                if (value.length > 0) {
                    if (exactMatch) {
                        this.style.borderColor = '#10b981'; // Green border for exact match
                        hideBankNameWarning();
                    } else {
                        this.style.borderColor = '#d1d5db'; // Default border
                    }
                } else {
                    this.style.borderColor = '#d1d5db';
                    hideBankNameWarning();
                }
            });
            
            // Detect selection from datalist (using change event)
            bankNameInput.addEventListener('change', function() {
                validateAndLockBankName();
            });
        }
        
        function validateAndLockBankName() {
            const bankNameInput = document.getElementById('bankNameField');
            const value = bankNameInput.value.trim();
            const datalist = document.getElementById('vietnamBanksList');
            const options = datalist.querySelectorAll('option');
            
            // Check if value exactly matches any option
            let exactMatch = false;
            options.forEach(option => {
                if (option.value.toLowerCase() === value.toLowerCase()) {
                    exactMatch = true;
                }
            });
            
            // Lock if exact match found
            if (exactMatch && value.length > 0) {
                lockBankName(value);
            }
        }
        
        function validateBankName() {
            const bankNameInput = document.getElementById('bankNameField');
            const value = bankNameInput.value.trim();
            
            if (value.length === 0) {
                hideBankNameWarning();
                return;
            }
            
            const datalist = document.getElementById('vietnamBanksList');
            const options = datalist.querySelectorAll('option');
            
            let exactMatch = false;
            options.forEach(option => {
                if (option.value.toLowerCase() === value.toLowerCase()) {
                    exactMatch = true;
                }
            });
            
            if (!exactMatch && !bankNameLocked) {
                showBankNameWarning();
            } else {
                hideBankNameWarning();
                if (exactMatch && !bankNameLocked) {
                    lockBankName(value);
                }
            }
        }
        
        function lockBankName(value) {
            const bankNameInput = document.getElementById('bankNameField');
            const changeBtn = document.getElementById('changeBankBtn');
            
            bankNameLocked = true;
            lastLockedValue = value;
            
            // Make input readonly (but still focusable for accessibility)
            bankNameInput.setAttribute('readonly', 'readonly');
            bankNameInput.style.backgroundColor = '#f9fafb';
            bankNameInput.style.cursor = 'not-allowed';
            bankNameInput.style.borderColor = '#10b981';
            
            // Show change button only (lock icon removed)
            changeBtn.classList.remove('hidden');
            
            // Hide warning
            hideBankNameWarning();
            
            // Re-initialize icons
            lucide.createIcons();
        }
        
        function unlockBankName() {
            const bankNameInput = document.getElementById('bankNameField');
            const changeBtn = document.getElementById('changeBankBtn');
            
            bankNameLocked = false;
            lastLockedValue = '';
            
            // Remove readonly
            bankNameInput.removeAttribute('readonly');
            bankNameInput.style.backgroundColor = '#ffffff';
            bankNameInput.style.cursor = 'text';
            bankNameInput.style.borderColor = '#d1d5db';
            
            // Hide change button
            changeBtn.classList.add('hidden');
            
            // Focus on input for easy editing
            bankNameInput.focus();
        }
        
        function showBankNameWarning() {
            const warning = document.getElementById('bankNameWarning');
            if (warning) {
                warning.classList.remove('hidden');
            }
        }
        
        function hideBankNameWarning() {
            const warning = document.getElementById('bankNameWarning');
            if (warning) {
                warning.classList.add('hidden');
            }
        }
        
        // Field Validation Helper - Optimized
        const FieldValidator = {
            fields: {
                accountNumber: {
                    inputId: 'accountNumberField',
                    errorId: 'accountNumberError',
                    errorTextId: 'accountNumberErrorText',
                    rules: {
                        required: true,
                        pattern: /^\d+$/,
                        patternError: 'Please enter a valid account number (digits only).',
                        minLength: 8,
                        maxLength: 17,
                        lengthError: 'Account number must be between 8 and 17 digits.',
                        digitsOnly: true
                    }
                },
                accountHolderName: {
                    inputId: 'accountHolderNameField',
                    errorId: 'accountHolderNameError',
                    errorTextId: 'accountHolderNameErrorText',
                    rules: {
                        required: true,
                        noWhitespaceOnly: true,
                        whitespaceError: 'Account holder name cannot contain only whitespace.',
                        pattern: /^[a-zA-Z\s]+$/,
                        patternError: 'Name cannot contain special characters.'
                    }
                },
                routingNumber: {
                    inputId: 'routingNumberField',
                    errorId: 'routingNumberError',
                    errorTextId: 'routingNumberErrorText',
                    rules: {
                        required: false,
                        pattern: /^\d+$/,
                        patternError: 'Please enter a valid routing number (digits only).',
                        maxLength: 50,
                        lengthError: 'Routing number cannot exceed 50 characters.',
                        digitsOnly: true
                    }
                }
            },

            // Show error message
            showError(input, errorDiv, errorText, message) {
                input.classList.remove('border-gray-300');
                input.classList.add('border-red-500');
                errorText.textContent = message;
                errorDiv.classList.remove('hidden');
                lucide.createIcons();
            },

            // Show success (green border temporarily)
            showSuccess(input) {
                input.classList.remove('border-red-500');
                input.classList.add('border-green-500');
                setTimeout(() => {
                    input.classList.remove('border-green-500');
                    input.classList.add('border-gray-300');
                }, 1000);
            },

            // Clear error
            clearError(input, errorDiv) {
                input.classList.remove('border-red-500', 'border-green-500');
                input.classList.add('border-gray-300');
                errorDiv.classList.add('hidden');
            },

            // Validate single field
            validate(fieldName) {
                const config = this.fields[fieldName];
                if (!config) return true;

                const input = document.getElementById(config.inputId);
                const errorDiv = document.getElementById(config.errorId);
                const errorText = document.getElementById(config.errorTextId);

                if (!input || !errorDiv || !errorText) return true;

                const value = input.value.trim();
                const rules = config.rules;

                // Clear previous errors
                this.clearError(input, errorDiv);

                // Required check
                if (rules.required && value.length === 0) {
                    return false; // HTML5 required will handle empty
                }

                // Optional field - empty is valid
                if (!rules.required && value.length === 0) {
                    return true;
                }

                // No whitespace only check
                if (rules.noWhitespaceOnly && /^\s+$/.test(value)) {
                    this.showError(input, errorDiv, errorText, rules.whitespaceError);
                    return false;
                }

                // Pattern validation
                if (rules.pattern && !rules.pattern.test(value)) {
                    this.showError(input, errorDiv, errorText, rules.patternError);
                    return false;
                }

                // Length validation
                if (rules.minLength && value.length < rules.minLength) {
                    this.showError(input, errorDiv, errorText, rules.lengthError);
                    return false;
                }
                if (rules.maxLength && value.length > rules.maxLength) {
                    this.showError(input, errorDiv, errorText, rules.lengthError);
                    return false;
                }

                // Valid - show success indicator
                if (rules.required) {
                    this.showSuccess(input);
                }
                return true;
            },

            // Setup event listeners for a field
            setupField(fieldName) {
                const config = this.fields[fieldName];
                if (!config) return;

                const input = document.getElementById(config.inputId);
                if (!input) return;

                // Input and blur events
                ['input', 'blur'].forEach(eventType => {
                    input.addEventListener(eventType, () => this.validate(fieldName));
                });

                // Digits only keypress restriction
                if (config.rules.digitsOnly) {
                    input.addEventListener('keypress', (e) => {
                        if (!/[0-9]/.test(e.key) && !['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight'].includes(e.key)) {
                            e.preventDefault();
                        }
                    });
                }
            },

            // Initialize all fields
            init() {
                Object.keys(this.fields).forEach(fieldName => {
                    this.setupField(fieldName);
                });
            },

            // Clear all errors
            clearAll() {
                Object.values(this.fields).forEach(config => {
                    const input = document.getElementById(config.inputId);
                    const errorDiv = document.getElementById(config.errorId);
                    if (input && errorDiv) {
                        this.clearError(input, errorDiv);
                    }
                });
            },

            // Validate all fields (for form submission)
            validateAll() {
                return Object.keys(this.fields).every(fieldName => this.validate(fieldName));
            }
        };

        // Initialize field validations
        function initFieldValidations() {
            FieldValidator.init();
        }

        // Individual validation functions (for backward compatibility)
        function validateAccountNumber() {
            return FieldValidator.validate('accountNumber');
        }

        function validateAccountHolderName() {
            return FieldValidator.validate('accountHolderName');
        }

        function validateRoutingNumber() {
            return FieldValidator.validate('routingNumber');
        }

        function editBankAccount(id, bankName, accountNumber, accountHolderName, routingNumber) {
            const form = document.getElementById('bankAccountForm');
            const modal = document.getElementById('bankAccountModal');
            
            // Set title and form action
            document.getElementById('modalTitle').textContent = 'Edit Bank Account';
            form.setAttribute('action', '?handler=UpdateBankAccount&accountId=' + id);
            
            // Fill form with data
            document.getElementById('accountIdField').value = id;
            document.getElementById('bankNameField').value = bankName;
            document.getElementById('accountHolderNameField').value = accountHolderName;
            document.getElementById('accountNumberField').value = accountNumber;
            document.getElementById('routingNumberField').value = routingNumber || '';
            document.getElementById('setAsPrimaryField').checked = false;
            
            // Show modal
            modal.classList.remove('hidden');
            lucide.createIcons();
            
            // Initialize bank name autocomplete helper for edit mode
            initBankNameAutocomplete();
            
            // Initialize field validations
            initFieldValidations();
            
            // Setup form validation for edit mode
            setupBankAccountFormValidation();
            
            // Check if existing bank name matches datalist and lock if it does
            setTimeout(() => {
                validateAndLockBankName();
            }, 100);
        }

        function closeBankAccountModal() {
            document.getElementById('bankAccountModal').classList.add('hidden');
            
            // Remove form validation handler
            const form = document.getElementById('bankAccountForm');
            if (form && formValidationHandler) {
                form.removeEventListener('submit', formValidationHandler, true);
                formValidationHandler = null;
            }
            
            // Reset lock state
            bankNameLocked = false;
            lastLockedValue = '';
            unlockBankName();
            hideBankNameWarning();
            
            // Clear all field errors
            clearAllFieldErrors();
        }
        
        function clearAllFieldErrors() {
            FieldValidator.clearAll();
        }

        // Withdrawal Modal Functions
        function openWithdrawalModal() {
            const modal = document.getElementById('withdrawalModal');
            const bankAccountSelect = document.getElementById('withdrawalBankAccount');
            
            // Reset form
            document.getElementById('withdrawalForm').reset();
            document.getElementById('withdrawalAmountInput').value = '';
            document.getElementById('remainingBalance').innerHTML = '';
            document.getElementById('amountError').classList.add('hidden');
            document.getElementById('submitWithdrawalBtn').disabled = true;
            
            // Auto-select primary bank account if exists
            if (bankAccountSelect) {
                const primaryOption = Array.from(bankAccountSelect.options).find(opt => 
                    opt.getAttribute('data-is-primary') === 'true'
                );
                if (primaryOption) {
                    bankAccountSelect.value = primaryOption.value;
                    // Trigger change event to update submit button state
                    bankAccountSelect.dispatchEvent(new Event('change'));
                }
            }
            
            modal.classList.remove('hidden');
            lucide.createIcons();
        }

        function closeWithdrawalModal() {
            document.getElementById('withdrawalModal').classList.add('hidden');
        }

        function closeConfirmationModal() {
            document.getElementById('confirmationModal').classList.add('hidden');
        }

        // Format number with commas (Vietnamese style - no decimals)
        function formatNumber(num) {
            // Convert to integer to remove any decimals
            const intNum = Math.floor(Number(num));
            // Format with comma as thousand separator
            return intNum.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        // Parse formatted number (uses comma separator)
        function parseFormattedNumber(str) {
            // Remove commas (thousand separator) and parse
            return parseInt(str.replace(/,/g, '').replace(/\./g, '')) || 0;
        }

        // Format and validate amount input
        function formatAndValidateAmount(input) {
            const availableBalance = parseFloat(document.getElementById('availableBalance').value);
            const minAmount = 50000;
            
            // Remove non-numeric characters except digits
            let value = input.value.replace(/[^\d]/g, '');
            const numericValue = parseInt(value) || 0;
            
            // Format with commas
            input.value = value ? formatNumber(numericValue) : '';
            
            // Update hidden field with numeric value
            document.getElementById('withdrawalAmountHidden').value = numericValue;
            
            const errorDiv = document.getElementById('amountError');
            const remainingDiv = document.getElementById('remainingBalance');
            const submitBtn = document.getElementById('submitWithdrawalBtn');
            const bankAccount = document.getElementById('withdrawalBankAccount');
            
            // Validation
            let isValid = true;
            let errorMessage = '';
            
            if (numericValue > 0) {
                if (numericValue < minAmount) {
                    errorMessage = `Amount must be at least ${formatNumber(minAmount)}₫`;
                    isValid = false;
                } else if (numericValue > availableBalance) {
                    const shortage = numericValue - availableBalance;
                    errorMessage = `Insufficient balance. You need ${formatNumber(shortage)}₫ more.`;
                    isValid = false;
                } else {
                    // Show remaining balance
                    const remaining = availableBalance - numericValue;
                    remainingDiv.innerHTML = `<span class="text-green-600">✓ Remaining after withdrawal: <strong>${formatNumber(remaining)}₫</strong></span>`;
                    remainingDiv.classList.remove('hidden');
                }
            } else {
                remainingDiv.innerHTML = '';
            }
            
            // Display error
            if (errorMessage) {
                errorDiv.textContent = errorMessage;
                errorDiv.classList.remove('hidden');
                remainingDiv.innerHTML = '';
            } else {
                errorDiv.classList.add('hidden');
            }
            
            // Enable/disable submit button
            submitBtn.disabled = !isValid || numericValue === 0 || !bankAccount.value;
        }

        // Enable submit button when bank account is selected
        document.getElementById('withdrawalBankAccount')?.addEventListener('change', function() {
            const amount = parseFormattedNumber(document.getElementById('withdrawalAmountInput').value);
            const submitBtn = document.getElementById('submitWithdrawalBtn');
            const availableBalance = parseFloat(document.getElementById('availableBalance').value);
            
            submitBtn.disabled = !this.value || amount < 50000 || amount > availableBalance;
        });

        // Confirmation before submit
        function confirmWithdrawal(event) {
            event.preventDefault();
            
            const amount = parseFormattedNumber(document.getElementById('withdrawalAmountInput').value);
            const availableBalance = parseFloat(document.getElementById('availableBalance').value);
            const bankAccount = document.getElementById('withdrawalBankAccount');
            const selectedOption = bankAccount.options[bankAccount.selectedIndex];
            
            if (!selectedOption || !selectedOption.value) {
                alert('Please select a bank account');
                return false;
            }
            
            const bankName = selectedOption.dataset.bankName;
            const last4 = selectedOption.dataset.last4;
            const remaining = availableBalance - amount;
            
            // Populate confirmation modal
            document.getElementById('confirmAmount').textContent = formatNumber(amount) + '₫';
            document.getElementById('confirmBank').textContent = bankName + ' - ****' + last4;
            document.getElementById('confirmCurrentBalance').textContent = formatNumber(availableBalance) + '₫';
            document.getElementById('confirmRemainingBalance').textContent = formatNumber(remaining) + '₫';
            
            // Show confirmation modal
            document.getElementById('confirmationModal').classList.remove('hidden');
            lucide.createIcons();
            
            return false;
        }

        // Proceed with withdrawal after confirmation
        function proceedWithdrawal() {
            const submitBtn = document.getElementById('submitWithdrawalBtn');
            const submitBtnText = document.getElementById('submitBtnText');
            const submitBtnLoader = document.getElementById('submitBtnLoader');
            
            // CRITICAL: Ensure hidden field has the correct numeric value before submit
            const displayInput = document.getElementById('withdrawalAmountInput');
            const hiddenInput = document.getElementById('withdrawalAmountHidden');
            const numericValue = parseFormattedNumber(displayInput.value);
            hiddenInput.value = numericValue;
            
            // Log for debugging
            console.log('Submitting withdrawal:', {
                display: displayInput.value,
                numeric: numericValue,
                hidden: hiddenInput.value
            });
            
            // Close confirmation modal
            closeConfirmationModal();
            
            // Show loading state
            submitBtn.disabled = true;
            submitBtnText.classList.add('hidden');
            submitBtnLoader.classList.remove('hidden');
            
            // Submit form
            document.getElementById('withdrawalForm').submit();
        }

        // Close modals on outside click
        document.getElementById('bankAccountModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeBankAccountModal();
            }
        });

        document.getElementById('withdrawalModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeWithdrawalModal();
            }
        });

        document.getElementById('confirmationModal')?.addEventListener('click', function(e) {
            if (e.target === this) {
                closeConfirmationModal();
            }
        });

        // ESC key to close modals
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeBankAccountModal();
                closeWithdrawalModal();
                closeConfirmationModal();
            }
        });

        // Make functions global
        window.openAddBankAccountModal = openAddBankAccountModal;
        window.editBankAccount = editBankAccount;
        window.closeBankAccountModal = closeBankAccountModal;
        window.openWithdrawalModal = openWithdrawalModal;
        window.closeWithdrawalModal = closeWithdrawalModal;
        window.closeConfirmationModal = closeConfirmationModal;
        window.formatAndValidateAmount = formatAndValidateAmount;
        window.confirmWithdrawal = confirmWithdrawal;
        window.proceedWithdrawal = proceedWithdrawal;

        @if (Model.Tab == "overview")
        {
            <text>
            // Revenue Chart
            const revenueCtx = document.getElementById('revenueChart').getContext('2d');
            new Chart(revenueCtx, {
                type: 'line',
                data: {
                    labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RevenueStats.ChartData.Select(x => x.Period))),
                    datasets: [{
                        label: 'Revenue',
                        data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RevenueStats.ChartData.Select(x => x.Revenue))),
                        borderColor: 'rgb(139, 92, 246)',
                        backgroundColor: 'rgba(139, 92, 246, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('vi-VN') + '₫';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Status Chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RevenueStats.StatusBreakdown.Select(x => x.Status))),
                    datasets: [{
                        data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.RevenueStats.StatusBreakdown.Select(x => x.Count))),
                        backgroundColor: [
                            'rgb(34, 197, 94)',
                            'rgb(59, 130, 246)', 
                            'rgb(251, 191, 36)',
                            'rgb(239, 68, 68)',
                            'rgb(139, 92, 246)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            </text>
        }
    </script>
}

