@page "/provider/order/{id:guid}"
@model ShareItFE.Pages.Provider.OrderDetailModel
@{
    ViewData["Title"] = Model.Order != null ? $"Order {Model.Order.OrderCode}" : "Order Details";

    Func<BusinessObject.Enums.OrderStatus, string> GetStatusBadgeClass = status =>
    {
        return status switch
        {
            BusinessObject.Enums.OrderStatus.pending => "status-pending",
            BusinessObject.Enums.OrderStatus.approved => "status-approved",
            BusinessObject.Enums.OrderStatus.in_transit => "status-in-transit",
            BusinessObject.Enums.OrderStatus.in_use => "status-in-use",
            BusinessObject.Enums.OrderStatus.returning => "status-returning",
            BusinessObject.Enums.OrderStatus.returned => "status-returned",
            BusinessObject.Enums.OrderStatus.returned_with_issue => "status-returned-with-issue",
            BusinessObject.Enums.OrderStatus.cancelled => "status-cancelled",
            _ => "status-default"
        };
    };

    Func<BusinessObject.Enums.OrderStatus, string> GetStatusText = status =>
    {
        return status switch
        {
            BusinessObject.Enums.OrderStatus.pending => "Pending",
            BusinessObject.Enums.OrderStatus.approved => "Approved", 
            BusinessObject.Enums.OrderStatus.in_transit => "Shipped",
            BusinessObject.Enums.OrderStatus.in_use => "In Use",
            BusinessObject.Enums.OrderStatus.returning => "Returning",
            BusinessObject.Enums.OrderStatus.returned => "Returned",
            BusinessObject.Enums.OrderStatus.returned_with_issue => "Returned with Issue",
            BusinessObject.Enums.OrderStatus.cancelled => "Cancelled",
            _ => status.ToString()
        };
    };

    Func<string, string> FormatPaymentMethod = method =>
    {
        return method?.ToLower() switch
        {
            "vnpay" => "Payment via VNPay",
            "sepay" => "Payment via SEPay",
            _ => method ?? "N/A"
        };
    };
}

@section Styles {
    <link rel="stylesheet" href="~/css/provider-order-details.css" asp-append-version="true" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
}

<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<div class="page-container">
    <div class="page-header">
        <a href="/provider/orders" class="back-link">
            <i data-lucide="arrow-left"></i>
            <span>Back to Orders</span>
        </a>
    </div>

    @* Success/Error Messages *@
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success" style="background-color: #d1fae5; border-left: 4px solid #10b981; color: #065f46; padding: 16px; margin-bottom: 20px; border-radius: 8px;">
            <i class="bi bi-check-circle-fill"></i>
            <strong>@TempData["SuccessMessage"]</strong>
        </div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger" style="background-color: #fee2e2; border-left: 4px solid #ef4444; color: #991b1b; padding: 16px; margin-bottom: 20px; border-radius: 8px;">
            <i class="bi bi-exclamation-triangle-fill"></i>
            <strong>@TempData["ErrorMessage"]</strong>
        </div>
    }

    @if (Model.Order != null)
    {
        <div class="order-detail-grid">
            
            <!-- Main Content -->
            <div class="main-content">
                    
                <!-- Order Header -->
                <div class="card">
                    <div class="order-title">
                        <div>
                            <h1>Order @Model.Order.OrderCode</h1>
                            <p>Placed on @Model.Order.OrderDate.ToString("MMMM dd, yyyy 'at' hh:mm tt")</p>
                        </div>
                        <span class="status-badge @GetStatusBadgeClass(Model.Order.Status)">
                            @GetStatusText(Model.Order.Status)
                        </span>
                    </div>
                </div>

                <!-- Order Progress -->
                <div class="card">
                    <h2 class="card-title">Order Progress</h2>
                        <div class="space-y-4">
                            <!-- Order Placed -->
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <div class="@(Model.Order.CreatedAt != DateTime.MinValue ? "bg-green-100" : "bg-gray-100") h-8 w-8 rounded-full flex items-center justify-center">
                                        <i data-lucide="check-circle" class="h-5 w-5 @(Model.Order.CreatedAt != DateTime.MinValue ? "text-green-600" : "text-gray-400")"></i>
                                    </div>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-gray-900">Order Placed</p>
                                    @if (Model.Order.CreatedAt != DateTime.MinValue)
                                    {
                                        <p class="text-xs text-gray-500">@Model.Order.CreatedAt.ToString("MMMM dd, yyyy 'at' hh:mm tt")</p>
                                    }
                                </div>
                            </div>

                            <!-- Payment Confirmed -->
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <div class="@(Model.Order.PaymentConfirmedDate.HasValue ? "bg-green-100" : "bg-gray-100") h-8 w-8 rounded-full flex items-center justify-center">
                                        <i data-lucide="credit-card" class="h-5 w-5 @(Model.Order.PaymentConfirmedDate.HasValue ? "text-green-600" : "text-gray-400")"></i>
                                    </div>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-gray-900">Payment Confirmed</p>
                                    @if (Model.Order.PaymentConfirmedDate.HasValue)
                                    {
                                        <p class="text-xs text-gray-500">@Model.Order.PaymentConfirmedDate.Value.ToString("MMMM dd, yyyy 'at' hh:mm tt")</p>
                                    }
                                    else
                                    {
                                        <p class="text-xs text-gray-400">Pending payment</p>
                                    }
                                </div>
                            </div>

                            <!-- Order Shipped -->
                            <div class="flex items-start">
                                <div class="flex-shrink-0">
                                    <div class="@(Model.Order.DeliveredDate.HasValue ? "bg-green-100" : "bg-gray-100") h-8 w-8 rounded-full flex items-center justify-center">
                                        <i data-lucide="truck" class="h-5 w-5 @(Model.Order.DeliveredDate.HasValue ? "text-green-600" : "text-gray-400")"></i>
                                    </div>
                                </div>
                                <div class="ml-4 flex-1">
                                    <p class="text-sm font-medium text-gray-900">Order Shipped</p>
                                    @if (Model.Order.DeliveredDate.HasValue)
                                    {
                                        <p class="text-xs text-gray-500">@Model.Order.DeliveredDate.Value.ToString("MMMM dd, yyyy 'at' hh:mm tt")</p>
                                    }
                                    else
                                    {
                                        <p class="text-xs text-gray-400">Not shipped yet</p>
                                    }
                                </div>
                            </div>

                            <!-- Delivered -->
                            @if (Model.Order.Status == BusinessObject.Enums.OrderStatus.in_use || 
                                 Model.Order.Status == BusinessObject.Enums.OrderStatus.returning || 
                                 Model.Order.Status == BusinessObject.Enums.OrderStatus.returned ||
                                 Model.Order.Status == BusinessObject.Enums.OrderStatus.returned_with_issue)
                            {
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <div class="bg-green-100 h-8 w-8 rounded-full flex items-center justify-center">
                                            <i data-lucide="package-check" class="h-5 w-5 text-green-600"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4 flex-1">
                                        <p class="text-sm font-medium text-gray-900">Delivered</p>
                                        <p class="text-xs text-gray-500">Successfully delivered to customer</p>
                                    </div>
                                </div>
                            }

                            <!-- Returning -->
                            @if (Model.Order.Status == BusinessObject.Enums.OrderStatus.returning || 
                                 Model.Order.Status == BusinessObject.Enums.OrderStatus.returned ||
                                 Model.Order.Status == BusinessObject.Enums.OrderStatus.returned_with_issue)
                            {
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <div class="@(Model.Order.Status == BusinessObject.Enums.OrderStatus.returning || Model.Order.Status == BusinessObject.Enums.OrderStatus.returned || Model.Order.Status == BusinessObject.Enums.OrderStatus.returned_with_issue ? "bg-green-100" : "bg-gray-100") h-8 w-8 rounded-full flex items-center justify-center">
                                            <i data-lucide="rotate-ccw" class="h-5 w-5 @(Model.Order.Status == BusinessObject.Enums.OrderStatus.returning || Model.Order.Status == BusinessObject.Enums.OrderStatus.returned || Model.Order.Status == BusinessObject.Enums.OrderStatus.returned_with_issue ? "text-green-600" : "text-gray-400")"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4 flex-1">
                                        <p class="text-sm font-medium text-gray-900">Returning</p>
                                        <p class="text-xs text-gray-500">Customer is returning items</p>
                                    </div>
                                </div>
                            }

                            <!-- Returned with Issue -->
                            @if (Model.Order.Status == BusinessObject.Enums.OrderStatus.returned_with_issue)
                            {
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <div class="bg-orange-100 h-8 w-8 rounded-full flex items-center justify-center">
                                            <i data-lucide="alert-triangle" class="h-5 w-5 text-orange-600"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4 flex-1">
                                        <p class="text-sm font-medium text-gray-900">Returned with Issue</p>
                                        <p class="text-xs text-orange-600">Items returned with violations reported</p>
                                    </div>
                                </div>
                            }

                            <!-- Returned - Only show if status is exactly "returned" (not "returned_with_issue") -->
                            @if (Model.Order.Status == BusinessObject.Enums.OrderStatus.returned)
                            {
                                <div class="flex items-start">
                                    <div class="flex-shrink-0">
                                        <div class="bg-green-100 h-8 w-8 rounded-full flex items-center justify-center">
                                            <i data-lucide="check-circle-2" class="h-5 w-5 text-green-600"></i>
                                        </div>
                                    </div>
                                    <div class="ml-4 flex-1">
                                        <p class="text-sm font-medium text-gray-900">Returned</p>
                                        <p class="text-xs text-gray-500">Successfully returned</p>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Order Items -->
                    <div class="card">
                        <h2 class="card-title">Order Items (@Model.Order.Items.Count)</h2>
                        <div class="item-list">
                            @foreach (var item in Model.Order.Items)
                            {
                                <div class="item-card">
                                    <a asp-page="/Products/Detail" asp-route-id="@item.ProductId" title="View product details">
                                        <img src="@(item.PrimaryImageUrl ?? "/images/placeholder.jpg")" 
                                             alt="@item.ProductName" 
                                             class="item-image"
                                             onerror="console.log('Image failed to load:', this.src); this.src='/images/placeholder.jpg';"
                                             onload="console.log('Image loaded successfully:', this.src);">
                                    </a>
                                    <div class="item-details">
                                        <h3>
                                            <a asp-page="/Products/Detail" asp-route-id="@item.ProductId" class="product-link">
                                                @item.ProductName
                                            </a>
                                        </h3>
                                        <div class="item-meta">
                                            @if (!string.IsNullOrEmpty(item.Size))
                                            {
                                                <span>Size: @item.Size</span>
                                            }
                                            @if (!string.IsNullOrEmpty(item.Color))
                                            {
                                                <span>Color: @item.Color</span>
                                            }
                                            <span>Quantity: @item.Quantity</span>
                                        </div>
                                    </div>
                                    <div class="item-price-actions">
                                        <div class="item-price">
                                            @if (item.TransactionType == BusinessObject.Enums.TransactionType.purchase)
                                            {
                                                <span>₫@item.PricePerDay.ToString("N0")</span>
                                                <small class="text-muted">(Purchase)</small>
                                            }
                                            else
                                            {
                                                <span>₫@item.PricePerDay.ToString("N0") / day</span>
                                                <small class="text-muted">(@(item.RentalDays ?? 0) days)</small>
                                                @if (item.DepositPerUnit > 0)
                                                {
                                                    <div style="font-size: 0.75rem; color: #ea6833; margin-top: 2px;">
                                                        +₫@((item.DepositPerUnit * item.Quantity).ToString("N0")) deposit
                                                    </div>
                                                }
                                            }
                                        </div>
                                        <button type="button" 
                                                class="btn btn-sm" 
                                                style="background-color: #8b5cf6; color: white; margin-top: 8px; font-size: 0.875rem; padding: 6px 12px;" 
                                                onclick="openFeedbackModal('@item.ProductId', '@Model.Order.CustomerId')">
                                            <i class="bi bi-chat-square-text"></i> View Feedback
                                        </button>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- Order Actions -->
                    <div class="card">
                        <h2 class="card-title">Order Actions</h2>
                        <div class="actions-grid">
                            <a href="/Contact" class="btn btn-primary">
                                <i class="bi bi-chat-dots"></i> Contact Support
                            </a>
                            
                            @* Report Issue / Edit Report Issue - Only enabled when status is "returning" or "returned_with_issue" *@
                            @if (Model.Order.Status == BusinessObject.Enums.OrderStatus.returning || Model.Order.Status == BusinessObject.Enums.OrderStatus.returned_with_issue)
                            {
                                @if (Model.HasExistingViolations)
                                {
                                    <a asp-page="/Provider/CreateViolation" asp-route-orderId="@Model.Order.Id" asp-route-edit="true" class="btn" style="background-color: #6366f1; color: white;">
                                        <i class="bi bi-pencil-square"></i> Edit Report Issue
                                    </a>
                                }
                                else
                                {
                                    <a asp-page="/Provider/CreateViolation" asp-route-orderId="@Model.Order.Id" class="btn" style="background-color: #fb923c; color: white;">
                                        <i class="bi bi-exclamation-triangle"></i> Report Issue
                                    </a>
                                }
                            }
                            else
                            {
                                @if (Model.HasExistingViolations)
                                {
                                    <button class="btn" style="background-color: #cbd5e0; color: #a0aec0; cursor: not-allowed;" disabled title="Only available when order status is 'Returning' or 'Returned with Issue'">
                                        <i class="bi bi-pencil-square"></i> Edit Report Issue
                                    </button>
                                }
                                else
                                {
                                    <button class="btn" style="background-color: #cbd5e0; color: #a0aec0; cursor: not-allowed;" disabled title="Only available when order status is 'Returning' or 'Returned with Issue'">
                                        <i class="bi bi-exclamation-triangle"></i> Report Issue
                                    </button>
                                }
                            }
                        </div>
                    </div>
                    
                </div>

            <!-- Sidebar -->
            <div class="sidebar">
                
                <!-- Order Summary -->
                <div class="card">
                    <h3 class="card-title">Order Summary</h3>
                        <div class="space-y-3">
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Subtotal</span>
                                <span class="text-gray-900">₫@Model.Order.Subtotal.ToString("N0")</span>
                            </div>
                            
                            @{
                                var hasRentalItems = Model.Order.Items.Any(item => item.TransactionType == BusinessObject.Enums.TransactionType.rental);
                            }
                            
                            @if (hasRentalItems)
                            {
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Rental Period</span>
                                    <span class="text-gray-900">@Model.Order.RentalStartDate.ToString("dd/MM/yyyy") - @Model.Order.RentalEndDate.ToString("dd/MM/yyyy")</span>
                                </div>
                            }
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Shipping</span>
                                <span class="text-gray-900">@(Model.Order.Shipping == 0 ? "FREE" : "₫" + Model.Order.Shipping.ToString("N0"))</span>
                            </div>
                            
                            <div class="flex justify-between text-sm">
                                <span class="text-gray-600">Discount</span>
                                <span class="text-gray-900">@(Model.Order.DiscountAmount > 0 ? "-₫" + Model.Order.DiscountAmount.ToString("N0") : "₫0")</span>
                            </div>
                            
                            @if (Model.Order.TotalDepositAmount > 0)
                            {
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-600">Security Deposit <span class="text-xs text-gray-400">(refundable)</span></span>
                                    <span class="text-gray-900">₫@Model.Order.TotalDepositAmount.ToString("N0")</span>
                                </div>
                            }
                            
                            @* Commission Information - Only visible to provider, staff, and admin *@
                            @if (User.IsInRole("provider") || User.IsInRole("staff") || User.IsInRole("admin"))
                            {
                                var hasRental = Model.Order.Items.Any(item => item.TransactionType == BusinessObject.Enums.TransactionType.rental);
                                var hasPurchase = Model.Order.Items.Any(item => item.TransactionType == BusinessObject.Enums.TransactionType.purchase);
                                
                                // Get commission rates from first item of each type
                                var rentalCommissionRate = hasRental ? Model.Order.Items.FirstOrDefault(i => i.TransactionType == BusinessObject.Enums.TransactionType.rental)?.RentalCommissionRate : null;
                                var purchaseCommissionRate = hasPurchase ? Model.Order.Items.FirstOrDefault(i => i.TransactionType == BusinessObject.Enums.TransactionType.purchase)?.PurchaseCommissionRate : null;
                                
                                // Calculate total commission amount
                                var totalCommission = Model.Order.Items.Sum(item => item.CommissionAmount);
                                
                                <div class="pt-3 border-t border-gray-200">
                                    <div class="text-xs font-semibold text-gray-700 mb-2">Platform Commission</div>
                                    
                                    @if (hasRental && rentalCommissionRate.HasValue)
                                    {
                                        <div class="flex justify-between text-sm">
                                            <span class="text-gray-600">Rental Commission Rate</span>
                                            <span class="text-gray-900">@((rentalCommissionRate.Value * 100).ToString("0.##"))%</span>
                                        </div>
                                    }
                                    
                                    @if (hasPurchase && purchaseCommissionRate.HasValue)
                                    {
                                        <div class="flex justify-between text-sm">
                                            <span class="text-gray-600">Purchase Commission Rate</span>
                                            <span class="text-gray-900">@((purchaseCommissionRate.Value * 100).ToString("0.##"))%</span>
                                        </div>
                                    }
                                    
                                    <div class="flex justify-between text-sm font-medium mt-2">
                                        <span class="text-gray-700">Total Commission</span>
                                        <span class="text-red-600">-₫@totalCommission.ToString("N0")</span>
                                    </div>
                                </div>
                            }
                            
                            <div class="pt-3 border-t border-gray-200">
                                <div class="flex justify-between">
                                    <span class="text-base font-semibold text-gray-900">Total <span class="text-sm font-normal text-gray-500">(incl. deposit, incl. commission)</span></span>
                                    <span class="text-base font-bold text-purple-600">₫@Model.Order.TotalAmount.ToString("N0")</span>
                                </div>
                            </div>
                        </div>
                    </div>

                <!-- Shipping Address -->
                <div class="card">
                    <h3 class="card-title">
                        <i data-lucide="map-pin"></i>
                        Shipping Address
                    </h3>
                        <div class="space-y-2 text-sm">
                            <p class="font-medium text-gray-900">@Model.Order.ShippingAddress.FullName</p>
                            <p class="text-gray-600">@Model.Order.ShippingAddress.Address</p>
                            <p class="text-gray-600">@Model.Order.ShippingAddress.Email</p>
                            <p class="text-gray-600 flex items-center">
                                <i data-lucide="phone" class="h-4 w-4 mr-2"></i>
                                @Model.Order.ShippingAddress.Phone
                            </p>
                        </div>
                    </div>

                <!-- Payment Method -->
                <div class="card">
                    <h3 class="card-title">
                        <i data-lucide="credit-card"></i>
                        Payment Method
                    </h3>
                        <p class="text-sm text-gray-600">@FormatPaymentMethod(Model.Order.PaymentMethod)</p>
                        @if (!string.IsNullOrEmpty(Model.Order.PaymentMethod) && Model.Order.PaymentMethod.ToLower().Contains("4567"))
                        {
                            <p class="text-xs text-gray-500 mt-1">Credit Card ending in 4567</p>
                        }
                    </div>

                <!-- Special Instructions -->
                @if (!string.IsNullOrEmpty(Model.Order.Notes))
                {
                    <div class="card">
                        <h3 class="card-title">Special Instructions</h3>
                            <p class="text-sm text-gray-600">@Model.Order.Notes</p>
                        </div>
                    }
                    
                </div>
            </div>
    }
    else
    {
        <div class="card text-center">
            <i data-lucide="alert-circle" style="width: 3rem; height: 3rem; margin: 0 auto 1rem; color: #9ca3af;"></i>
            <h3 style="font-size: 1.125rem; font-weight: 500; color: #111827; margin-bottom: 0.5rem;">Order Not Found</h3>
            <p style="font-size: 0.875rem; color: #6b7280; margin-bottom: 1rem;">The requested order could not be found.</p>
            <a href="/provider/orders" class="btn btn-primary">
                Back to Orders
            </a>
        </div>
    }
    
</div>

<!-- Feedback Modal -->
<div id="feedbackModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);">
    <div class="modal-content" style="background-color: #fefefe; margin: 5% auto; padding: 0; border-radius: 12px; width: 90%; max-width: 800px; max-height: 80vh; overflow-y: auto; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
        <div style="padding: 20px; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 10; border-radius: 12px 12px 0 0;">
            <h2 style="margin: 0; font-size: 1.5rem; font-weight: 600; color: #111827;">Product Feedback</h2>
            <button onclick="closeFeedbackModal()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 6px; transition: all 0.2s;">
                <i class="bi bi-x-lg"></i>
            </button>
        </div>
        <div id="feedbackContent" style="padding: 20px;">
            <div style="text-align: center; padding: 40px 20px;">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p style="margin-top: 16px; color: #6b7280;">Loading feedback...</p>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        lucide.createIcons();

        let currentProductId = null;
        let currentCustomerId = null;

        function openFeedbackModal(productId, customerId) {
            console.log('=== Opening Feedback Modal ===');
            console.log('Product ID:', productId);
            console.log('Customer ID:', customerId);
            
            currentProductId = productId;
            currentCustomerId = customerId;
            document.getElementById('feedbackModal').style.display = 'block';
            loadFeedback(productId, customerId);
        }

        function closeFeedbackModal() {
            document.getElementById('feedbackModal').style.display = 'none';
            currentProductId = null;
            currentCustomerId = null;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('feedbackModal');
            if (event.target == modal) {
                closeFeedbackModal();
            }
        }

        async function loadFeedback(productId, customerId) {
            const contentDiv = document.getElementById('feedbackContent');
            
            try {
                console.log('=== Loading Feedback ===');
                console.log('Product ID:', productId);
                console.log('Customer ID:', customerId);
                console.log('API Base URL:', '@Model.ApiBaseUrl');
                
                // Lấy TẤT CẢ feedback của sản phẩm, sau đó filter theo customerId
                const apiUrl = `@Model.ApiBaseUrl/feedbacks/product/${productId}`;
                console.log('Full API URL:', apiUrl);
                
                const response = await fetch(apiUrl + '?page=1&pageSize=100');
                console.log('Response:', response);
                
                console.log('Response status:', response.status);
                console.log('Response ok:', response.ok);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`Failed to load feedback: ${response.status} - ${errorText}`);
                }

                const data = await response.json();
                console.log('Response data:', data);
                
                // API trả về format: { message: "...", data: { items: [...] } }
                let allFeedbacks = data.data?.items || [];
                console.log('All feedbacks:', allFeedbacks);
                
                // Filter chỉ lấy feedback của customer này
                const feedbacks = allFeedbacks.filter(f => f.customerId === customerId);
                console.log('Filtered feedbacks for customer', customerId, ':', feedbacks);

                if (feedbacks.length === 0) {
                    contentDiv.innerHTML = `
                        <div style="text-align: center; padding: 40px 20px;">
                            <i class="bi bi-chat-square-text" style="font-size: 3rem; color: #d1d5db;"></i>
                            <p style="margin-top: 16px; color: #6b7280; font-size: 1rem;">This customer hasn't left any feedback for this product yet.</p>
                        </div>
                    `;
                    return;
                }

                let html = '<div style="display: flex; flex-direction: column; gap: 16px;">';
                
                feedbacks.forEach(feedback => {
                    const stars = '★'.repeat(feedback.rating) + '☆'.repeat(5 - feedback.rating);
                    
                    // Format date - use submittedAt field from API
                    let date = 'Unknown date';
                    try {
                        const dateField = feedback.submittedAt || feedback.createdAt;
                        if (dateField) {
                            const dateObj = new Date(dateField);
                            
                            if (!isNaN(dateObj.getTime())) {
                                // Format: 24 Nov, 2025 (short format like Product Detail)
                                const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 
                                              'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
                                const day = dateObj.getDate();
                                const month = months[dateObj.getMonth()];
                                const year = dateObj.getFullYear();
                                date = `${day} ${month}, ${year}`;
                            }
                        }
                    } catch (e) {
                        console.error('Error parsing date:', e);
                    }

                    html += `
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 16px; background: #f9fafb;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                                <div>
                                    <div style="color: #fbbf24; font-size: 1.25rem; margin-bottom: 4px;">${stars}</div>
                                    <div style="font-weight: 600; color: #111827; font-size: 0.95rem;">${feedback.customerName || 'Anonymous'}</div>
                                    <div style="color: #6b7280; font-size: 0.875rem;">${date}</div>
                                </div>
                            </div>
                            <p style="color: #374151; line-height: 1.6; margin: 0;">${feedback.comment || 'No comment provided.'}</p>
                            ${feedback.providerResponse ? `
                                <div style="margin-top: 12px; padding: 12px; background: #ede9fe; border-left: 3px solid #8b5cf6; border-radius: 4px;">
                                    <div style="font-weight: 600; color: #6b21a8; font-size: 0.875rem; margin-bottom: 4px;">
                                        <i class="bi bi-reply-fill"></i> Provider Response
                                    </div>
                                    <p style="color: #5b21b6; margin: 0; font-size: 0.875rem;">${feedback.providerResponse}</p>
                                </div>
                            ` : ''}
                        </div>
                    `;
                });

                html += '</div>';
                contentDiv.innerHTML = html;

            } catch (error) {
                console.error('Error loading feedback:', error);
                contentDiv.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px;">
                        <i class="bi bi-exclamation-triangle" style="font-size: 3rem; color: #ef4444;"></i>
                        <p style="margin-top: 16px; color: #ef4444; font-size: 1rem;">Failed to load feedback.</p>
                        <p style="margin-top: 8px; color: #6b7280; font-size: 0.875rem;">${error.message}</p>
                        <button onclick="loadFeedback('${productId}', '${customerId}')" style="margin-top: 16px; padding: 8px 16px; background: #8b5cf6; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Try Again
                        </button>
                    </div>
                `;
            }
        }
    </script>
}

