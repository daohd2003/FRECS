@page
@model ShareItFE.Pages.Provider.ApplyModel
@{
    ViewData["Title"] = "Become a provider";
}

<section class="container py-5">
    <h1 class="mb-4">Become a provider</h1>

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success">@Model.SuccessMessage</div>
    }
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">@Model.ErrorMessage</div>
    }

    <style>
        .help-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #64b5f6;
            color: #ffffff;
            text-align: center;
            line-height: 18px;
            font-weight: 500;
            font-size: 12px;
            cursor: help;
            margin-left: 6px;
            transition: all 0.2s ease;
        }

            .help-icon:hover {
                background: #42a5f5;
                transform: scale(1.1);
            }

        /* Đảm bảo verification div luôn ẩn khi mới load trang */
        .verification-hidden {
            display: none !important;
        }

        /* Compact form layout */
        .form-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @@media (min-width: 768px) { .form-grid { grid-template-columns: 1fr 1fr; } }
        .panel-soft {
            padding: 12px; border: 1px dashed #90caf9; border-radius: 8px;
            background: #eaf4ff;
        }
    </style>

    <form method="post" class="card p-4" enctype="multipart/form-data" data-api-root="@Model.ApiBaseUrl" id="applyForm" autocomplete="off">
        <div class="form-grid mb-3">
            <div>
                <label asp-for="Input.BusinessName" class="form-label"></label>
                <span class="help-icon" data-bs-toggle="tooltip" title="Store/brand name visible to customers. e.g., 'Chic Dress Rental'.">?</span>
                <input asp-for="Input.BusinessName" class="form-control" placeholder="e.g., Chic Dress Rental" />
                <span asp-validation-for="Input.BusinessName" class="text-danger"></span>
            </div>
            <div>
                <label asp-for="Input.TaxId" class="form-label"></label>
                <span class="help-icon" data-bs-toggle="tooltip" title="Tax ID (10 digits for businesses) or Personal ID (12 digits for individuals). If you're an individual, enter 12 digits.">?</span>
                <input asp-for="Input.TaxId" id="taxIdInput" class="form-control" placeholder="e.g., 0312345678 or 0790xxxxxxx" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');" value="" />
                <small id="taxIdError" class="text-danger" style="display:none;">Tax ID must be exactly 10 or 12 digits.</small>
            </div>
        </div>

        <div id="individual-verification" class="mb-3 verification-hidden panel-soft">
            <div class="mb-3">
                <label for="idCardFront" class="form-label fw-bold">Front side CCCD <span class="text-danger">*</span></label>
                <div class="d-flex align-items-center gap-2">
                    <input type="file" id="idCardFront" name="Input.IdCardFrontImage" class="visually-hidden" accept="image/*" />
                    <button type="button" id="btnFrontPick" class="btn btn-outline-secondary btn-sm">Choose file</button>
                    <span id="frontFileName" class="text-muted small">No file chosen</span>
                </div>
                <div class="mt-2">
                    <img id="idCardFrontPreview" alt="Front preview" style="max-width: 260px; max-height: 160px; display: none; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" />
                </div>
                <small class="text-muted d-block mt-1">JPG/PNG only</small>
        </div>
            <div class="mb-3">
                <label for="idCardBack" class="form-label fw-bold">Back side CCCD <span class="text-danger">*</span></label>
                <div class="d-flex align-items-center gap-2">
                    <input type="file" id="idCardBack" name="Input.IdCardBackImage" class="visually-hidden" accept="image/*" />
                    <button type="button" id="btnBackPick" class="btn btn-outline-secondary btn-sm">Choose file</button>
                    <span id="backFileName" class="text-muted small">No file chosen</span>
                </div>
                <div class="mt-2">
                    <img id="idCardBackPreview" alt="Back preview" style="max-width: 260px; max-height: 160px; display: none; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" />
                </div>
                <small class="text-muted d-block mt-1">JPG/PNG only</small>
            </div>
        </div>

        <div id="imagePreviewModal" class="modal" tabindex="-1" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,.7); align-items: center; justify-content: center;">
            <div style="position: relative; max-width: 90%; max-height: 90%;">
                <img id="previewLargeImage" src="" alt="Preview" style="width: 100%; height: auto; max-height: 85vh; object-fit: contain; border-radius: 4px;" />
                <button type="button" id="closePreviewModal" class="btn btn-light" style="position: absolute; top: -12px; right: -12px;">&times;</button>
            </div>
        </div>

        <div class="mb-3">
            <label asp-for="Input.ContactPhone" class="form-label"></label>
            <span class="help-icon" data-bs-toggle="tooltip" title="Contact phone number for orders/support. Use an active mobile number.">?</span>
            <input asp-for="Input.ContactPhone" class="form-control" placeholder="e.g., +84 901 234 567" />
        </div>
        <div class="mb-3">
            <label asp-for="Input.Notes" class="form-label"></label>
            <span class="help-icon" data-bs-toggle="tooltip" title="Short description about your store, style, or special requirements (max 500 characters).">?</span>
            <textarea asp-for="Input.Notes" class="form-control" rows="3" placeholder="e.g., Specialize in evening gowns sizes S–L; rush delivery available"></textarea>
        </div>
        <button type="submit" class="btn btn-primary">Submit Application</button>
    </form>

    <div id="toast-mini" style="position: fixed; top: 16px; right: 16px; z-index: 10500; display: flex; flex-direction: column; gap: 8px;"></div>

    <script>
        // Đợi DOM load xong trước khi chạy
        function initializeVerification() {
            // Thử tìm element với multiple selectors
            let taxIdInput = document.getElementById('taxIdInput');
            if (!taxIdInput) {
                taxIdInput = document.querySelector('input[name="Input.TaxId"]');
            }
            if (!taxIdInput) {
                taxIdInput = document.querySelector('input[name="TaxId"]');
            }
            
            let verificationDiv = document.getElementById('individual-verification');
            let idCardFront = document.getElementById('idCardFront');
            let idCardBack = document.getElementById('idCardBack');
            let idCardFrontPreview = document.getElementById('idCardFrontPreview');
            let idCardBackPreview = document.getElementById('idCardBackPreview');
            const btnFrontPick = document.getElementById('btnFrontPick');
            const btnBackPick = document.getElementById('btnBackPick');
            const frontFileName = document.getElementById('frontFileName');
            const backFileName = document.getElementById('backFileName');
            const taxIdError = document.getElementById('taxIdError');
            const submitBtn = document.querySelector('#applyForm button[type="submit"]');
            const previewModal = document.getElementById('imagePreviewModal');
            const previewLargeImage = document.getElementById('previewLargeImage');
            const closePreviewModal = document.getElementById('closePreviewModal');

            if (!taxIdInput) {
                console.error('❌ TaxId input not found!');
                return;
            }

            // Nếu không tìm thấy khối xác minh, tạo động và chèn ngay sau nhóm TaxId
            if (!verificationDiv) {
                const taxGroup = taxIdInput.closest('.mb-3') || taxIdInput.parentElement;
                const container = document.createElement('div');
                container.id = 'individual-verification';
                container.className = 'mb-3 verification-hidden panel-soft';
                container.innerHTML = `
                    <div class="mb-3">
                        <label for="idCardFront" class="form-label fw-bold">Front side CCCD <span class="text-danger">*</span></label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="file" id="idCardFront" name="Input.IdCardFrontImage" class="visually-hidden" accept="image/*" />
                            <button type="button" id="btnFrontPick" class="btn btn-outline-secondary btn-sm">Choose file</button>
                            <span id="frontFileName" class="text-muted small">No file chosen</span>
                        </div>
                        <div class="mt-2">
                            <img id="idCardFrontPreview" alt="Front preview" style="max-width: 260px; max-height: 160px; display: none; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" />
                        </div>
                        <small class="text-muted d-block mt-1">JPG/PNG only</small>
                    </div>
                    <div class="mb-3">
                        <label for="idCardBack" class="form-label fw-bold">Back side CCCD <span class="text-danger">*</span></label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="file" id="idCardBack" name="Input.IdCardBackImage" class="visually-hidden" accept="image/*" />
                            <button type="button" id="btnBackPick" class="btn btn-outline-secondary btn-sm">Choose file</button>
                            <span id="backFileName" class="text-muted small">No file chosen</span>
                        </div>
                        <div class="mt-2">
                            <img id="idCardBackPreview" alt="Back preview" style="max-width: 260px; max-height: 160px; display: none; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" />
                        </div>
                        <small class="text-muted d-block mt-1">JPG/PNG only</small>
                    </div>
                `;
                if (taxGroup && taxGroup.parentNode) {
                    taxGroup.parentNode.insertBefore(container, taxGroup.nextSibling);
                    verificationDiv = container;
                    idCardFront = container.querySelector('#idCardFront');
                    idCardBack = container.querySelector('#idCardBack');
                    idCardFrontPreview = container.querySelector('#idCardFrontPreview');
                    idCardBackPreview = container.querySelector('#idCardBackPreview');
                    // also rebind buttons and file name labels
                    window.setTimeout(() => {
                        const _btnF = container.querySelector('#btnFrontPick');
                        const _btnB = container.querySelector('#btnBackPick');
                        const _labF = container.querySelector('#frontFileName');
                        const _labB = container.querySelector('#backFileName');
                        if (_btnF && idCardFront) _btnF.addEventListener('click', () => idCardFront.click());
                        if (_btnB && idCardBack) _btnB.addEventListener('click', () => idCardBack.click());
                        if (idCardFront) idCardFront.addEventListener('change', () => { _labF.textContent = idCardFront.files?.[0]?.name || 'No file chosen'; });
                        if (idCardBack) idCardBack.addEventListener('change', () => { _labB.textContent = idCardBack.files?.[0]?.name || 'No file chosen'; });
                    }, 0);
                } else {
                    console.error('❌ Unable to insert verification container');
                }
            }

            // Biến để theo dõi xem user đã tương tác chưa
            let userHasInteracted = false;

            // XÓA CỨNG giá trị Tax ID khi trang load để tránh autofill
            taxIdInput.value = '';
            
            // Đảm bảo ẩn thông báo và error message khi trang load
            if (verificationDiv) {
                verificationDiv.classList.add('verification-hidden');
                verificationDiv.style.display = 'none';
            }
            if (taxIdError) {
                taxIdError.style.display = 'none';
            }
            if (submitBtn) {
                submitBtn.disabled = false;
            }
            
            // Xóa nhiều lần để chắc chắn chống autofill (browser có thể autofill sau một chút)
            const clearAutofill = () => {
                if (!userHasInteracted && taxIdInput.value) {
                    taxIdInput.value = '';
                    if (verificationDiv) {
                        verificationDiv.classList.add('verification-hidden');
                        verificationDiv.style.display = 'none';
                    }
                    if (taxIdError) {
                        taxIdError.style.display = 'none';
                    }
                }
            };
            
            setTimeout(clearAutofill, 50);
            setTimeout(clearAutofill, 100);
            setTimeout(clearAutofill, 200);
            setTimeout(clearAutofill, 500);

            // Hàm để cập nhật visibility
            function updateVerificationVisibility(isUserInteraction = false) {
                if (isUserInteraction) {
                    userHasInteracted = true;
                }

                // Chỉ hiển thị nếu user đã thực sự tương tác
                if (!userHasInteracted) {
                    // Luôn ẩn tất cả thông báo cho đến khi user tương tác
                    if (verificationDiv) {
                        verificationDiv.classList.add('verification-hidden');
                        verificationDiv.style.display = 'none';
                    }
                    if (taxIdError) {
                        taxIdError.style.display = 'none';
                    }
                    if (submitBtn) {
                        submitBtn.disabled = false;
                    }
                    return;
                }

                const taxIdValue = taxIdInput.value || '';
                const taxIdClean = taxIdValue.replace(/\D/g, '');

                // Chỉ hiển thị error message khi:
                // 1. Có giá trị (không rỗng)
                // 2. Giá trị không phải 10 hoặc 12 số
                const isEmpty = taxIdClean.length === 0;
                const isValid = taxIdClean.length === 10 || taxIdClean.length === 12;
                const shouldShowError = !isEmpty && !isValid;
                
                if (taxIdError) {
                    taxIdError.style.display = shouldShowError ? 'block' : 'none';
                }
                
                // Chỉ disable submit button khi có giá trị SAI (không disable khi rỗng)
                if (submitBtn) {
                    submitBtn.disabled = shouldShowError;
                }
                
                if (verificationDiv) {
                    if (taxIdClean.length === 12) {
                        verificationDiv.classList.remove('verification-hidden');
                        verificationDiv.style.display = 'block';
                    } else {
                        verificationDiv.classList.add('verification-hidden');
                        verificationDiv.style.display = 'none';
                        if (idCardFront) idCardFront.value = '';
                        if (idCardBack) idCardBack.value = '';
                        const _lf = document.getElementById('frontFileName');
                        const _lb = document.getElementById('backFileName');
                        if (_lf) _lf.textContent = 'No file chosen';
                        if (_lb) _lb.textContent = 'No file chosen';
                    }
                }
            }

            // Đánh dấu user interaction khi họ focus vào field
            taxIdInput.addEventListener('focus', function() {
                userHasInteracted = true;
            });

            // Đánh dấu user interaction khi họ gõ phím
            taxIdInput.addEventListener('keydown', function() {
                userHasInteracted = true;
            });

            // Gán nhiều listener để chắc chắn bắt được thay đổi
            taxIdInput.addEventListener('input', function(e) {
                updateVerificationVisibility(userHasInteracted);
            });
            taxIdInput.addEventListener('change', function(e) {
                updateVerificationVisibility(userHasInteracted);
            });
            taxIdInput.addEventListener('keyup', function(e) {
                updateVerificationVisibility(true); // keyup luôn là user interaction
            });

            // Initialize tooltips
            if (window.bootstrap) {
                var triggers = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                triggers.forEach(function (el) { new bootstrap.Tooltip(el); });
            }

            function bindPreview(inputEl, previewEl) {
                if (!inputEl || !previewEl) return;
                inputEl.addEventListener('change', function () {
                    const file = this.files && this.files[0];
                    if (file) {
                        const url = URL.createObjectURL(file);
                        previewEl.src = url;
                        previewEl.style.display = 'inline-block';
                    } else {
                        previewEl.src = '';
                        previewEl.style.display = 'none';
                    }
                });
                previewEl.addEventListener('click', function () {
                    if (!previewEl.src) return;
                    previewLargeImage.src = previewEl.src;
                    previewModal.style.display = 'flex';
                });
            }

            bindPreview(idCardFront, idCardFrontPreview);
            bindPreview(idCardBack, idCardBackPreview);

            // file pickers (static)
            if (btnFrontPick && idCardFront) btnFrontPick.addEventListener('click', () => idCardFront.click());
            if (btnBackPick && idCardBack) btnBackPick.addEventListener('click', () => idCardBack.click());
            if (idCardFront && frontFileName) idCardFront.addEventListener('change', () => { frontFileName.textContent = idCardFront.files?.[0]?.name || 'No file chosen'; });
            if (idCardBack && backFileName) idCardBack.addEventListener('change', () => { backFileName.textContent = idCardBack.files?.[0]?.name || 'No file chosen'; });

            if (closePreviewModal) {
                closePreviewModal.addEventListener('click', function () {
                    previewModal.style.display = 'none';
                    previewLargeImage.src = '';
                });
            }

            previewModal?.addEventListener('click', function (e) {
                if (e.target === previewModal) {
                    previewModal.style.display = 'none';
                    previewLargeImage.src = '';
                }
            });

            // Compact toast helpers
            function showToastMini(type, message) {
                const container = document.getElementById('toast-mini');
                const el = document.createElement('div');
                el.style.cssText = 'min-width:260px; max-width:420px; padding:10px 12px; border-radius:6px; color:#fff; font-size:13px; box-shadow:0 6px 16px rgba(0,0,0,.2); opacity:0; transform: translateY(-6px); transition: all .2s;';
                el.style.background = type === 'success' ? '#2e7d32' : (type === 'warning' ? '#ed6c02' : '#c62828');
                el.textContent = message;
                container.appendChild(el);
                requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transform = 'translateY(0)'; });
                setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(-6px)'; setTimeout(() => el.remove(), 200); }, 3500);
            }

            // AJAX submit to keep previews/files without page refresh
            const form = document.getElementById('applyForm');
            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                try {
                    const fd = new FormData(form); // includes antiforgery token if present and all inputs/files

                    // Gather values
                    const businessName = (document.querySelector('input[name="Input.BusinessName"]')?.value || '').trim();
                    const taxValRaw = (document.querySelector('#taxIdInput')?.value || '').trim();
                    const taxValClean = taxValRaw.replace(/\D/g, '');
                    const contactPhone = (document.querySelector('input[name="Input.ContactPhone"]')?.value || '').trim();
                    const contactPhoneClean = contactPhone.replace(/\D/g, '');
                    const frontFile = idCardFront?.files?.[0];
                    const backFile = idCardBack?.files?.[0];

                    // Client-side validation rules
                    const errors = [];
                    if (!businessName) errors.push('Business name is required.');
                    if (!taxValClean) errors.push('Tax ID is required.');
                    if (taxValClean && taxValClean.length !== 10 && taxValClean.length !== 12) errors.push('Tax ID must be 10 or 12 digits.');
                    if (!contactPhone) errors.push('Contact phone is required.');
                    else if (contactPhoneClean.length !== 10) errors.push('Contact phone must be 10 digits.');
                    if (taxValClean.length === 12) {
                        if (!frontFile) errors.push('Front ID image is required for 12-digit Personal ID.');
                        if (!backFile) errors.push('Back ID image is required for 12-digit Personal ID.');
                    }

                    if (errors.length > 0) {
                        // Show first error prominently; the rest as additional toasts
                        showToastMini('error', errors[0]);
                        for (let i = 1; i < Math.min(errors.length, 3); i++) {
                            setTimeout(() => showToastMini('error', errors[i]), 250 * i);
                        }
                        // Focus first invalid field
                        if (!businessName) document.querySelector('input[name="Input.BusinessName"]').focus();
                        else if (!taxValClean || (taxValClean.length !== 10 && taxValClean.length !== 12)) document.querySelector('#taxIdInput').focus();
                        else if (!contactPhone) document.querySelector('input[name="Input.ContactPhone"]').focus();
                        else if (taxValClean.length === 12 && !frontFile) document.querySelector('#btnFrontPick')?.focus();
                        else if (taxValClean.length === 12 && !backFile) document.querySelector('#btnBackPick')?.focus();
                        return;
                    }

                    const res = await fetch(window.location.pathname + '?handler=Ajax', {
                        method: 'POST',
                        body: fd
                    });

                    if (!res.ok) {
                        const text = await res.text();
                        showToastMini('error', `Submit failed: ${text.substring(0, 180)}`);
                        return;
                    }

                    showToastMini('success', 'Application submitted. Please check your email regularly for updates on your provider application.');
                } catch (err) {
                    showToastMini('error', `Error: ${err?.message || err}`);
                }
            });
        }

        // Chạy khi DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeVerification);
        } else {
            initializeVerification();
        }
    </script>
</section>


