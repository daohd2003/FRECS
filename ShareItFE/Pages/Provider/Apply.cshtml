@page
@model ShareItFE.Pages.Provider.ApplyModel
@{
    ViewData["Title"] = "Become a provider";
}

<section class="container py-5">
    <h1 class="mb-4">Become a provider</h1>

    @if (!string.IsNullOrEmpty(Model.SuccessMessage))
    {
        <div class="alert alert-success">@Model.SuccessMessage</div>
    }
    @if (!string.IsNullOrEmpty(Model.ErrorMessage))
    {
        <div class="alert alert-danger">@Model.ErrorMessage</div>
    }

    <style>
        .help-icon {
            display: inline-block;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #64b5f6;
            color: #ffffff;
            text-align: center;
            line-height: 18px;
            font-weight: 500;
            font-size: 12px;
            cursor: help;
            margin-left: 6px;
            transition: all 0.2s ease;
        }

            .help-icon:hover {
                background: #42a5f5;
                transform: scale(1.1);
            }

        /* Ensure verification div is always hidden when page loads */
        .verification-hidden {
            display: none !important;
        }

        /* Compact form layout */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        @@media (min-width: 768px) {
            .form-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        .panel-soft {
            padding: 12px;
            border: 1px dashed #90caf9;
            border-radius: 8px;
            background: #eaf4ff;
        }
    </style>

    <form method="post" class="card p-4" enctype="multipart/form-data" data-api-root="@Model.ApiBaseUrl" id="applyForm" autocomplete="off">
        <div class="form-grid mb-3">
            <div>
                <label asp-for="Input.BusinessName" class="form-label"></label>
                <span class="help-icon" data-bs-toggle="tooltip" title="Store/brand name visible to customers. e.g., 'Chic Dress Rental'.">?</span>
                <input asp-for="Input.BusinessName" class="form-control" placeholder="e.g., Chic Dress Rental" />
                <span asp-validation-for="Input.BusinessName" class="text-danger"></span>
            </div>
            <div>
                <label asp-for="Input.TaxId" class="form-label"></label>
                <span class="help-icon" data-bs-toggle="tooltip" title="Tax ID (10 digits for businesses) or Personal ID (12 digits for individuals). If you're an individual, enter 12 digits.">?</span>
                <input asp-for="Input.TaxId" id="taxIdInput" class="form-control" placeholder="e.g., 0312345678 or 0790xxxxxxx" autocomplete="new-password" readonly onfocus="this.removeAttribute('readonly');" value="" />
                <small id="taxIdError" class="text-danger" style="display:none;">Tax ID must be exactly 10 or 12 digits.</small>
                <small id="cccdIdHelper" class="text-success fw-bold" style="display:none;">‚úÖ Verified CCCD ID: <span id="cccdIdValue"></span></small>
            </div>
        </div>

        <div id="individual-verification" class="mb-3 verification-hidden panel-soft">
            <div class="mb-3">
                <label for="idCardFront" class="form-label fw-bold">Front side CCCD <span class="text-danger">*</span></label>
                <div class="d-flex align-items-center gap-2">
                    <input type="file" id="idCardFront" name="Input.IdCardFrontImage" class="visually-hidden" accept="image/*" />
                    <button type="button" id="btnFrontPick" class="btn btn-outline-secondary btn-sm">Choose file</button>
                    <span id="frontFileName" class="text-muted small">No file chosen</span>
                    <button type="button" id="btnVerifyFront" class="btn btn-primary btn-sm" style="display:none;">Verify</button>
                    <span id="frontVerifyStatus" class="small"></span>
                </div>
                <div class="mt-2">
                    <img id="idCardFrontPreview" alt="Front preview" style="max-width: 260px; max-height: 160px; display: none; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" />
                </div>
                <div id="frontVerificationResult" class="mt-2" style="display:none;"></div>
                <small class="text-muted d-block mt-1">JPG/PNG only</small>

                <!-- CCCD Photo Tips -->
                <div class="mt-2 p-2" style="background: #fff3e0; border-left: 3px solid #ff9800; font-size: 11px;">
                    <strong>üì∑ Tips for High-Quality CCCD Photos:</strong>
                    <div class="mt-1" style="line-height: 1.6;">
                        ‚úì Place CCCD on dark background (easier to detect)<br>
                        ‚úì Take photo at 90¬∞ angle (not tilted)<br>
                        ‚úì Natural lighting, avoid glare/reflections<br>
                        ‚úì Text and photo must be sharp, not blurry
                    </div>
                </div>
            </div>
            <div class="mb-3">
                <label for="idCardBack" class="form-label fw-bold">Back side CCCD <span class="text-danger">*</span></label>
                <div class="d-flex align-items-center gap-2">
                    <input type="file" id="idCardBack" name="Input.IdCardBackImage" class="visually-hidden" accept="image/*" />
                    <button type="button" id="btnBackPick" class="btn btn-outline-secondary btn-sm">Choose file</button>
                    <span id="backFileName" class="text-muted small">No file chosen</span>
                    <button type="button" id="btnVerifyBack" class="btn btn-primary btn-sm" style="display:none;">Verify</button>
                    <span id="backVerifyStatus" class="small"></span>
                </div>
                <div class="mt-2">
                    <img id="idCardBackPreview" alt="Back preview" style="max-width: 260px; max-height: 160px; display: none; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" />
                </div>
                <div id="backVerificationResult" class="mt-2" style="display:none;"></div>
                <small class="text-muted d-block mt-1">JPG/PNG only</small>

                <!-- CCCD Back Tips -->
                <div class="mt-2 p-2" style="background: #e8f5e9; border-left: 3px solid #4caf50; font-size: 11px;">
                    <strong>‚ÑπÔ∏è CCCD Back Side Notes:</strong>
                    <div class="mt-1" style="line-height: 1.6;">
                        ‚Ä¢ New CCCD (with chip): Only fingerprint, OCR may be 0% ‚Üí OK<br>
                        ‚Ä¢ Old CCCD: Has address, issue date ‚Üí Easier to detect<br>
                        ‚Ä¢ Still need clear photo, good lighting
                    </div>
                </div>
            </div>

            <!-- SELFIE CAPTURE SECTION -->
            <div class="mb-3">
                <label class="form-label fw-bold">Take Selfie for Face Matching <span class="text-danger">*</span></label>
                <p class="text-muted small mb-2">üì∏ Take a clear photo of your face to verify it matches your CCCD.</p>

                <!-- Camera View with Overlay Guide -->
                <div id="cameraContainer" style="display: none;">
                    <div style="position: relative; display: inline-block; max-width: 500px; width: 100%;">
                        <!-- Video Stream (mirrored for natural viewing) -->
                        <video id="selfieVideo" autoplay playsinline style="width: 100%; border: 2px solid #64b5f6; border-radius: 8px; background: #000; display: block; transform: scaleX(-1);"></video>

                        <!-- Face Oval Guide Overlay -->
                        <svg id="faceGuideOverlay" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                            <!-- Dark semi-transparent background -->
                            <defs>
                                <mask id="faceMask">
                                    <rect width="100%" height="100%" fill="white" />
                                    <!-- Oval cutout for face -->
                                    <ellipse cx="50%" cy="45%" rx="35%" ry="42%" fill="black" />
                                </mask>
                            </defs>
                            <rect width="100%" height="100%" fill="rgba(0,0,0,0.5)" mask="url(#faceMask)" />

                            <!-- Face guide oval border -->
                            <ellipse cx="50%" cy="45%" rx="35%" ry="42%"
                                     fill="none"
                                     stroke="#4caf50"
                                     stroke-width="3"
                                     stroke-dasharray="10,5"
                                     opacity="0.8">
                                <animate attributeName="stroke-dashoffset" from="0" to="30" dur="2s" repeatCount="indefinite" />
                            </ellipse>
                        </svg>

                        <!-- Instructions Overlay -->
                        <div style="position: absolute; top: 10px; left: 50%; transform: translateX(-50%);
                                    background: rgba(0,0,0,0.7); color: white; padding: 8px 16px;
                                    border-radius: 20px; font-size: 13px; font-weight: 500; text-align: center;
                                    box-shadow: 0 2px 8px rgba(0,0,0,0.3); white-space: nowrap;">
                            üë§ ƒê·∫∑t m·∫∑t v√†o khung b·∫ßu d·ª•c
                        </div>

                        <!-- Tips at bottom -->
                        <div style="position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%);
                                    background: rgba(76,175,80,0.9); color: white; padding: 6px 12px;
                                    border-radius: 15px; font-size: 11px; text-align: center;
                                    box-shadow: 0 2px 6px rgba(0,0,0,0.3);">
                            üí° Good lighting ‚Ä¢ Look straight ‚Ä¢ No glasses
                        </div>
                    </div>

                    <canvas id="selfieCanvas" style="display: none;"></canvas>

                    <div class="mt-2">
                        <button type="button" id="btnCaptureSelfie" class="btn btn-success btn-sm">üì∏ Capture Photo</button>
                        <button type="button" id="btnStopCamera" class="btn btn-secondary btn-sm">‚ùå Close Camera</button>
                        <span id="countdownTimer" class="ms-3 fw-bold text-primary" style="display: none; font-size: 18px;"></span>
                    </div>

                    <!-- Quality Tips -->
                    <div class="mt-2 p-2" style="background: #e3f2fd; border-radius: 6px; font-size: 12px;">
                        <strong>üìã Quality Photo Checklist:</strong>
                        <div class="mt-1">
                            ‚úì Face takes ~70% of frame<br>
                            ‚úì Even lighting (not too dark/bright)<br>
                            ‚úì Look directly at camera<br>
                            ‚úì No sunglasses, mask, or hat
                        </div>
                    </div>
                </div>

                <!-- Captured Photo Preview -->
                <div id="selfiePreviewContainer" style="display: none;">
                    <img id="selfiePreview" alt="Selfie preview" style="max-width: 500px; width: 100%; border: 2px solid #4caf50; border-radius: 8px;" />
                    <div class="mt-2">
                        <button type="button" id="btnRetakeSelfie" class="btn btn-warning btn-sm">üîÑ Retake Photo</button>
                        <span id="selfieStatus" class="ms-2 small text-success">‚úÖ Selfie captured</span>
                    </div>
                    <!-- Face Matching Result -->
                    <div id="faceMatchResult" class="mt-3" style="display: none;">
                        <div class="alert" id="faceMatchAlert" role="alert">
                            <div class="d-flex align-items-center">
                                <span id="faceMatchIcon" class="me-2"></span>
                                <div>
                                    <div id="faceMatchMessage" class="fw-bold"></div>
                                    <div id="faceMatchScore" class="small"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Start Camera Button -->
                <div id="startCameraContainer">
                    <button type="button" id="btnStartCamera" class="btn btn-primary btn-sm">üì∑ Open Camera</button>
                    <input type="file" id="selfieImageInput" name="Input.SelfieImage" class="visually-hidden" accept="image/*" />
                </div>

                <small class="text-muted d-block mt-1">
                    üí° Tips: Look directly at camera, good lighting, no glasses/hat
                </small>
            </div>
        </div>

        <div id="imagePreviewModal" class="modal" tabindex="-1" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,.7); align-items: center; justify-content: center;">
            <div style="position: relative; max-width: 90%; max-height: 90%;">
                <img id="previewLargeImage" src="" alt="Preview" style="width: 100%; height: auto; max-height: 85vh; object-fit: contain; border-radius: 4px;" />
                <button type="button" id="closePreviewModal" class="btn btn-light" style="position: absolute; top: -12px; right: -12px;">&times;</button>
            </div>
        </div>

        <div class="mb-3">
            <label asp-for="Input.ContactPhone" class="form-label"></label>
            <span class="help-icon" data-bs-toggle="tooltip" title="Contact phone number for orders/support. Use an active mobile number.">?</span>
            <input asp-for="Input.ContactPhone" class="form-control" placeholder="e.g., +84 901 234 567" />
        </div>
        <div class="mb-3">
            <label asp-for="Input.Notes" class="form-label"></label>
            <span class="help-icon" data-bs-toggle="tooltip" title="Short description about your store, style, or special requirements (max 500 characters).">?</span>
            <textarea asp-for="Input.Notes" class="form-control" rows="3" placeholder="e.g., Specialize in evening gowns sizes S‚ÄìL; rush delivery available"></textarea>
        </div>

        <!-- BUSINESS LICENSE SECTION (For 10-digit Tax ID) -->
        <div id="business-license-section" class="mb-3 verification-hidden panel-soft" style="display: none;">
            <div class="mb-3">
                <label for="businessLicenseImage" class="form-label fw-bold">
                    Business License <span class="text-danger">*</span>
                </label>
                <span class="help-icon" data-bs-toggle="tooltip"
                      title="Upload image or PDF of valid business license">?</span>

                <div class="d-flex align-items-center gap-2">
                    <input type="file" id="businessLicenseImage"
                           name="Input.BusinessLicenseImage"
                           class="visually-hidden"
                           accept="image/*,application/pdf" />
                    <button type="button" id="btnBusinessLicensePick"
                            class="btn btn-outline-secondary btn-sm">
                        Choose file
                    </button>
                    <span id="businessLicenseFileName" class="text-muted small">No file chosen</span>
                </div>

                <div class="mt-2">
                    <img id="businessLicensePreview" alt="Business License preview"
                         style="max-width: 400px; max-height: 300px; display: none;
                                border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" />
                </div>

                <small class="text-muted d-block mt-1">JPG/PNG/PDF accepted</small>

                <!-- Business License Tips -->
                <div class="mt-2 p-2" style="background: #fff3e0; border-left: 3px solid #ff9800; font-size: 11px;">
                    <strong>üìã Business License Requirements:</strong>
                    <div class="mt-1" style="line-height: 1.6;">
                        ‚úì License must be valid and current<br>
                        ‚úì Clear photo/scan with all information visible<br>
                        ‚úì Tax ID on license must match the ID you entered<br>
                        ‚úì Business name must match the name above
                    </div>
                </div>
            </div>
        </div>

        <!-- Privacy Policy Agreement -->
        <div class="mb-3">
            <div class="form-check">
                <input type="checkbox" class="form-check-input"
                       id="privacyPolicyAgreed"
                       name="Input.PrivacyPolicyAgreed"
                       required
                       oninvalid="this.setCustomValidity('You must agree to the privacy policy to continue.')"
                       oninput="this.setCustomValidity('')" />
                <label class="form-check-label" for="privacyPolicyAgreed">
                    I agree to the
                    <a href="#" onclick="event.preventDefault(); openPolicyModal();" class="text-primary">
                        privacy policy
                    </a>
                    <span class="text-danger">*</span>
                </label>
            </div>
            <small class="text-muted">
                You must agree to the privacy policy to continue
            </small>
        </div>

        <button type="submit" class="btn btn-primary">Submit Application</button>
    </form>

    <!-- Policy Modal -->
    <div id="policyModal" class="hidden" style="position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.5); z-index: 99999; display: none; align-items: center; justify-content: center; padding: 1rem;">
        <div style="background: white; border-radius: 0.75rem; max-width: 56rem; width: 100%; max-height: 90vh; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); margin: auto;">
            <div style="padding: 1.5rem; border-bottom: 1px solid #e5e7eb; display: flex; justify-content: space-between; align-items: center;">
                <h3 style="font-size: 1.25rem; font-weight: 700; color: #111827; margin: 0;">Privacy Policy</h3>
                <button type="button" onclick="closePolicyModal()" style="color: #9ca3af; cursor: pointer; background: none; border: none; font-size: 1.5rem; line-height: 1;">
                    &times;
                </button>
            </div>
            <div id="policyContent" style="padding: 1.5rem; overflow-y: auto; max-height: calc(90vh - 140px);">
                <div style="display: flex; justify-content: center; align-items: center; padding: 2rem;">
                    <div style="width: 2rem; height: 2rem; border: 2px solid #0d6efd; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <span style="margin-left: 0.75rem; color: #6b7280;">Loading policy...</span>
                </div>
            </div>
            <div style="padding: 1rem; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 0.75rem;">
                <button type="button" onclick="closePolicyModal()" style="padding: 0.5rem 1.5rem; background: #e5e7eb; color: #374151; border-radius: 0.375rem; border: none; cursor: pointer;">
                    Close
                </button>
                <button type="button" onclick="acceptPolicy()" style="padding: 0.5rem 1.5rem; background: #0d6efd; color: white; border-radius: 0.375rem; border: none; cursor: pointer;">
                    I Accept
                </button>
            </div>
        </div>
    </div>
    <style>
        @@keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>

    <div id="toast-mini" style="position: fixed; top: 16px; right: 16px; z-index: 10500; display: flex; flex-direction: column; gap: 8px;"></div>

    <script>
        // ============================================
        // GLOBAL HELPER FUNCTIONS
        // ============================================

        // Toast notification helper (global scope)
        function showToastMini(type, message) {
            const container = document.getElementById('toast-mini');
            if (!container) {
                console.warn('Toast container not found');
                return;
            }
            const el = document.createElement('div');
            el.style.cssText = 'min-width:260px; max-width:420px; padding:10px 12px; border-radius:6px; color:#fff; font-size:13px; box-shadow:0 6px 16px rgba(0,0,0,.2); opacity:0; transform: translateY(-6px); transition: all .2s;';
            el.style.background = type === 'success' ? '#2e7d32' : (type === 'warning' ? '#ed6c02' : '#c62828');
            el.textContent = message;
            container.appendChild(el);
            requestAnimationFrame(() => { el.style.opacity = '1'; el.style.transform = 'translateY(0)'; });
            setTimeout(() => { el.style.opacity = '0'; el.style.transform = 'translateY(-6px)'; setTimeout(() => el.remove(), 200); }, 3500);
        }

        // ============================================
        // CCCD VERIFICATION LOGIC
        // ============================================

        // Global variable to store verified CCCD ID
        let verifiedCccdId = null;

        // Wait for DOM to load before running
        function initializeVerification() {
            // Try to find element with multiple selectors
            let taxIdInput = document.getElementById('taxIdInput');
            if (!taxIdInput) {
                taxIdInput = document.querySelector('input[name="Input.TaxId"]');
            }
            if (!taxIdInput) {
                taxIdInput = document.querySelector('input[name="TaxId"]');
            }

            let verificationDiv = document.getElementById('individual-verification');
            let idCardFront = document.getElementById('idCardFront');
            let idCardBack = document.getElementById('idCardBack');
            let idCardFrontPreview = document.getElementById('idCardFrontPreview');
            let idCardBackPreview = document.getElementById('idCardBackPreview');
            const btnFrontPick = document.getElementById('btnFrontPick');
            const btnBackPick = document.getElementById('btnBackPick');
            const frontFileName = document.getElementById('frontFileName');
            const backFileName = document.getElementById('backFileName');
            const taxIdError = document.getElementById('taxIdError');
            const submitBtn = document.querySelector('#applyForm button[type="submit"]');
            const previewModal = document.getElementById('imagePreviewModal');
            const previewLargeImage = document.getElementById('previewLargeImage');
            const closePreviewModal = document.getElementById('closePreviewModal');

            if (!taxIdInput) {
                console.error('‚ùå TaxId input not found!');
                return;
            }

            // If verification block not found, create dynamically and insert after TaxId group
            if (!verificationDiv) {
                const taxGroup = taxIdInput.closest('.mb-3') || taxIdInput.parentElement;
                const container = document.createElement('div');
                container.id = 'individual-verification';
                container.className = 'mb-3 verification-hidden panel-soft';
                container.innerHTML = `
                    <div class="mb-3">
                        <label for="idCardFront" class="form-label fw-bold">Front side CCCD <span class="text-danger">*</span></label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="file" id="idCardFront" name="Input.IdCardFrontImage" class="visually-hidden" accept="image/*" />
                            <button type="button" id="btnFrontPick" class="btn btn-outline-secondary btn-sm">Choose file</button>
                            <span id="frontFileName" class="text-muted small">No file chosen</span>
                        </div>
                        <div class="mt-2">
                            <img id="idCardFrontPreview" alt="Front preview" style="max-width: 260px; max-height: 160px; display: none; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" />
                        </div>
                        <small class="text-muted d-block mt-1">JPG/PNG only</small>
                    </div>
                    <div class="mb-3">
                        <label for="idCardBack" class="form-label fw-bold">Back side CCCD <span class="text-danger">*</span></label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="file" id="idCardBack" name="Input.IdCardBackImage" class="visually-hidden" accept="image/*" />
                            <button type="button" id="btnBackPick" class="btn btn-outline-secondary btn-sm">Choose file</button>
                            <span id="backFileName" class="text-muted small">No file chosen</span>
                        </div>
                        <div class="mt-2">
                            <img id="idCardBackPreview" alt="Back preview" style="max-width: 260px; max-height: 160px; display: none; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;" />
                        </div>
                        <small class="text-muted d-block mt-1">JPG/PNG only</small>
                    </div>
                `;
                if (taxGroup && taxGroup.parentNode) {
                    taxGroup.parentNode.insertBefore(container, taxGroup.nextSibling);
                    verificationDiv = container;
                    idCardFront = container.querySelector('#idCardFront');
                    idCardBack = container.querySelector('#idCardBack');
                    idCardFrontPreview = container.querySelector('#idCardFrontPreview');
                    idCardBackPreview = container.querySelector('#idCardBackPreview');
                    // also rebind buttons and file name labels
                    window.setTimeout(() => {
                        const _btnF = container.querySelector('#btnFrontPick');
                        const _btnB = container.querySelector('#btnBackPick');
                        const _labF = container.querySelector('#frontFileName');
                        const _labB = container.querySelector('#backFileName');
                        if (_btnF && idCardFront) _btnF.addEventListener('click', () => idCardFront.click());
                        if (_btnB && idCardBack) _btnB.addEventListener('click', () => idCardBack.click());
                        if (idCardFront) idCardFront.addEventListener('change', () => { _labF.textContent = idCardFront.files?.[0]?.name || 'No file chosen'; });
                        if (idCardBack) idCardBack.addEventListener('change', () => { _labB.textContent = idCardBack.files?.[0]?.name || 'No file chosen'; });
                    }, 0);
                } else {
                    console.error('‚ùå Unable to insert verification container');
                }
            }

            // Variable to track if user has interacted
            let userHasInteracted = false;

            // CLEAR Tax ID value when page loads to prevent autofill
            taxIdInput.value = '';

            // Ensure notifications and error messages are hidden when page loads
            if (verificationDiv) {
                verificationDiv.classList.add('verification-hidden');
                verificationDiv.style.display = 'none';
            }
            if (taxIdError) {
                taxIdError.style.display = 'none';
            }
            if (submitBtn) {
                submitBtn.disabled = false;
            }

            // Clear multiple times to ensure autofill is prevented (browser may autofill after a bit)
            const clearAutofill = () => {
                if (!userHasInteracted && taxIdInput.value) {
                    taxIdInput.value = '';
                    if (verificationDiv) {
                        verificationDiv.classList.add('verification-hidden');
                        verificationDiv.style.display = 'none';
                    }
                    if (taxIdError) {
                        taxIdError.style.display = 'none';
                    }
                }
            };

            setTimeout(clearAutofill, 50);
            setTimeout(clearAutofill, 100);
            setTimeout(clearAutofill, 200);
            setTimeout(clearAutofill, 500);

            // Function to update visibility
            function updateVerificationVisibility(isUserInteraction = false) {
                if (isUserInteraction) {
                    userHasInteracted = true;
                }

                // Only show if user has actually interacted
                if (!userHasInteracted) {
                    // Always hide all notifications until user interacts
                    if (verificationDiv) {
                        verificationDiv.classList.add('verification-hidden');
                        verificationDiv.style.display = 'none';
                    }
                    if (taxIdError) {
                        taxIdError.style.display = 'none';
                    }
                    if (submitBtn) {
                        submitBtn.disabled = false;
                    }
                    return;
                }

                const taxIdValue = taxIdInput.value || '';
                const taxIdClean = taxIdValue.replace(/\D/g, '');

                // Only show error message when:
                // 1. Has value (not empty)
                // 2. Value is not 10 or 12 digits
                const isEmpty = taxIdClean.length === 0;
                const isValid = taxIdClean.length === 10 || taxIdClean.length === 12;
                const shouldShowError = !isEmpty && !isValid;

                if (taxIdError) {
                    taxIdError.style.display = shouldShowError ? 'block' : 'none';
                }

                // Ch·ªâ disable submit button khi c√≥ gi√° tr·ªã SAI (kh√¥ng disable khi r·ªóng)
                if (submitBtn) {
                    submitBtn.disabled = shouldShowError;
                }

                // Get business license section and selfie section
                const businessLicenseSection = document.getElementById('business-license-section');
                const selfieSection = document.querySelector('#individual-verification > div:last-of-type'); // Selfie is last div

                if (verificationDiv) {
                    if (taxIdClean.length === 12) {
                        // INDIVIDUAL (12 digits) - Show CCCD + Selfie
                        verificationDiv.classList.remove('verification-hidden');
                        verificationDiv.style.display = 'block';

                        // Show selfie section, hide business license
                        if (selfieSection) selfieSection.style.display = 'block';
                        if (businessLicenseSection) {
                            businessLicenseSection.classList.add('verification-hidden');
                            businessLicenseSection.style.display = 'none';
                        }

                        console.log('‚úì Individual mode (12 digits): CCCD + Selfie');
                    } else if (taxIdClean.length === 10) {
                        // BUSINESS (10 digits) - Show CCCD + Business License
                        verificationDiv.classList.remove('verification-hidden');
                        verificationDiv.style.display = 'block';

                        // Hide selfie section, show business license
                        if (selfieSection) selfieSection.style.display = 'none';
                        if (businessLicenseSection) {
                            businessLicenseSection.classList.remove('verification-hidden');
                            businessLicenseSection.style.display = 'block';
                        }

                        console.log('‚úì Business mode (10 digits): CCCD + Business License');
                    } else {
                        // INVALID or EMPTY - Hide everything
                        verificationDiv.classList.add('verification-hidden');
                        verificationDiv.style.display = 'none';
                        if (businessLicenseSection) {
                            businessLicenseSection.classList.add('verification-hidden');
                            businessLicenseSection.style.display = 'none';
                        }

                        // Clear files
                        if (idCardFront) idCardFront.value = '';
                        if (idCardBack) idCardBack.value = '';
                        const businessLicenseInput = document.getElementById('businessLicenseImage');
                        if (businessLicenseInput) businessLicenseInput.value = '';

                        const _lf = document.getElementById('frontFileName');
                        const _lb = document.getElementById('backFileName');
                        const _lbl = document.getElementById('businessLicenseFileName');
                        if (_lf) _lf.textContent = 'No file chosen';
                        if (_lb) _lb.textContent = 'No file chosen';
                        if (_lbl) _lbl.textContent = 'No file chosen';
                    }
                }
            }

            // Mark user interaction when they focus on field
            taxIdInput.addEventListener('focus', function() {
                userHasInteracted = true;
            });

            // Mark user interaction when they press keys
            taxIdInput.addEventListener('keydown', function() {
                userHasInteracted = true;
            });

            // Assign multiple listeners to ensure changes are captured
            taxIdInput.addEventListener('input', function(e) {
                updateVerificationVisibility(userHasInteracted);

                // Real-time validation: Check if Tax ID matches CCCD ID
                const taxValClean = e.target.value.replace(/\D/g, '');
                const cccdIdHelper = document.getElementById('cccdIdHelper');

                if (verifiedCccdId && taxValClean.length === 12) {
                    if (taxValClean === verifiedCccdId) {
                        // Match! Show green
                        if (cccdIdHelper) {
                            cccdIdHelper.className = 'text-success fw-bold';
                            cccdIdHelper.innerHTML = `‚úÖ Verified CCCD ID: <span>${verifiedCccdId}</span> (Match!)`;
                        }
                    } else {
                        // Not match! Show red warning
                        if (cccdIdHelper) {
                            cccdIdHelper.className = 'text-danger fw-bold';
                            cccdIdHelper.innerHTML = `‚ùå Tax ID does NOT match CCCD ID: <span>${verifiedCccdId}</span>`;
                        }
                    }
                }
            });
            taxIdInput.addEventListener('change', function(e) {
                updateVerificationVisibility(userHasInteracted);
            });
            taxIdInput.addEventListener('keyup', function(e) {
                updateVerificationVisibility(true); // keyup lu√¥n l√† user interaction
            });

            // Initialize tooltips
            if (window.bootstrap) {
                var triggers = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                triggers.forEach(function (el) { new bootstrap.Tooltip(el); });
            }

            function bindPreview(inputEl, previewEl) {
                if (!inputEl || !previewEl) return;
                inputEl.addEventListener('change', function () {
                    const file = this.files && this.files[0];
                    if (file) {
                        const url = URL.createObjectURL(file);
                        previewEl.src = url;
                        previewEl.style.display = 'inline-block';
                    } else {
                        previewEl.src = '';
                        previewEl.style.display = 'none';
                    }
                });
                previewEl.addEventListener('click', function () {
                    if (!previewEl.src) return;
                    previewLargeImage.src = previewEl.src;
                    previewModal.style.display = 'flex';
                });
            }

            bindPreview(idCardFront, idCardFrontPreview);
            bindPreview(idCardBack, idCardBackPreview);

            // Business License file picker
            const btnBusinessLicensePick = document.getElementById('btnBusinessLicensePick');
            const businessLicenseInput = document.getElementById('businessLicenseImage');
            const businessLicenseFileName = document.getElementById('businessLicenseFileName');
            const businessLicensePreview = document.getElementById('businessLicensePreview');

            if (btnBusinessLicensePick && businessLicenseInput) {
                btnBusinessLicensePick.addEventListener('click', () => businessLicenseInput.click());
            }

            if (businessLicenseInput && businessLicenseFileName) {
                businessLicenseInput.addEventListener('change', function() {
                    const file = this.files && this.files[0];
                    if (file) {
                        businessLicenseFileName.textContent = file.name;

                        // Show preview if image
                        if (file.type.startsWith('image/') && businessLicensePreview) {
                            const url = URL.createObjectURL(file);
                            businessLicensePreview.src = url;
                            businessLicensePreview.style.display = 'inline-block';
                        } else {
                            // PDF or other - hide preview
                            if (businessLicensePreview) {
                                businessLicensePreview.style.display = 'none';
                            }
                        }
                    } else {
                        businessLicenseFileName.textContent = 'No file chosen';
                        if (businessLicensePreview) {
                            businessLicensePreview.style.display = 'none';
                        }
                    }
                });
            }

            // Preview click for business license
            if (businessLicensePreview) {
                businessLicensePreview.addEventListener('click', function() {
                    if (!businessLicensePreview.src) return;
                    previewLargeImage.src = businessLicensePreview.src;
                    previewModal.style.display = 'flex';
                });
            }

            // file pickers (static)
            if (btnFrontPick && idCardFront) btnFrontPick.addEventListener('click', () => idCardFront.click());
            if (btnBackPick && idCardBack) btnBackPick.addEventListener('click', () => idCardBack.click());
            if (idCardFront && frontFileName) {
                idCardFront.addEventListener('change', () => {
                    frontFileName.textContent = idCardFront.files?.[0]?.name || 'No file chosen';
                    // Show verify button when file is selected
                    const btnVerifyFront = document.getElementById('btnVerifyFront');
                    if (idCardFront.files && idCardFront.files[0]) {
                        if (btnVerifyFront) btnVerifyFront.style.display = 'inline-block';
                        // Auto verify after short delay
                        setTimeout(() => verifyCccdImage('front'), 500);
                    } else {
                        if (btnVerifyFront) btnVerifyFront.style.display = 'none';
                    }
                });
            }
            if (idCardBack && backFileName) {
                idCardBack.addEventListener('change', () => {
                    backFileName.textContent = idCardBack.files?.[0]?.name || 'No file chosen';
                    // Show verify button when file is selected
                    const btnVerifyBack = document.getElementById('btnVerifyBack');
                    if (idCardBack.files && idCardBack.files[0]) {
                        if (btnVerifyBack) btnVerifyBack.style.display = 'inline-block';
                        // Auto verify after short delay
                        setTimeout(() => verifyCccdImage('back'), 500);
                    } else {
                        if (btnVerifyBack) btnVerifyBack.style.display = 'none';
                    }
                });
            }

            if (closePreviewModal) {
                closePreviewModal.addEventListener('click', function () {
                    previewModal.style.display = 'none';
                    previewLargeImage.src = '';
                });
            }

            previewModal?.addEventListener('click', function (e) {
                if (e.target === previewModal) {
                    previewModal.style.display = 'none';
                    previewLargeImage.src = '';
                }
            });

            // CCCD Verification function
            async function verifyCccdImage(side) {
                const isBack = side === 'back';
                const fileInput = isBack ? idCardBack : idCardFront;
                const statusSpan = isBack ? document.getElementById('backVerifyStatus') : document.getElementById('frontVerifyStatus');
                const resultDiv = isBack ? document.getElementById('backVerificationResult') : document.getElementById('frontVerificationResult');
                const verifyBtn = isBack ? document.getElementById('btnVerifyBack') : document.getElementById('btnVerifyFront');

                if (!fileInput || !fileInput.files || !fileInput.files[0]) {
                    return;
                }

                const file = fileInput.files[0];

                // Show loading status
                if (statusSpan) {
                    statusSpan.innerHTML = '<span class="text-info">‚è≥ Verifying...</span>';
                }
                if (verifyBtn) {
                    verifyBtn.disabled = true;
                    verifyBtn.textContent = 'Verifying...';
                }

                try {
                    const formData = new FormData();
                    formData.append('image', file);

                    const apiRoot = document.getElementById('applyForm').dataset.apiRoot || '';
                    const response = await fetch(`${apiRoot}/api/ekyc/verify-single`, {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    });

                    const result = await response.json();

                    if (response.ok && result.data && result.data.isValid) {
                        // Success - show extracted data
                        const data = result.data;
                        if (statusSpan) {
                            statusSpan.innerHTML = '<span class="text-success">‚úì Verified</span>';
                        }

                        let resultHtml = '<div class="alert alert-success p-2"><strong>‚úì CCCD Verified Successfully</strong><br>';
                        if (data.idNumber) resultHtml += `<small>ID: ${data.idNumber}</small><br>`;
                        if (data.fullName) resultHtml += `<small>Name: ${data.fullName}</small><br>`;
                        if (data.dateOfBirth) resultHtml += `<small>DOB: ${data.dateOfBirth}</small><br>`;
                        if (data.sex) resultHtml += `<small>Sex: ${data.sex}</small><br>`;
                        if (data.confidence) resultHtml += `<small>Confidence: ${(data.confidence * 100).toFixed(1)}%</small>`;
                        resultHtml += '</div>';

                        if (resultDiv) {
                            resultDiv.innerHTML = resultHtml;
                            resultDiv.style.display = 'block';
                        }

                        // Store verified CCCD ID for validation (FRONT side only)
                        if (data.idNumber && data.idNumber.length === 12 && !isBack) {
                            verifiedCccdId = data.idNumber; // Save for validation
                            console.log('‚úÖ CCCD ID saved for validation:', verifiedCccdId);

                            // Show verified CCCD ID helper
                            const cccdIdHelper = document.getElementById('cccdIdHelper');
                            const cccdIdValue = document.getElementById('cccdIdValue');
                            if (cccdIdHelper && cccdIdValue) {
                                cccdIdValue.textContent = verifiedCccdId;
                                cccdIdHelper.style.display = 'block';
                            }

                            // Auto-fill TaxId if empty
                            const taxInput = document.getElementById('taxIdInput');
                            if (taxInput && !taxInput.value) {
                                taxInput.value = data.idNumber;
                                userHasInteracted = true;
                                updateVerificationVisibility(true);
                            }
                        }

                        showToastMini('success', `${isBack ? 'Back' : 'Front'} side verified successfully`);
                    } else {
                        // Verification failed
                        const errorMsg = result.data?.errorMessage || result.message || 'Verification failed';
                        if (statusSpan) {
                            statusSpan.innerHTML = '<span class="text-warning">‚ö† Not verified</span>';
                        }

                        if (resultDiv) {
                            resultDiv.innerHTML = `<div class="alert alert-warning p-2"><small>‚ö† ${errorMsg}</small></div>`;
                            resultDiv.style.display = 'block';
                        }

                        showToastMini('warning', errorMsg);
                    }
                } catch (error) {
                    console.error('Verification error:', error);
                    if (statusSpan) {
                        statusSpan.innerHTML = '<span class="text-danger">‚úó Error</span>';
                    }
                    if (resultDiv) {
                        resultDiv.innerHTML = `<div class="alert alert-danger p-2"><small>‚úó Error: ${error.message}</small></div>`;
                        resultDiv.style.display = 'block';
                    }
                    showToastMini('error', 'Failed to verify CCCD. Please try again.');
                } finally {
                    if (verifyBtn) {
                        verifyBtn.disabled = false;
                        verifyBtn.textContent = 'Re-verify';
                    }
                }
            }

            // Bind verify buttons
            const btnVerifyFront = document.getElementById('btnVerifyFront');
            const btnVerifyBack = document.getElementById('btnVerifyBack');
            if (btnVerifyFront) {
                btnVerifyFront.addEventListener('click', () => verifyCccdImage('front'));
            }
            if (btnVerifyBack) {
                btnVerifyBack.addEventListener('click', () => verifyCccdImage('back'));
            }

            // AJAX submit to keep previews/files without page refresh
            const form = document.getElementById('applyForm');
            form.addEventListener('submit', async function (e) {
                e.preventDefault();
                try {
                    const fd = new FormData(form); // includes antiforgery token if present and all inputs/files

                    // Gather values
                    const businessName = (document.querySelector('input[name="Input.BusinessName"]')?.value || '').trim();
                    const taxValRaw = (document.querySelector('#taxIdInput')?.value || '').trim();
                    const taxValClean = taxValRaw.replace(/\D/g, '');
                    const contactPhone = (document.querySelector('input[name="Input.ContactPhone"]')?.value || '').trim();
                    const contactPhoneClean = contactPhone.replace(/\D/g, '');

                    // Query file inputs directly (they're inside initializeVerification scope)
                    const idCardFrontInput = document.getElementById('idCardFront');
                    const idCardBackInput = document.getElementById('idCardBack');
                    const frontFile = idCardFrontInput?.files?.[0];
                    const backFile = idCardBackInput?.files?.[0];

                    // Client-side validation rules
                    const errors = [];
                    if (!businessName) errors.push('Business name is required.');
                    if (!taxValClean) errors.push('Tax ID is required.');
                    if (taxValClean && taxValClean.length !== 10 && taxValClean.length !== 12) errors.push('Tax ID must be 10 or 12 digits.');
                    if (!contactPhone) errors.push('Contact phone is required.');
                    else if (contactPhoneClean.length !== 10) errors.push('Contact phone must be 10 digits.');

                    // Validation based on provider type
                    if (taxValClean.length === 12) {
                        // INDIVIDUAL - Require CCCD + Selfie
                        if (!frontFile) errors.push('Front ID image is required for 12-digit Personal ID.');
                        if (!backFile) errors.push('Back ID image is required for 12-digit Personal ID.');

                        // Query selfie input directly
                        const selfieInput = document.getElementById('selfieImageInput');
                        const selfieFile = selfieInput?.files?.[0];
                        if (!selfieFile) errors.push('Selfie image is required for face matching verification.');

                        // ‚úÖ CRITICAL VALIDATION: Tax ID must match CCCD ID
                        if (verifiedCccdId && taxValClean !== verifiedCccdId) {
                            errors.push(`‚ùå Tax ID (${taxValClean}) does NOT match your CCCD ID (${verifiedCccdId}). Please correct it.`);
                        }
                    } else if (taxValClean.length === 10) {
                        // BUSINESS - Require CCCD + Business License
                        if (!frontFile) errors.push('Front ID image (representative) is required for business registration.');
                        if (!backFile) errors.push('Back ID image (representative) is required for business registration.');

                        const businessLicenseInput = document.getElementById('businessLicenseImage');
                        const businessLicenseFile = businessLicenseInput?.files?.[0];
                        if (!businessLicenseFile) errors.push('Business license image is required for 10-digit Tax ID.');
                    }

                    // Privacy Policy validation
                    const privacyCheckbox = document.getElementById('privacyPolicyAgreed');
                    if (!privacyCheckbox || !privacyCheckbox.checked) {
                        errors.push('You must agree to the privacy policy to continue.');
                    }

                    if (errors.length > 0) {
                        // Show first error prominently; the rest as additional toasts
                        showToastMini('error', errors[0]);
                        for (let i = 1; i < Math.min(errors.length, 3); i++) {
                            setTimeout(() => showToastMini('error', errors[i]), 250 * i);
                        }
                        // Focus first invalid field
                        if (!businessName) document.querySelector('input[name="Input.BusinessName"]').focus();
                        else if (!taxValClean || (taxValClean.length !== 10 && taxValClean.length !== 12)) document.querySelector('#taxIdInput').focus();
                        else if (!contactPhone) document.querySelector('input[name="Input.ContactPhone"]').focus();
                        else if (taxValClean.length === 12 && !frontFile) document.querySelector('#btnFrontPick')?.focus();
                        else if (taxValClean.length === 12 && !backFile) document.querySelector('#btnBackPick')?.focus();
                        return;
                    }

                    const res = await fetch(window.location.pathname + '?handler=Ajax', {
                        method: 'POST',
                        body: fd
                    });

                    if (!res.ok) {
                        const text = await res.text();
                        showToastMini('error', `Submit failed: ${text.substring(0, 180)}`);
                        return;
                    }

                    showToastMini('success', 'Application submitted. Please check your email regularly for updates on your provider application.');
                } catch (err) {
                    showToastMini('error', `Error: ${err?.message || err}`);
                }
            });
        }

        // Run when DOM ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeVerification);
        } else {
            initializeVerification();
        }

        // ============================================
        // SELFIE CAMERA CAPTURE LOGIC
        // ============================================
        let cameraCapture = null;
        let selfieBlob = null;

        const btnStartCamera = document.getElementById('btnStartCamera');
        const btnStopCamera = document.getElementById('btnStopCamera');
        const btnCaptureSelfie = document.getElementById('btnCaptureSelfie');
        const btnRetakeSelfie = document.getElementById('btnRetakeSelfie');
        const cameraContainer = document.getElementById('cameraContainer');
        const selfiePreviewContainer = document.getElementById('selfiePreviewContainer');
        const startCameraContainer = document.getElementById('startCameraContainer');
        const selfiePreview = document.getElementById('selfiePreview');
        const selfieImageInput = document.getElementById('selfieImageInput');

        // Initialize camera capture
        if (btnStartCamera) {
            btnStartCamera.addEventListener('click', async () => {
                if (!cameraCapture) {
                    cameraCapture = new window.CameraCapture('selfieVideo', 'selfieCanvas');
                }

                const success = await cameraCapture.openCamera('user'); // Front camera
                if (success) {
                    startCameraContainer.style.display = 'none';
                    cameraContainer.style.display = 'block';
                    selfiePreviewContainer.style.display = 'none';
                }
            });
        }

        // Stop camera
        if (btnStopCamera) {
            btnStopCamera.addEventListener('click', () => {
                if (cameraCapture) {
                    cameraCapture.stopCamera();
                }
                cameraContainer.style.display = 'none';
                startCameraContainer.style.display = 'block';
            });
        }

        // Capture photo with countdown
        if (btnCaptureSelfie) {
            btnCaptureSelfie.addEventListener('click', async () => {
                if (!cameraCapture) return;

                const countdownTimer = document.getElementById('countdownTimer');
                const btnCapture = document.getElementById('btnCaptureSelfie');

                // Disable button during countdown
                btnCapture.disabled = true;
                btnCapture.textContent = 'Preparing...';

                // Show countdown: 3... 2... 1... Smile! üì∏
                if (countdownTimer) {
                    countdownTimer.style.display = 'inline';

                    for (let i = 3; i > 0; i--) {
                        countdownTimer.textContent = `${i}...`;
                        countdownTimer.style.fontSize = '24px';
                        countdownTimer.style.color = i === 1 ? '#f44336' : '#2196f3';
                        await new Promise(resolve => setTimeout(resolve, 1000));
                    }

                    countdownTimer.textContent = 'üì∏ Smile!';
                    countdownTimer.style.color = '#4caf50';
                    await new Promise(resolve => setTimeout(resolve, 500));
                }

                // Capture photo
                const canvas = cameraCapture.capturePhoto();
                if (!canvas) {
                    btnCapture.disabled = false;
                    btnCapture.textContent = 'üì∏ Capture Photo';
                    if (countdownTimer) countdownTimer.style.display = 'none';
                    return;
                }

                // Convert to blob
                selfieBlob = await cameraCapture.canvasToBlob(canvas, 0.92);

                // Show preview
                selfiePreview.src = canvas.toDataURL('image/jpeg', 0.92);

                // Update UI
                cameraContainer.style.display = 'none';
                selfiePreviewContainer.style.display = 'block';
                if (countdownTimer) countdownTimer.style.display = 'none';

                // Stop camera
                cameraCapture.stopCamera();

                // Re-enable button
                btnCapture.disabled = false;
                btnCapture.textContent = 'üì∏ Capture Photo';

                // Create File from Blob and set to input
                const file = new File([selfieBlob], 'selfie.jpg', { type: 'image/jpeg' });
                const dataTransfer = new DataTransfer();
                dataTransfer.items.add(file);
                selfieImageInput.files = dataTransfer.files;

                console.log('‚úÖ Selfie captured and ready:', file.size, 'bytes');
                showToastMini('success', '‚úÖ Selfie captured successfully!');

                // Auto-verify face matching with CCCD front image
                await verifyFaceMatch(file);
            });
        }

        // Function to verify face matching via API
        async function verifyFaceMatch(selfieFile) {
            const faceMatchResult = document.getElementById('faceMatchResult');
            const faceMatchAlert = document.getElementById('faceMatchAlert');
            const faceMatchIcon = document.getElementById('faceMatchIcon');
            const faceMatchMessage = document.getElementById('faceMatchMessage');
            const faceMatchScore = document.getElementById('faceMatchScore');

            // Check if CCCD front image exists
            const idCardFront = document.getElementById('idCardFront');
            const frontFile = idCardFront?.files?.[0];

            if (!frontFile) {
                showToastMini('warning', '‚ö†Ô∏è Please upload CCCD front image first before taking selfie');
                return;
            }

            // Show loading state
            faceMatchResult.style.display = 'block';
            faceMatchAlert.className = 'alert alert-info';
            faceMatchIcon.textContent = '‚è≥';
            faceMatchMessage.textContent = 'Verifying face matching...';
            faceMatchScore.textContent = 'Please wait...';

            try {
                // Prepare form data
                const formData = new FormData();
                formData.append('SelfieImage', selfieFile);
                formData.append('CccdFrontImage', frontFile);

                // Get API base URL
                const form = document.getElementById('applyForm');
                const apiRoot = form?.getAttribute('data-api-root') || 'https://localhost:7258';

                // Call API
                const response = await fetch(`${apiRoot}/api/ekyc/verify-face-match`, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.data) {
                    const matchScore = result.data.matchScore;
                    const isMatched = result.data.isMatched;

                    if (isMatched && matchScore >= 0.7) {
                        // EXCELLENT: High match score
                        faceMatchAlert.className = 'alert alert-success';
                        faceMatchIcon.textContent = '‚úÖ';
                        faceMatchMessage.textContent = 'Face Matched! (Excellent)';
                        faceMatchScore.textContent = `Match Score: ${(matchScore * 100).toFixed(1)}% (High confidence)`;
                        showToastMini('success', `‚úÖ Face matched: ${(matchScore * 100).toFixed(1)}%`);
                    } else if (matchScore >= 0.5) {
                        // SUCCESS: Acceptable match (TESTING MODE - 50%)
                        faceMatchAlert.className = 'alert alert-success';
                        faceMatchIcon.textContent = '‚úÖ';
                        faceMatchMessage.textContent = 'Face Matched! (Acceptable)';
                        faceMatchScore.textContent = `Match Score: ${(matchScore * 100).toFixed(1)}% (Required: ‚â•50% TESTING MODE)`;
                        showToastMini('success', `‚úÖ Face matched: ${(matchScore * 100).toFixed(1)}% (Acceptable for testing)`);
                    } else if (matchScore >= 0.4) {
                        // WARNING: Low match score
                        faceMatchAlert.className = 'alert alert-warning';
                        faceMatchIcon.textContent = '‚ö†Ô∏è';
                        faceMatchMessage.textContent = 'Low Match Score';
                        faceMatchScore.textContent = `Match Score: ${(matchScore * 100).toFixed(1)}% (Too low, min 50%)`;
                        showToastMini('warning', `‚ö†Ô∏è Low match score: ${(matchScore * 100).toFixed(1)}%. Please retake with better lighting.`);
                    } else {
                        // FAIL: Not matched
                        faceMatchAlert.className = 'alert alert-danger';
                        faceMatchIcon.textContent = '‚ùå';
                        faceMatchMessage.textContent = 'Face Not Matched';
                        faceMatchScore.textContent = `Match Score: ${(matchScore * 100).toFixed(1)}% (Too low)`;
                        showToastMini('error', `‚ùå Face not matched: ${(matchScore * 100).toFixed(1)}%. Please use your own CCCD.`);
                    }
                } else {
                    // API error
                    faceMatchAlert.className = 'alert alert-danger';
                    faceMatchIcon.textContent = '‚ùå';
                    faceMatchMessage.textContent = 'Verification Failed';
                    faceMatchScore.textContent = result.message || 'Unknown error';
                    showToastMini('error', '‚ùå Face matching failed: ' + (result.message || 'Unknown error'));
                }
            } catch (error) {
                console.error('Face match error:', error);
                faceMatchAlert.className = 'alert alert-danger';
                faceMatchIcon.textContent = '‚ùå';
                faceMatchMessage.textContent = 'Connection Error';
                faceMatchScore.textContent = 'Failed to connect to server';
                showToastMini('error', '‚ùå Connection error. Please try again.');
            }
        }

        // Retake photo
        if (btnRetakeSelfie) {
            btnRetakeSelfie.addEventListener('click', () => {
                selfieBlob = null;
                selfieImageInput.value = '';
                selfiePreviewContainer.style.display = 'none';
                startCameraContainer.style.display = 'block';

                // Hide face match result
                const faceMatchResult = document.getElementById('faceMatchResult');
                if (faceMatchResult) {
                    faceMatchResult.style.display = 'none';
                }
            });
        }

        // ===== Policy Modal Functions =====
        let policyLoaded = false;

        function openPolicyModal() {
            const modal = document.getElementById('policyModal');
            modal.classList.remove('hidden');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            if (!policyLoaded) {
                loadPolicyContent();
            }
        }

        function closePolicyModal() {
            const modal = document.getElementById('policyModal');
            modal.classList.add('hidden');
            modal.style.display = 'none';
            document.body.style.overflow = '';
        }

        function acceptPolicy() {
            document.getElementById('privacyPolicyAgreed').checked = true;
            closePolicyModal();
            showToastMini('success', 'Policy accepted!');
        }

        async function loadPolicyContent() {
            const contentDiv = document.getElementById('policyContent');
            try {
                const apiRoot = document.getElementById('applyForm')?.dataset?.apiRoot || '';
                const apiUrl = apiRoot + '/api';
                const policyName = encodeURIComponent('Privacy Policy');
                const response = await fetch(`${apiUrl}/policy-configs/by-name/${policyName}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                });

                if (response.ok) {
                    const result = await response.json();
                    const policy = result.data;
                    
                    if (policy && policy.content) {
                        contentDiv.innerHTML = `
                            <div style="color: #374151; line-height: 1.6;">
                                ${policy.content}
                            </div>
                        `;
                        policyLoaded = true;
                    } else {
                        contentDiv.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 2rem;">Privacy Policy is not available at the moment.</p>';
                    }
                } else {
                    contentDiv.innerHTML = '<p style="color: #6b7280; text-align: center; padding: 2rem;">Privacy Policy is not available at the moment.</p>';
                }
            } catch (error) {
                console.error('Error loading policy:', error);
                contentDiv.innerHTML = '<p style="color: #dc2626; text-align: center; padding: 2rem;">Failed to load policy. Please try again.</p>';
            }
        }

        // Close policy modal when clicking outside
        document.getElementById('policyModal')?.addEventListener('click', (e) => {
            if (e.target.id === 'policyModal') {
                closePolicyModal();
            }
        });
    </script>

    <!-- Include Camera Capture Script -->
    <script src="~/js/camera-capture.js"></script>
</section>


