@page "/products/detail/{id:guid}"
@model ShareItFE.Pages.Products.DetailModel
@{
    ViewData["Title"] = Model.Product?.Name ?? "Product Detail";
    // Debug: Check IsOwnProduct value
    var debugIsOwnProduct = Model.IsOwnProduct;
    var debugUserId = Model.CurrentUserId;
    var debugProviderId = Model.Product?.ProviderId;
}

@using System.Text.Json
<script src="https://cdn.tailwindcss.com?plugins=forms"></script>
<script src="https://unpkg.com/lucide@latest"></script>

<style>
    /* Styling for formatted product description */
    .product-description p {
        margin-bottom: 0.5rem;
    }
    .product-description strong {
        font-weight: 600;
        color: #1f2937;
    }
    .product-description em {
        font-style: italic;
    }
    .product-description u {
        text-decoration: underline;
    }
    .product-description ol {
        list-style-type: decimal;
        margin-left: 1.5rem;
        margin-bottom: 0.5rem;
    }
    .product-description ul {
        list-style-type: disc;
        margin-left: 1.5rem;
        margin-bottom: 0.5rem;
    }
    .product-description li {
        margin-bottom: 0.25rem;
    }
</style>

<div class="min-h-screen bg-white">
    @if (Model.Product != null)
    {
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <a href="/products" class="flex items-center space-x-2 text-gray-600 hover:text-purple-600 transition-colors mb-8">
                <i data-lucide="arrow-left" class="h-5 w-5"></i>
                <span>Back to Products</span>
            </a>

            <!-- Top Section: 2 Columns -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-12">
                <!-- Left Column: Image Gallery -->
                <div class="space-y-4">
                    <div class="product-image-container relative bg-gray-100 rounded-lg overflow-hidden" style="height: 600px;">
                        <img id="mainProductImage"
                             src="@(Model.Product.Images?.FirstOrDefault()?.ImageUrl ?? "https://via.placeholder.com/600x800.png?text=No+Image")"
                             alt="@Model.Product.Name"
                             class="product-image-main w-full h-full object-contain cursor-pointer" 
                             onclick="openImageModal(this.src)" />
                        <button class="absolute top-4 right-4 bg-black bg-opacity-50 text-white p-2 rounded-full hover:bg-opacity-70 transition-opacity" onclick="openImageModal(document.getElementById('mainProductImage').src)">
                            <i data-lucide="maximize-2" class="h-5 w-5"></i>
                        </button>
                    </div>
                    <div class="thumbnail-container">
                        @if (Model.Product.Images != null)
                        {
                            @for (int i = 0; i < Model.Product.Images.Count; i++)
                            {
                                var image = Model.Product.Images[i];
                                <button type="button" class="thumbnail-btn w-20 h-20 rounded-lg overflow-hidden border-2 @(i == 0 ? "border-purple-600" : "border-gray-200") bg-gray-100 hover:border-purple-400 transition-colors" data-image-src="@image.ImageUrl">
                                    <img src="@image.ImageUrl" alt="@($"{Model.Product.Name} {i + 1}")" class="w-full h-full object-contain" />
                                </button>
                            }
                        }
                    </div>
                </div>

                <!-- Right Column: Basic Product Info -->
                <div class="space-y-6">
                    <!-- Favorite and Share -->
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex-grow"></div>
                        <div class="flex items-center space-x-2">
                            <form method="post" action="/products/detail/@Model.Product.Id?handler=AddFavorite" class="favorite-form" data-product-id="@Model.Product.Id">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="productId" value="@Model.Product.Id" />
                                <button type="submit" class="p-2 text-gray-400 hover:text-red-500 transition-colors favorite-btn" data-product-id="@Model.Product.Id">
                                    <i data-lucide="heart" class="h-5 w-5 favorite-icon @(Model.IsFavorite ? "text-red-500 fill-red-500" : "text-gray-400 hover:text-red-500")"></i>
                                </button>
                            </form>
                            <button type="button" class="p-2 text-gray-400 hover:text-gray-600 transition-colors"><i data-lucide="share-2" class="h-5 w-5"></i></button>
                        </div>
                    </div>

                    <!-- Product Title and Try On -->
                    <div class="flex items-center justify-between mb-4">
                        <h1 class="text-3xl font-bold text-gray-900">@Model.Product.Name</h1>
                        <button type="button" id="tryOnBtn" class="flex items-center space-x-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                            <i data-lucide="sparkles" class="h-4 w-4"></i>
                            <span>Try On</span>
                        </button>
                    </div>

                    <!-- Rating and Stats -->
                    <div class="flex items-center justify-between mb-4">
                        <div class="flex items-center space-x-1">
                            <div class="flex">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    <i data-lucide="star" class="h-5 w-5 @(i <= Model.Product.AverageRating ? "fill-yellow-400 text-yellow-400" : "text-gray-300")"></i>
                                }
                            </div>
                            <span class="text-sm text-gray-600">
                                @Model.Product.AverageRating.ToString("F1") (@Model.TotalFeedbacks reviews)
                            </span>
                        </div>
                        @if(!string.IsNullOrEmpty(Model.Product.GetStatsDisplay()))
                        {
                            <div class="text-sm text-gray-500 ml-2">
                                @Model.Product.GetStatsDisplay()
                            </div>
                        }
                    </div>

                    <!-- Description and Category -->
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-lg font-semibold text-gray-900 mb-2">Description</h3>
                            <div class="text-gray-600 leading-relaxed product-description">
                                @Html.Raw(Model.Product.Description)
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-sm">
                            <div><span class="font-medium text-gray-900">Color:</span><span class="ml-2 text-gray-600">@Model.Product.Color</span></div>
                            <div><span class="font-medium text-gray-900">Category:</span><span class="ml-2 text-gray-600 capitalize">@Model.Product.Category</span></div>
                        </div>
                    </div>

                    <!-- Provider Info -->
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex items-center justify-between">
                            <div>
                                <h4 class="font-medium text-gray-900">Provided by</h4>
                                <p class="text-purple-600 font-semibold">@Model.Product.ProviderName</p>
                                @if (!string.IsNullOrEmpty(Model.ProviderEmail))
                                {
                                    <div class="mt-1 text-sm text-gray-600 flex items-center gap-2">
                                        <i data-lucide="mail" class="h-4 w-4"></i>
                                        <a class="text-gray-700 hover:text-purple-600 underline" href="mailto:@Model.ProviderEmail">@Model.ProviderEmail</a>
                                    </div>
                                }
                            </div>
                            @if (!Model.IsOwnProduct)
                            {
                                <button type="button" id="openChatBtn" class="flex items-center space-x-2 bg-purple-600 text-white px-4 py-2 rounded-lg hover:bg-purple-700 transition-colors">
                                    <i data-lucide="message-circle" class="h-4 w-4"></i>
                                    <span>Message</span>
                                </button>
                            }
                        </div>
                    </div>

                    <!-- Purchase/Rental Form Section -->
                    <form method="post" id="addToCartForm" asp-page-handler="AddToCart" asp-route-id="@Model.Product.Id">
                        @Html.AntiForgeryToken()
                        
                        <!-- Choose Option Section -->
                        <div class="mb-6">
                            <h3 class="text-lg font-semibold mb-4">Choose Option</h3>
                            <div id="transactionTypeError" class="text-red-500 text-sm mb-2 hidden">Please select either Rental or Purchase option.</div>
                            @{
                                bool canRent = Model.Product.RentalStatus == "Available" && Model.Product.PricePerDay > 0 && Model.Product.RentalQuantity > 0;
                                bool canPurchase = Model.Product.PurchaseStatus == "Available" && Model.Product.PurchasePrice > 0 && Model.Product.PurchaseQuantity > 0;
                                bool hasRentalOption = Model.Product.RentalStatus == "Available" && Model.Product.PricePerDay > 0;
                                bool hasPurchaseOption = Model.Product.PurchaseStatus == "Available" && Model.Product.PurchasePrice > 0;
                                bool canAddToCart = (canRent || canPurchase) && !Model.IsOwnProduct; // Disable if it's user's own product
                            }

                            @if (hasRentalOption || hasPurchaseOption)
                            {
                                <div class="space-y-3">
                                    @if (hasRentalOption)
                                    {
                                        <label class="flex items-center justify-between p-4 border rounded-lg @(canRent ? "cursor-pointer hover:bg-gray-50 has-[:checked]:border-purple-600 has-[:checked]:bg-purple-50" : "cursor-not-allowed bg-gray-100 opacity-60")">
                                            <div class="flex items-center">
                                                <input type="radio" name="TransactionType" value="0" asp-for="TransactionType" 
                                                       class="h-4 w-4 text-purple-600 focus:ring-purple-500" 
                                                       disabled="@(!canRent)" />
                                                <div class="ml-3">
                                                    <div class="font-medium @(canRent ? "" : "text-gray-400")">Rental</div>
                                                    <div class="text-sm @(canRent ? "text-gray-500" : "text-gray-400")">
                                                        @if (canRent)
                                                        {
                                                            <span>Daily rental service</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-red-500 font-semibold">Out of stock</span>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="text-right">
                                                <div class="text-lg font-bold @(canRent ? "text-purple-600" : "text-gray-400")">₫@Model.Product.PricePerDay.ToString("N0")/day</div>
                                                @if(!string.IsNullOrEmpty(Model.Product.GetDepositDisplay()))
                                                {
                                                    <div class="text-sm @(canRent ? "text-purple-600" : "text-gray-400")">@Model.Product.GetDepositDisplay()</div>
                                                }
                                            </div>
                                        </label>
                                    }

                                    @if (hasPurchaseOption)
                                    {
                                        <label class="flex items-center justify-between p-4 border rounded-lg @(canPurchase ? "cursor-pointer hover:bg-gray-50 has-[:checked]:border-green-600 has-[:checked]:bg-green-50" : "cursor-not-allowed bg-gray-100 opacity-60")">
                                            <div class="flex items-center">
                                                <input type="radio" name="TransactionType" value="1" asp-for="TransactionType" 
                                                       class="h-4 w-4 text-green-600 focus:ring-green-500" 
                                                       disabled="@(!canPurchase)" />
                                                <div class="ml-3">
                                                    <div class="font-medium @(canPurchase ? "" : "text-gray-400")">Purchase</div>
                                                    <div class="text-sm @(canPurchase ? "text-gray-500" : "text-gray-400")">
                                                        @if (canPurchase)
                                                        {
                                                            <span>Buy to own</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="text-red-500 font-semibold">Out of stock</span>
                                                        }
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="text-lg font-bold @(canPurchase ? "text-green-600" : "text-gray-400")">₫@Model.Product.PurchasePrice.ToString("N0")</div>
                                        </label>
                                    }
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-8 text-gray-500">
                                    <p>This item is currently unavailable for rent or purchase.</p>
                                </div>
                            }
                        </div>

                        <!-- Size Selection and Add to Cart -->
                        <div class="border-t pt-6 space-y-6">
                            @if (!Model.IsOwnProduct)
                            {
                                <div>
                                    <label class="block text-sm font-medium text-gray-900 mb-3">Select Size</label>
                                    <div id="sizeError" class="text-red-500 text-sm mb-2 hidden">Please select a size.</div>
                                    <input type="hidden" id="selectedSizeInput" asp-for="SelectedSize" />
                                    <div class="flex space-x-3">
                                        @foreach (var size in (Model.Product.Size?.Split(',') ?? Enumerable.Empty<string>()))
                                        {
                                            <button type="button" class="size-btn px-4 py-2 border rounded-lg font-medium transition-colors border-gray-300 text-gray-700 hover:border-purple-600" data-size="@size.Trim()">@size.Trim()</button>
                                        }
                                    </div>
                                </div>
                            }
                            else
                            {
                                <!-- Provider viewing their own product - hide size selection -->
                            }
                            
                            <!-- Add to Cart Button -->
                            <button type="submit" id="addToCartBtn"
                                    disabled="@(!canAddToCart)"
                                    class="w-full bg-purple-600 text-white py-3 px-6 rounded-lg font-semibold hover:bg-purple-700 disabled:bg-gray-400 disabled:cursor-not-allowed transition-colors">
                                <span>
                                    @if (Model.IsOwnProduct)
                                    {
                                        @:This is your product
                                    }
                                    else if (canAddToCart)
                                    {
                                        @:Add to Cart
                                    }
                                    else
                                    {
                                        @:No Options Available
                                    }
                                </span>
                            </button>
                          
                            <div class="grid grid-cols-3 gap-4 pt-6 border-t">
                                <div class="text-center"><i data-lucide="truck" class="h-8 w-8 text-purple-600 mx-auto mb-2"></i><div class="text-sm font-medium text-gray-900">Free Delivery</div><div class="text-xs text-gray-500">Both ways</div></div>
                                <div class="text-center"><i data-lucide="calendar" class="h-8 w-8 text-purple-600 mx-auto mb-2"></i><div class="text-sm font-medium text-gray-900">Flexible Dates</div><div class="text-xs text-gray-500">Easy rescheduling</div></div>
                                <div class="text-center"><i data-lucide="shield" class="h-8 w-8 text-purple-600 mx-auto mb-2"></i><div class="text-sm font-medium text-gray-900">Damage Protection</div><div class="text-xs text-gray-500">Worry-free rental</div></div>
                            </div>
                        </div>
                    </form>

                </div>
            </div>

            <!-- Leave Feedback Button -->
            @if (@Model.CanBeFeedbacked)
            {
                <div class="mt-12">
                    <button type="button" id="openFeedbackBtn" class="bg-purple-600 text-white px-6 py-3 rounded-lg hover:bg-purple-700 transition-colors inline-flex items-center space-x-2">
                        <i data-lucide="message-square-plus" class="h-5 w-5"></i>
                        <span>Leave Feedback</span>
                    </button>
                </div>
            }

            @if (Model.Feedbacks != null && Model.Feedbacks.Any())
            {
                <div id="reviews" class="mt-8 border-t pt-16">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-2xl font-bold text-gray-900">Customer Reviews</h2>
                        <div class="flex items-center space-x-2">
                            <div class="flex">
                                @for (int i = 1; i <= 5; i++)
                                {
                                    <i data-lucide="star" class="h-5 w-5 @(i <= Model.Product.AverageRating ? "fill-yellow-400 text-yellow-400" : "text-gray-300")"></i>
                                }
                            </div>
                            <span class="text-lg font-semibold">@Model.Product.AverageRating.ToString("F1")</span>
                            <span class="text-gray-500">(@Model.TotalFeedbacks reviews)</span>
                        </div>
                    </div>

                    <div class="space-y-6">
                        @foreach (var feedback in Model.Feedbacks)
                        {
                            <div class="bg-gray-50 rounded-lg p-6 @(feedback.IsBlocked ? "border-2 border-red-300" : "")" data-feedback-id="@feedback.FeedbackId">
                                <div class="flex items-center justify-between mb-4">
                                    <div class="flex items-center space-x-3">
                                        <img src="@feedback.ProfilePictureUrl" alt="@feedback.CustomerName's avatar" class="w-10 h-10 rounded-full object-cover" />
                                        <div>
                                            <div class="flex items-center space-x-2">
                                                <span class="font-semibold text-gray-900">@feedback.CustomerName</span>
                                                @if (feedback.IsBlocked && Model.IsOwnProduct)
                                                {
                                                    <span class="inline-flex items-center px-2 py-1 text-xs font-medium text-red-700 bg-red-100 rounded-full">
                                                        <i data-lucide="shield-off" class="h-3 w-3 mr-1"></i>
                                                        Blocked
                                                    </span>
                                                }
                                            </div>
                                            <div class="flex items-center space-x-2">
                                                <div class="flex">
                                                    @for (int i = 1; i <= 5; i++)
                                                    {
                                                        <i data-lucide="star" class="h-4 w-4 @(i <= feedback.Rating ? "fill-yellow-400 text-yellow-400" : "text-gray-300")"></i>
                                                    }
                                                </div>
                                                <span class="text-sm text-gray-500">@feedback.SubmittedAt.ToLocalTime().ToString("dd MMM, yyyy")</span>
                                            </div>
                                        </div>
                                    </div>
                                    @* Edit button for customer's own feedback *@
                                    @if (Model.CurrentUserId != null && feedback.CustomerId.ToString() == Model.CurrentUserId.ToString())
                                    {
                                        <button type="button" 
                                                class="edit-feedback-btn flex items-center space-x-1 px-3 py-1.5 text-sm text-purple-600 hover:text-purple-700 hover:bg-purple-50 rounded-lg transition-colors"
                                                data-feedback-id="@feedback.FeedbackId"
                                                data-rating="@feedback.Rating"
                                                data-comment="@feedback.Comment">
                                            <i data-lucide="edit-2" class="h-4 w-4"></i>
                                            <span>Edit</span>
                                        </button>
                                    }
                                </div>
                                @if (feedback.IsBlocked && Model.IsOwnProduct)
                                {
                                    <div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4">
                                        <div class="flex items-center mb-2">
                                            <i data-lucide="shield-off" class="h-5 w-5 text-red-600 mr-2"></i>
                                            <strong class="text-red-800">⚠️ This feedback is blocked and hidden from customers</strong>
                                        </div>
                                        @if (!string.IsNullOrEmpty(feedback.ViolationReason))
                                        {
                                            <p class="text-red-700 text-sm mb-2">
                                                <strong>Reason:</strong> @feedback.ViolationReason
                                            </p>
                                        }
                                        <p class="text-gray-600 text-sm mb-2">
                                            <strong>Original comment:</strong>
                                        </p>
                                        <p class="p-3 bg-gray-100 rounded text-gray-700 text-sm">
                                            @feedback.Comment
                                        </p>
                                        <p class="text-xs text-gray-500 mt-2">
                                            💡 Only you (as the provider) can see this blocked feedback.
                                        </p>
                                    </div>
                                }
                                else if (!string.IsNullOrEmpty(feedback.ViolationReason))
                                {
                                    <div class="bg-orange-50 border-l-4 border-orange-500 p-4 mb-4">
                                        <div class="flex items-center mb-2">
                                            <i data-lucide="alert-triangle" class="h-5 w-5 text-orange-600 mr-2"></i>
                                            <strong class="text-orange-800">Content Hidden Due to Violation</strong>
                                        </div>
                                        <p class="text-orange-700 text-sm mb-2">
                                            <strong>Reason:</strong> @feedback.ViolationReason
                                        </p>
                                        <details class="mt-2">
                                            <summary class="cursor-pointer text-gray-600 text-sm hover:text-gray-800">Show original comment (visible only to you)</summary>
                                            <p class="mt-2 p-3 bg-gray-100 rounded text-gray-600 opacity-60 text-sm">
                                                @feedback.Comment
                                            </p>
                                        </details>
                                    </div>
                                }
                                else
                                {
                                    <p class="text-gray-700">@feedback.Comment</p>
                                }
                            </div>
                        }
                    </div>
                    
                    @* Pagination Controls *@
                    @if (Model.TotalPages > 1)
                    {
                        <div id="pagination-container" class="mt-8 flex justify-center">
                            <nav class="flex items-center space-x-2">
                                @* Previous Button *@
                                @if (Model.CurrentPage > 1)
                                {
                                    <button type="button" data-page="@(Model.CurrentPage - 1)" 
                                            class="pagination-btn px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 transition-colors">
                                        Previous
                                    </button>
                                }
                                
                                @* Page Numbers *@
                                @for (int i = Math.Max(1, Model.CurrentPage - 2); i <= Math.Min(Model.TotalPages, Model.CurrentPage + 2); i++)
                                {
                                    @if (i == Model.CurrentPage)
                                    {
                                        <span class="px-3 py-2 text-sm font-medium text-white bg-purple-600 border border-purple-600 rounded-md current-page">
                                            @i
                                        </span>
                                    }
                                    else
                                    {
                                        <button type="button" data-page="@i" 
                                                class="pagination-btn px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 transition-colors">
                                            @i
                                        </button>
                                    }
                                }
                                
                                @* Next Button *@
                                @if (Model.CurrentPage < Model.TotalPages)
                                {
                                    <button type="button" data-page="@(Model.CurrentPage + 1)" 
                                            class="pagination-btn px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50 hover:text-gray-700 transition-colors">
                                        Next
                                    </button>
                                }
                            </nav>
                            <div id="loading-reviews" class="hidden ml-4 flex items-center">
                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-purple-600"></div>
                                <span class="ml-2 text-sm text-gray-600">Loading...</span>
                            </div>
                        </div>
                    }
                </div>
            }
        </div>
    }
    else
    {
        <div class="text-center py-20">
            <h2 class="text-2xl font-bold">Product not found.</h2>
            <p class="text-gray-600">The product you are looking for does not exist.</p>
            <a href="/products" class="mt-4 inline-block text-purple-600 hover:underline">Return to collection</a>
        </div>
    }
</div>

<div id="chatModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-lg shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3 border-b">
            <p id="chat-provider-name" class="text-2xl font-bold">Chat with Provider</p>
            <button id="closeChatBtn" class="cursor-pointer z-50">
                <i data-lucide="x" class="h-6 w-6"></i>
            </button>
        </div>
        <div class="mt-3">
            <div id="chat-messages" class="h-96 overflow-y-auto p-3 space-y-4 bg-gray-50 rounded-lg">
                <div class="text-center text-gray-400">Loading messages...</div>
            </div>
            <form id="sendMessageForm" class="mt-4 flex space-x-3">
                <input type="text" id="chat-message-input" placeholder="Type a message..." autocomplete="off"
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent" disabled>
                <button type="submit" id="chat-send-btn"
                        class="bg-purple-600 text-white px-6 py-2 rounded-lg hover:bg-purple-700 disabled:bg-gray-400 transition-colors" disabled>
                    Send
                </button>
            </form>
        </div>
    </div>
</div>
<div id="feedbackModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
    <div class="relative top-20 mx-auto p-5 border w-full max-w-md shadow-lg rounded-md bg-white">
        <div class="flex justify-between items-center pb-3 border-b">
            <p class="text-2xl font-bold">Submit Your Feedback</p>
            <button id="closeFeedbackBtn" class="cursor-pointer z-50">
                <i data-lucide="x" class="h-6 w-6"></i>
            </button>
        </div>
        <form method="post" id="feedbackForm" asp-page-handler="AddFeedback" asp-route-id="@Model.Product.Id" class="mt-4 space-y-4">
            @Html.AntiForgeryToken()
            <input type="hidden" name="productId" value="@Model.Product.Id" />
            <div>
                <label class="block text-sm font-medium text-gray-700 mb-2">Your Rating</label>
                <div class="flex space-x-1" id="starRatingContainer">
                    @for (int i = 1; i <= 5; i++)
                    {
                        <button type="button" class="feedback-star-btn text-gray-300 hover:text-yellow-400" data-rating="@i">
                            <i data-lucide="star" class="h-8 w-8"></i>
                        </button>
                    }
                </div>
                <input type="hidden" id="feedbackRatingInput" asp-for="FeedbackInput.Rating" value="0" />
                <div id="ratingError" class="text-red-500 text-sm mt-2 hidden">The Rating field is required.</div>
            </div>

            <div>
                <label for="feedbackComment" class="block text-sm font-medium text-gray-700 mb-2">Your Comment</label>
                <textarea id="feedbackComment" asp-for="FeedbackInput.Comment" rows="4"
                          class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-purple-500 focus:border-purple-500"
                          placeholder="Share your thoughts about this product..."></textarea>
                <div id="commentError" class="text-red-500 text-sm mt-2 hidden">The field Comment must be a string with a maximum length of 1000.</div>
            </div>

            <div class="flex justify-end space-x-3">
                <button type="button" id="cancelFeedbackBtn" class="px-4 py-2 text-gray-700 bg-gray-200 rounded-md hover:bg-gray-300 transition-colors">Cancel</button>
                <button type="submit" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">Submit Feedback</button>
            </div>
        </form>
    </div>
</div>

<!-- Image Modal for Full Size View -->
<div id="imageModal" class="hidden fixed inset-0 bg-black bg-opacity-75 z-50">
    <div class="relative w-full h-full overflow-hidden">
        <!-- Top Controls -->
        <div class="zoom-controls absolute top-4 left-1/2 transform -translate-x-1/2 flex items-center space-x-2 z-20">
            <button id="zoomOutBtn" class="text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-75 transition-all duration-200">
                <i data-lucide="zoom-out" class="h-5 w-5"></i>
            </button>
            <span id="zoomLevel" class="text-white bg-black bg-opacity-50 px-3 py-1 rounded-full text-sm font-medium">100%</span>
            <button id="zoomInBtn" class="text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-75 transition-all duration-200">
                <i data-lucide="zoom-in" class="h-5 w-5"></i>
            </button>
            <button id="resetZoomBtn" class="text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-75 transition-all duration-200" title="Reset zoom and position">
                <i data-lucide="refresh-cw" class="h-5 w-5"></i>
            </button>
        </div>
        
        <!-- Close Button -->
        <button onclick="closeImageModal()" class="absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full p-2 hover:bg-opacity-75 transition-opacity z-20">
            <i data-lucide="x" class="h-6 w-6"></i>
        </button>
        
        <!-- Image Container -->
        <div id="imageContainer" class="w-full h-full flex items-center justify-center cursor-grab active:cursor-grabbing">
            <img id="modalImage" src="" alt="Product Image" class="transition-transform duration-200 select-none" style="transform-origin: center center;" />
        </div>
        
        <!-- Instructions -->
        <div class="modal-instructions absolute bottom-4 left-1/2 transform -translate-x-1/2 text-white bg-black bg-opacity-50 px-4 py-2 rounded-full text-sm z-10">
            <span>Drag to pan • Scroll to zoom • Double-click to fit</span>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/dist/browser/signalr.js"></script>
    <script>
        lucide.createIcons();

        // Show toast messages from Model if any
        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <text>
            window.addEventListener('DOMContentLoaded', function() {
                showToast(@Html.Raw(JsonSerializer.Serialize(Model.ErrorMessage)), 'error');
            });
            </text>
        }
        @if (!string.IsNullOrEmpty(Model.SuccessMessage))
        {
            <text>
            window.addEventListener('DOMContentLoaded', function() {
                showToast(@Html.Raw(JsonSerializer.Serialize(Model.SuccessMessage)), 'success');
            });
            </text>
        }

        // Handle scroll to reviews section for pagination
        function scrollToReviews() {
            const urlParams = new URLSearchParams(window.location.search);
            const pageParam = urlParams.get('page');
            const hasReviewsHash = window.location.hash === '#reviews';
            
            // Check if we should scroll to reviews
            const shouldScroll = hasReviewsHash || (pageParam && parseInt(pageParam) > 1);
            
            if (shouldScroll) {
                const reviewsElement = document.getElementById('reviews');
                if (reviewsElement) {
                    // Wait a bit for content to render
                    setTimeout(() => {
                        const headerOffset = 100; // Offset to account for any fixed headers
                        const elementPosition = reviewsElement.getBoundingClientRect().top + window.pageYOffset;
                        const offsetPosition = elementPosition - headerOffset;
                        
                        window.scrollTo({
                            top: offsetPosition,
                            behavior: 'smooth'
                        });
                    }, 100);
                }
            }
        }

        // AJAX Pagination functionality
        let currentPage = @Model.CurrentPage;
        let totalPages = @Model.TotalPages;
        const productId = '@Model.Product.Id';

        async function loadReviews(page) {
            const loadingElement = document.getElementById('loading-reviews');
            const reviewsContainer = document.querySelector('#reviews .space-y-6');
            
            try {
                // Show loading indicator
                loadingElement.classList.remove('hidden');
                
                // Fetch new reviews
                const response = await fetch(`/products/detail/${productId}?page=${page}&handler=Reviews`, {
                    method: 'GET',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to load reviews');
                }
                
                const html = await response.text();
                
                // Parse the HTML response to extract reviews
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const newReviews = doc.querySelector('#reviews .space-y-6');
                const newPagination = doc.querySelector('#pagination-container nav');
                
                if (newReviews && newPagination) {
                    // Update reviews content with smooth transition
                    reviewsContainer.style.opacity = '0.5';
                    setTimeout(() => {
                        reviewsContainer.innerHTML = newReviews.innerHTML;
                        reviewsContainer.style.opacity = '1';
                        
                        // Update pagination
                        const currentPaginationNav = document.querySelector('#pagination-container nav');
                        currentPaginationNav.innerHTML = newPagination.innerHTML;
                        
                        // Re-attach event listeners
                        attachPaginationListeners();
                        
                        // Update current page
                        currentPage = page;
                        
                        // Update URL without reload
                        const newUrl = new URL(window.location);
                        newUrl.searchParams.set('page', page);
                        newUrl.hash = 'reviews';
                        window.history.pushState({ page: page }, '', newUrl.toString());
                        
                        // Scroll to reviews
                        scrollToReviews();
                    }, 150);
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
                showToast('Failed to load reviews', 'error');
            } finally {
                // Hide loading indicator
                loadingElement.classList.add('hidden');
            }
        }

        function attachPaginationListeners() {
            const paginationButtons = document.querySelectorAll('.pagination-btn');
            paginationButtons.forEach(button => {
                button.addEventListener('click', function(e) {
                    e.preventDefault();
                    const page = parseInt(this.dataset.page);
                    if (page && page !== currentPage && page >= 1 && page <= totalPages) {
                        loadReviews(page);
                    }
                });
            });
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            if (event.state && event.state.page) {
                loadReviews(event.state.page);
            }
        });

        // Call functions when page loads
        document.addEventListener('DOMContentLoaded', function() {
            scrollToReviews();
            attachPaginationListeners();
        });
        
        // Also call when window is fully loaded
        window.addEventListener('load', scrollToReviews);
        
        // Handle hash changes (back/forward navigation)
        window.addEventListener('hashchange', scrollToReviews);

        // Toast notification function
        function showToast(message, type = 'success', duration = null) {
            // Remove existing toast if any
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) {
                existingToast.remove();
            }

            // Default duration: 3s for success, 5s for error (to give time to read violation messages)
            if (duration === null) {
                duration = type === 'error' ? 5000 : 3000;
            }

            // Create toast element
            const toast = document.createElement('div');
            toast.className = `toast-notification fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full ${
                type === 'success' ? 'bg-green-500 text-white' : 'bg-red-500 text-white'
            }`;
            toast.textContent = message;

            // Add to page
            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => {
                toast.classList.remove('translate-x-full');
            }, 10);

            // Auto remove after specified duration
            setTimeout(() => {
                toast.classList.add('translate-x-full');
                setTimeout(() => {
                    if (toast.parentNode) {
                        toast.parentNode.removeChild(toast);
                    }
                }, 300);
            }, duration);
        }

        // Image Modal Functions with Pan and Zoom
        let modalState = {
            scale: 1,
            translateX: 0,
            translateY: 0,
            isDragging: false,
            startX: 0,
            startY: 0,
            startTranslateX: 0,
            startTranslateY: 0
        };

        function openImageModal(imageSrc) {
            const modal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            modalImage.src = imageSrc;
            modal.classList.remove('hidden');
            document.body.classList.add('overflow-hidden');
            
            // Reset modal state
            resetModalState();
            updateImageTransform();
            updateZoomLevel();
            
            // Re-create icons for the new buttons
            lucide.createIcons();
        }

        function closeImageModal() {
            const modal = document.getElementById('imageModal');
            modal.classList.add('hidden');
            document.body.classList.remove('overflow-hidden');
            resetModalState();
        }

        function resetModalState() {
            modalState.scale = 1;
            modalState.translateX = 0;
            modalState.translateY = 0;
            modalState.isDragging = false;
        }

        function updateImageTransform() {
            const modalImage = document.getElementById('modalImage');
            modalImage.style.transform = `translate(${modalState.translateX}px, ${modalState.translateY}px) scale(${modalState.scale})`;
        }

        function updateZoomLevel() {
            const zoomLevel = document.getElementById('zoomLevel');
            zoomLevel.textContent = Math.round(modalState.scale * 100) + '%';
        }

        function zoomImage(delta, centerX = null, centerY = null) {
            const zoomFactor = 1.2;
            const oldScale = modalState.scale;
            
            if (delta > 0) {
                modalState.scale = Math.min(modalState.scale * zoomFactor, 5); // Max 500%
            } else {
                modalState.scale = Math.max(modalState.scale / zoomFactor, 0.1); // Min 10%
            }

            // If zoom center is provided, adjust translation to zoom towards that point
            if (centerX !== null && centerY !== null) {
                const scaleChange = modalState.scale - oldScale;
                const modalImage = document.getElementById('modalImage');
                const rect = modalImage.getBoundingClientRect();
                const imageCenterX = rect.left + rect.width / 2;
                const imageCenterY = rect.top + rect.height / 2;
                
                modalState.translateX -= (centerX - imageCenterX) * (scaleChange / oldScale);
                modalState.translateY -= (centerY - imageCenterY) * (scaleChange / oldScale);
            }

            updateImageTransform();
            updateZoomLevel();
        }

        // Mouse/Touch Events
        document.getElementById('imageContainer').addEventListener('mousedown', function(e) {
            if (e.target.id === 'modalImage') {
                modalState.isDragging = true;
                modalState.startX = e.clientX;
                modalState.startY = e.clientY;
                modalState.startTranslateX = modalState.translateX;
                modalState.startTranslateY = modalState.translateY;
                
                // Add dragging class for cursor change
                this.classList.add('dragging');
                e.preventDefault();
            }
        });

        document.addEventListener('mousemove', function(e) {
            if (modalState.isDragging) {
                const deltaX = e.clientX - modalState.startX;
                const deltaY = e.clientY - modalState.startY;
                
                modalState.translateX = modalState.startTranslateX + deltaX;
                modalState.translateY = modalState.startTranslateY + deltaY;
                
                updateImageTransform();
            }
        });

        document.addEventListener('mouseup', function() {
            if (modalState.isDragging) {
                modalState.isDragging = false;
                // Remove dragging class
                const container = document.getElementById('imageContainer');
                if (container) {
                    container.classList.remove('dragging');
                }
            }
        });

        // Wheel zoom
        document.getElementById('imageContainer').addEventListener('wheel', function(e) {
            e.preventDefault();
            const rect = e.currentTarget.getBoundingClientRect();
            const centerX = e.clientX;
            const centerY = e.clientY;
            
            zoomImage(-e.deltaY, centerX, centerY);
        });

        // Double click to fit
        document.getElementById('modalImage').addEventListener('dblclick', function() {
            resetModalState();
            updateImageTransform();
            updateZoomLevel();
        });

        // Zoom controls
        document.addEventListener('DOMContentLoaded', function() {
            // --- Transaction Type Selection Logic ---
            const transactionRadios = document.querySelectorAll('input[name="TransactionType"]');
            const addToCartBtn = document.getElementById('addToCartBtn');
            const addToCartForm = document.getElementById('addToCartForm');

            function updateTransactionUI() {
                const selectedOption = document.querySelector('input[name="TransactionType"]:checked');
                if (selectedOption && addToCartBtn) {
                    const isRental = selectedOption.value === '0';
                    const buttonText = addToCartBtn.querySelector('span');
                    if (buttonText) {
                        buttonText.textContent = `Add to Cart (${isRental ? 'Rental' : 'Purchase'})`;
                    }
                }
            }

            // Add event listeners to transaction type radio buttons
            if (transactionRadios.length > 0) {
                transactionRadios.forEach(radio => {
                    radio.addEventListener('change', updateTransactionUI);
                });
                
                // Set initial UI state based on default selection from backend
                updateTransactionUI();
            }

            // Validate transaction type and size selection before submit
            if (addToCartForm) {
                addToCartForm.addEventListener('submit', function(e) {
                    let hasError = false;
                    
                    // Validate Transaction Type
                    const selectedOption = document.querySelector('input[name="TransactionType"]:checked');
                    const transactionErrorDiv = document.getElementById('transactionTypeError');
                    
                    if (!selectedOption) {
                        hasError = true;
                        if (transactionErrorDiv) {
                            transactionErrorDiv.classList.remove('hidden');
                        }
                    } else {
                        if (transactionErrorDiv) {
                            transactionErrorDiv.classList.add('hidden');
                        }
                    }
                    
                    // Validate Size
                    const selectedSize = document.getElementById('selectedSizeInput').value;
                    const sizeErrorDiv = document.getElementById('sizeError');
                    
                    if (!selectedSize || selectedSize.trim() === '') {
                        hasError = true;
                        if (sizeErrorDiv) {
                            sizeErrorDiv.classList.remove('hidden');
                        }
                    } else {
                        if (sizeErrorDiv) {
                            sizeErrorDiv.classList.add('hidden');
                        }
                    }
                    
                    // Prevent form submission if there are errors
                    if (hasError) {
                        e.preventDefault();
                        // Scroll to the first error
                        const firstError = document.querySelector('#transactionTypeError:not(.hidden), #sizeError:not(.hidden)');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return false;
                    }
                });

                // Hide transaction type error when user selects an option
                transactionRadios.forEach(radio => {
                    radio.addEventListener('change', function() {
                        const errorDiv = document.getElementById('transactionTypeError');
                        if (errorDiv) {
                            errorDiv.classList.add('hidden');
                        }
                    });
                });
            }

            // --- Size Selection Logic ---
            const sizeBtns = document.querySelectorAll('.size-btn');
            const selectedSizeInput = document.getElementById('selectedSizeInput');

            if (sizeBtns.length > 0 && selectedSizeInput) {
                sizeBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        selectedSizeInput.value = btn.dataset.size;
                        
                        // Update visual state
                        sizeBtns.forEach(b => {
                            b.classList.remove('bg-purple-600', 'text-white', 'border-purple-600');
                            b.classList.add('border-gray-300', 'text-gray-700');
                        });
                        btn.classList.remove('border-gray-300', 'text-gray-700');
                        btn.classList.add('bg-purple-600', 'text-white', 'border-purple-600');
                        
                        // Hide size error when user selects a size
                        const sizeErrorDiv = document.getElementById('sizeError');
                        if (sizeErrorDiv) {
                            sizeErrorDiv.classList.add('hidden');
                        }
                    });
                });
            }

            // --- Try On Button Logic ---
            const tryOnBtn = document.getElementById('tryOnBtn');
            if (tryOnBtn) {
                tryOnBtn.addEventListener('click', () => {
                    // Check if user is authenticated
                    const isAuthenticated = '@User.Identity.IsAuthenticated'.toLowerCase() === 'true';
                    if (!isAuthenticated) {
                        showToast('Please log in to use Try On feature', 'error');
                        return;
                    }
                    
                    const garmentImageUrls = @Html.Raw(JsonSerializer.Serialize(Model.Product?.Images?.Select(i => i.ImageUrl).ToList() ?? new List<string>()));
                    const productId = '@Model.Product?.Id';
                    if (garmentImageUrls.length > 0) {
                        window.location.href = `/AI/AIGeneration?GarmentImageUrls=${encodeURIComponent(JSON.stringify(garmentImageUrls))}&ProductId=${productId}`;
                    } else {
                        showToast('No garment image available for try-on', 'error');
                    }
                });
            }

            // Wait for the modal to be in DOM, then add event listeners
            setTimeout(() => {
                const zoomInBtn = document.getElementById('zoomInBtn');
                const zoomOutBtn = document.getElementById('zoomOutBtn');
                const resetZoomBtn = document.getElementById('resetZoomBtn');

                if (zoomInBtn) {
                    zoomInBtn.addEventListener('click', function() {
                        zoomImage(1);
                    });
                }

                if (zoomOutBtn) {
                    zoomOutBtn.addEventListener('click', function() {
                        zoomImage(-1);
                    });
                }

                if (resetZoomBtn) {
                    resetZoomBtn.addEventListener('click', function() {
                        resetModalState();
                        updateImageTransform();
                        updateZoomLevel();
                    });
                }
            }, 100);
        });

        // Close modal when clicking outside the image
        document.getElementById('imageModal').addEventListener('click', function(e) {
            if (e.target === this || e.target.id === 'imageContainer') {
                closeImageModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeImageModal();
            }
        });

        document.addEventListener('DOMContentLoaded', function () {

                    // --- PHẦN 3: LOGIC CHO FEEDBACK MODAL ---

            // DOM Elements for Feedback Modal
            const openFeedbackBtn = document.getElementById('openFeedbackBtn');
            const closeFeedbackBtn = document.getElementById('closeFeedbackBtn');
            const cancelFeedbackBtn = document.getElementById('cancelFeedbackBtn');
            const feedbackModal = document.getElementById('feedbackModal');
            const feedbackForm = document.getElementById('feedbackForm');
            const starRatingContainer = document.getElementById('starRatingContainer');
            const feedbackRatingInput = document.getElementById('feedbackRatingInput');
            const feedbackCommentInput = document.getElementById('feedbackComment'); // Corrected ID
            const ratingError = document.getElementById('ratingError');
            const commentError = document.getElementById('commentError');

            // Validate feedback form before submission
            if (feedbackForm) {
                feedbackForm.addEventListener('submit', function(e) {
                    let hasError = false;
                    const rating = parseInt(feedbackRatingInput.value, 10);
                    const comment = feedbackCommentInput.value;
                    
                    // Validate rating
                    if (!rating || rating < 1 || rating > 5) {
                        hasError = true;
                        if (ratingError) {
                            ratingError.classList.remove('hidden');
                        }
                    } else {
                        if (ratingError) {
                            ratingError.classList.add('hidden');
                        }
                    }
                    
                    // Validate comment length
                    if (comment && comment.length > 1000) {
                        hasError = true;
                        if (commentError) {
                            commentError.classList.remove('hidden');
                        }
                    } else {
                        if (commentError) {
                            commentError.classList.add('hidden');
                        }
                    }
                    
                    // Prevent submission if there are errors
                    if (hasError) {
                        e.preventDefault();
                        
                        // Scroll to first error
                        const firstError = document.querySelector('#ratingError:not(.hidden), #commentError:not(.hidden)');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        
                        return false;
                    }
                });
            }

            if (openFeedbackBtn) {
                openFeedbackBtn.addEventListener('click', (e) => {
                    e.preventDefault(); // Prevent any default button behavior
                    
                    // Double-check authentication (should already be checked by backend)
                    const isAuthenticated = '@User.Identity.IsAuthenticated'.toLowerCase() === 'true';
                    if (!isAuthenticated) {
                        showToast('Please log in to leave feedback', 'error');
                        return;
                    }
                    
                    feedbackModal.classList.remove('hidden');
                    document.body.classList.add('overflow-hidden');
                    // Reset form fields when opening
                    feedbackRatingInput.value = '0';
                    feedbackCommentInput.value = '';
                    updateStarRating(0); // Set initial stars to none
                    
                    // Hide error messages when opening modal
                    if (ratingError) {
                        ratingError.classList.add('hidden');
                    }
                    if (commentError) {
                        commentError.classList.add('hidden');
                    }
                });
            }

            if (closeFeedbackBtn) {
                closeFeedbackBtn.addEventListener('click', () => {
                    feedbackModal.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                });
            }

            if (cancelFeedbackBtn) {
                cancelFeedbackBtn.addEventListener('click', () => {
                    feedbackModal.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                });
            }

                    // ... (keep your existing DOM element references and open/close modal logic) ...

                // ... (Your existing DOM elements and modal open/close logic) ...

            // Star Rating Logic
            function updateStarRating(rating) {
                const starButtons = starRatingContainer.querySelectorAll('.feedback-star-btn');
                starButtons.forEach((button, index) => {
                    // Find the SVG element within the button
                    const svgIcon = button.querySelector('svg[data-lucide="star"]');

                    if (svgIcon) {
                        // Option A: Manipulate fill directly on the SVG path (most robust for fill color)
                        const pathElement = svgIcon.querySelector('path');
                        if (pathElement) {
                            if (index < rating) {
                                pathElement.setAttribute('fill', '#FACC15'); // Tailwind yellow-400
                                svgIcon.setAttribute('stroke', '#FACC15'); // Tailwind yellow-400 (for stroke, if applicable)
                            } else {
                                pathElement.setAttribute('fill', 'none'); // No fill for empty star
                                svgIcon.setAttribute('stroke', '#D1D5DB'); // Tailwind gray-300 (for stroke)
                            }
                        }

                        // Option B: (Less reliable, but can try if A causes issues with complex SVGs)
                        // Re-create the icon on the button after changing classes
                        // This requires calling lucide.createIcons() on a specific element
                        //
                        // First, remove existing classes
                        // button.classList.remove('text-gray-300', 'text-yellow-400', 'fill-yellow-400');
                        //
                        // if (index < rating) {
                        //     button.classList.add('text-yellow-400'); // Add text class for stroke
                        //     // Note: Tailwind fill- classes typically target SVGs directly,
                        //     // but Lucide might need a recreation if its internal rendering
                        //     // isn't reacting to parent class changes.
                        // } else {
                        //     button.classList.add('text-gray-300'); // Add text class for stroke
                        // }
                        // lucide.createIcons({ attrs: { class: 'h-8 w-8' }, element: button }); // Re-create just this icon
                    }
                });
                feedbackRatingInput.value = rating;
            }

            starRatingContainer.addEventListener('click', (event) => {
                    const clickedButton = event.target.closest('.feedback-star-btn');
                    if (clickedButton) {
                        const rating = parseInt(clickedButton.dataset.rating, 10);
                    updateStarRating(rating);
                    // Hide error when user selects a rating
                    const ratingError = document.getElementById('ratingError');
                    if (ratingError) {
                        ratingError.classList.add('hidden');
                    }
                }
            });

            // Hide comment error when user types
            if (feedbackCommentInput) {
                feedbackCommentInput.addEventListener('input', function() {
                    const comment = this.value;
                    if (commentError) {
                        if (comment && comment.length > 1000) {
                            commentError.classList.remove('hidden');
                        } else {
                            commentError.classList.add('hidden');
                        }
                    }
                });
            }

            // --- EDIT FEEDBACK FUNCTIONALITY ---
            let isEditMode = false;
            let editingFeedbackId = null;

            // Helper function to get token from multiple sources
            function getAccessToken() {
                // Try Model first
                let token = '@Model.AccessToken';
                if (token && token !== '') {
                    console.log('[Token] Found in Model.AccessToken');
                    return token;
                }
                
                // Try Cookie via Razor
                token = '@(Request.Cookies["AccessToken"])';
                if (token && token !== '') {
                    console.log('[Token] Found in Request.Cookies');
                    return token;
                }
                
                // Try localStorage
                token = localStorage.getItem('AccessToken');
                if (token && token !== '') {
                    console.log('[Token] Found in localStorage (AccessToken)');
                    return token;
                }
                
                token = localStorage.getItem('accessToken');
                if (token && token !== '') {
                    console.log('[Token] Found in localStorage (accessToken)');
                    return token;
                }
                
                // Try to get from cookie via JavaScript
                const cookies = document.cookie.split(';');
                for (let cookie of cookies) {
                    const [name, value] = cookie.trim().split('=');
                    if (name === 'AccessToken' && value) {
                        console.log('[Token] Found in document.cookie');
                        return value;
                    }
                }
                
                console.log('[Token] Not found in any source');
                return null;
            }

            // Handle edit feedback button clicks
            document.addEventListener('click', function(e) {
                if (e.target.closest('.edit-feedback-btn')) {
                    const btn = e.target.closest('.edit-feedback-btn');
                    const feedbackId = btn.dataset.feedbackId;
                    const rating = parseInt(btn.dataset.rating);
                    const comment = btn.dataset.comment;

                    // Set edit mode
                    isEditMode = true;
                    editingFeedbackId = feedbackId;

                    // Populate modal with existing data
                    feedbackRatingInput.value = rating;
                    feedbackCommentInput.value = comment;
                    updateStarRating(rating);

                    // Change modal title and button text
                    const modalTitle = feedbackModal.querySelector('h2');
                    if (modalTitle) modalTitle.textContent = 'Edit Your Feedback';
                    
                    const submitBtn = feedbackForm.querySelector('button[type="submit"]');
                    if (submitBtn) submitBtn.textContent = 'Update Feedback';

                    // Show modal
                    feedbackModal.classList.remove('hidden');
                    document.body.classList.add('overflow-hidden');
                }
            });

            // Handle feedback form submission (both create and edit)
            if (feedbackForm) {
                const originalSubmitHandler = feedbackForm.onsubmit;
                feedbackForm.onsubmit = async function(e) {
                    const rating = parseInt(feedbackRatingInput.value);
                    const comment = feedbackCommentInput.value;

                    // Validation
                    let hasError = false;
                    if (!rating || rating < 1 || rating > 5) {
                        hasError = true;
                        if (ratingError) ratingError.classList.remove('hidden');
                    } else {
                        if (ratingError) ratingError.classList.add('hidden');
                    }

                    if (comment && comment.length > 1000) {
                        hasError = true;
                        if (commentError) commentError.classList.remove('hidden');
                    } else {
                        if (commentError) commentError.classList.add('hidden');
                    }

                    if (hasError) {
                        e.preventDefault();
                        return false;
                    }

                    // If edit mode, call API to update
                    if (isEditMode && editingFeedbackId) {
                        e.preventDefault(); // Prevent form submission for edit mode
                        try {
                            // Get token using helper function
                            const token = getAccessToken();
                            
                            if (!token) {
                                showToast('Please log in to edit feedback', 'error');
                                return false;
                            }

                            console.log('[Edit Feedback] Sending update request for feedback:', editingFeedbackId);
                            console.log('[Edit Feedback] API URL:', `@Model.ApiBaseUrl/feedbacks/${editingFeedbackId}/update`);
                            console.log('[Edit Feedback] Payload:', { rating, comment });
                            
                            const response = await fetch(`@Model.ApiBaseUrl/feedbacks/${editingFeedbackId}/update`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${token}`
                                },
                                body: JSON.stringify({
                                    rating: rating,
                                    comment: comment
                                })
                            });

                            console.log('[Edit Feedback] Response status:', response.status);
                            
                            if (response.ok) {
                                showToast('Feedback updated successfully!', 'success');
                                
                                // Update feedback in DOM without reloading
                                const feedbackCard = document.querySelector(`.bg-gray-50[data-feedback-id="${editingFeedbackId}"]`);
                                if (feedbackCard) {
                                    // Update rating stars (Lucide icons)
                                    const starsContainer = feedbackCard.querySelector('.flex.items-center.space-x-2 .flex');
                                    if (starsContainer) {
                                        const stars = starsContainer.querySelectorAll('[data-lucide="star"]');
                                        stars.forEach((star, index) => {
                                            if (index < rating) {
                                                star.classList.add('fill-yellow-400', 'text-yellow-400');
                                                star.classList.remove('text-gray-300');
                                            } else {
                                                star.classList.remove('fill-yellow-400', 'text-yellow-400');
                                                star.classList.add('text-gray-300');
                                            }
                                        });
                                    }
                                    
                                    // Update comment text
                                    const commentElement = feedbackCard.querySelector('.text-gray-700');
                                    if (commentElement) {
                                        commentElement.textContent = comment || 'No comment provided';
                                    }
                                    
                                    // Update edit button data attributes
                                    const editBtn = feedbackCard.querySelector('.edit-feedback-btn');
                                    if (editBtn) {
                                        editBtn.setAttribute('data-rating', rating);
                                        editBtn.setAttribute('data-comment', comment);
                                    }
                                }
                                
                                // Close modal
                                feedbackModal.classList.add('hidden');
                                document.body.classList.remove('overflow-hidden');
                                
                                // Reset edit mode
                                isEditMode = false;
                                editingFeedbackId = null;
                            } else {
                                let errorMessage = 'Failed to update feedback';
                                try {
                                    const error = await response.json();
                                    errorMessage = error.message || error.title || errorMessage;
                                    console.error('[Edit Feedback] Error response:', error);
                                } catch (e) {
                                    const errorText = await response.text();
                                    console.error('[Edit Feedback] Error text:', errorText);
                                    if (response.status === 401) {
                                        errorMessage = 'Please log in to edit feedback';
                                    } else if (response.status === 403) {
                                        errorMessage = 'You are not authorized to edit this feedback';
                                    }
                                }
                                showToast(errorMessage, 'error');
                            }
                        } catch (error) {
                            console.error('Error updating feedback:', error);
                            showToast('An error occurred while updating feedback', 'error');
                        }
                        return false;
                    }

                    // Otherwise, allow default form submission for create (don't prevent default)
                    // Form will submit normally to asp-page-handler="AddFeedback"
                };
            }

            // Reset edit mode when closing modal
            if (closeFeedbackBtn) {
                closeFeedbackBtn.addEventListener('click', () => {
                    isEditMode = false;
                    editingFeedbackId = null;
                    const modalTitle = feedbackModal.querySelector('h2');
                    if (modalTitle) modalTitle.textContent = 'Leave Your Feedback';
                    const submitBtn = feedbackForm.querySelector('button[type="submit"]');
                    if (submitBtn) submitBtn.textContent = 'Submit Feedback';
                });
            }

            if (cancelFeedbackBtn) {
                cancelFeedbackBtn.addEventListener('click', () => {
                    isEditMode = false;
                    editingFeedbackId = null;
                    const modalTitle = feedbackModal.querySelector('h2');
                    if (modalTitle) modalTitle.textContent = 'Leave Your Feedback';
                    const submitBtn = feedbackForm.querySelector('button[type="submit"]');
                    if (submitBtn) submitBtn.textContent = 'Submit Feedback';
                });
            }

                // Chỉ thực thi JavaScript nếu Model.Product tồn tại
        @if (Model.Product != null)
        {
            <text>
                                // --- PHẦN 1: LOGIC CHO TRANG SẢN PHẨM ---

                                // Image gallery logic
            const mainImage = document.getElementById('mainProductImage');
            const thumbnailBtns = document.querySelectorAll('.thumbnail-btn');
                thumbnailBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        mainImage.src = btn.dataset.imageSrc;
                        thumbnailBtns.forEach(b => {
                            b.classList.remove('border-purple-600');
                            b.classList.add('border-gray-200');
                        });
                        btn.classList.remove('border-gray-200');
                        btn.classList.add('border-purple-600');
                    });
                    
                    // Add double-click to open modal
                    btn.addEventListener('dblclick', () => {
                        openImageModal(btn.dataset.imageSrc);
                    });
                });

                // Size selection logic
                const sizeBtns = document.querySelectorAll('.size-btn');
                const selectedSizeInput = document.getElementById('selectedSizeInput');
                sizeBtns.forEach(btn => {
                    btn.addEventListener('click', () => {
                        selectedSizeInput.value = btn.dataset.size;
                        sizeBtns.forEach(b => {
                            b.classList.remove('bg-purple-600', 'text-white', 'border-purple-600');
                        });
                        btn.classList.add('bg-purple-600', 'text-white', 'border-purple-600');
                    });
                });

                // Rental selection removed; calculation will be done in Cart

                // Form validation
                const addToCartForm = document.getElementById('addToCartForm');
                // Size and transaction type validation is now handled in the DOMContentLoaded section above
                // No need for duplicate validation here

                // Favorite button logic
                const favoriteForm = document.querySelector('.favorite-form');
                if (favoriteForm) {
                    favoriteForm.addEventListener('submit', async (e) => {
                        e.preventDefault();
                        
                        // Check if user is authenticated
                        const isAuthenticated = '@User.Identity.IsAuthenticated'.toLowerCase() === 'true';
                        if (!isAuthenticated) {
                            showToast('Please log in to add products to your favorites', 'error');
                            return;
                        }
                        
                        const button = favoriteForm.querySelector('.favorite-btn');
                        const icon = favoriteForm.querySelector('.favorite-icon');
                        const productId = favoriteForm.querySelector('input[name="productId"]').value;
                        
                        if (!productId) return;
                        
                        // Disable button during request
                        button.disabled = true;
                        
                        try {
                            const formData = new FormData(favoriteForm);
                            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
                            
                            const response = await fetch(`/products/detail/${productId}?handler=AddFavorite`, {
                                method: 'POST',
                                body: formData,
                                headers: {
                                    'RequestVerificationToken': token
                                }
                            });
                            
                            if (response.ok) {
                                // Toggle heart icon immediately
                                const isCurrentlyFavorite = icon.classList.contains('text-red-500');
                                
                                if (isCurrentlyFavorite) {
                                    // Remove from favorites
                                    icon.classList.remove('text-red-500', 'fill-red-500');
                                    icon.classList.add('text-gray-400', 'hover:text-red-500');
                                    showToast('Removed from favorites', 'success');
                                } else {
                                    // Add to favorites
                                    icon.classList.remove('text-gray-400', 'hover:text-red-500');
                                    icon.classList.add('text-red-500', 'fill-red-500');
                                    showToast('Added to favorites', 'success');
                                }
                            } else if (response.status === 401) {
                                // User not authenticated
                                showToast('Please login to add products to your favorites', 'error');
                            } else {
                                console.error('Failed to update favorite status');
                                showToast('Failed to update favorite', 'error');
                            }
                        } catch (error) {
                            console.error('Error updating favorite:', error);
                            showToast('Network error occurred', 'error');
                        } finally {
                            // Re-enable button
                            button.disabled = false;
                        }
                    });
                }

                // Try On button logic - already handled above in DOMContentLoaded
                // This duplicate can be removed

                // --- PHẦN 2: LOGIC CHO CHAT MODAL ---

                // DOM Elements
                const openChatBtn = document.getElementById('openChatBtn');
                const closeChatBtn = document.getElementById('closeChatBtn');
                const chatModal = document.getElementById('chatModal');
                const messagesContainer = document.getElementById('chat-messages');
                const messageForm = document.getElementById('sendMessageForm');
                const messageInput = document.getElementById('chat-message-input');
                const sendBtn = document.getElementById('chat-send-btn');
                const providerNameEl = document.getElementById('chat-provider-name');

                // Data from Model
                const providerId = '@Model.Product.ProviderId';
                const currentUserId = '@Model.CurrentUserId';
                const productId = '@Model.Product.Id';
                const apiUrl = '@Model.ApiBaseUrl';
                const signalRUrl = '@Model.SignalRRootUrl';
                const accessToken = '@Model.AccessToken';

                // State variables
                let signalRConnection = null;
                let currentConversationId = null;
                let currentPage = 1;
                const pageSize = 15;
                let isLoadingMessages = false;
                let allMessagesLoaded = false;

                // Helper Functions
                function createMessageElement(message, isMe) {
                    const messageDiv = document.createElement('div');
                    messageDiv.classList.add('flex', 'mb-2', isMe ? 'justify-end' : 'justify-start');
                    
                    // Create container for bubble and timestamp
                    const bubbleContainer = document.createElement('div');
                    bubbleContainer.classList.add('message-bubble-container', isMe ? 'me' : 'them');
                    
                    // Create message bubble
                    const bubbleDiv = document.createElement('div');
                    bubbleDiv.classList.add('message-bubble', 'px-4', 'py-2', 'rounded-lg', 'break-words', isMe ? 'bg-purple-600' : 'bg-gray-200', isMe ? 'text-white' : 'text-gray-800');
                    if (isMe) {
                        bubbleDiv.classList.add('me');
                    } else {
                        bubbleDiv.classList.add('them');
                    }
                    bubbleDiv.textContent = message.content;
                    
                    // Create timestamp element
                    const timestampDiv = document.createElement('div');
                    timestampDiv.classList.add('message-timestamp');
                    
                    // Format timestamp - handle both Date objects and string dates
                    let formattedTime = '';
                    if (message.sentAt || message.timestamp) {
                        const msgDate = new Date(message.sentAt || message.timestamp);
                        const now = new Date();
                        const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        const msgDateOnly = new Date(msgDate.getFullYear(), msgDate.getMonth(), msgDate.getDate());
                        
                        if (msgDateOnly.getTime() === today.getTime()) {
                            // Today - show only time
                            formattedTime = msgDate.toLocaleTimeString('vi-VN', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                        } else if (msgDateOnly.getTime() === today.getTime() - 24 * 60 * 60 * 1000) {
                            // Yesterday
                            formattedTime = 'Hôm qua ' + msgDate.toLocaleTimeString('vi-VN', { 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                        } else {
                        // Older - show date and time
                        formattedTime = msgDate.toLocaleDateString('vi-VN', { 
                            day: '2-digit', 
                            month: '2-digit',
                            year: 'numeric'
                        }) + ' ' + msgDate.toLocaleTimeString('vi-VN', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                        }
                    } else {
                        // Fallback for messages without timestamp
                        formattedTime = new Date().toLocaleTimeString('vi-VN', { 
                            hour: '2-digit', 
                            minute: '2-digit' 
                        });
                    }
                    
                    timestampDiv.textContent = formattedTime;
                    
                    // Add click handler to toggle timestamp
                    bubbleDiv.addEventListener('click', function() {
                        timestampDiv.classList.toggle('show');
                    });
                    
                    // Assemble the message
                    bubbleContainer.appendChild(bubbleDiv);
                    bubbleContainer.appendChild(timestampDiv);
                    messageDiv.appendChild(bubbleContainer);
                    
                    return messageDiv;
                }

                function appendNewMessage(message) {
                    const isMe = message.senderId.toLowerCase() === currentUserId.toLowerCase();
                    const el = createMessageElement(message, isMe);
                    messagesContainer.appendChild(el);
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }

                function prependOldMessage(message) {
                    const isMe = message.senderId.toLowerCase() === currentUserId.toLowerCase();
                    const el = createMessageElement(message, isMe);
                    messagesContainer.prepend(el);
                }

                // Main Logic Functions
                async function loadMessageHistory() {
                    if (isLoadingMessages || allMessagesLoaded || !currentConversationId) return;
                    isLoadingMessages = true;

                    try {
                        const response = await fetch(`${apiUrl}/conversations/${currentConversationId}/messages?page=${currentPage}&pageSize=${pageSize}`, {
                            headers: { 'Authorization': 'Bearer ' + accessToken }
                        });
                        if (!response.ok) throw new Error('Failed to load messages.');

                        const messages = await response.json();
                        const oldScrollHeight = messagesContainer.scrollHeight;

                        if (messages.length > 0) {
                            messages.reverse().forEach(prependOldMessage);
                            messagesContainer.scrollTop = messagesContainer.scrollHeight - oldScrollHeight;
                            currentPage++;
                            } else {
                            allMessagesLoaded = true;
                        }
                    } catch (error) {
                        console.error(error);
                    } finally {
                        isLoadingMessages = false;
                    }
                }

                async function setupSignalRConnection() {
                    if (signalRConnection) await signalRConnection.stop();

                    signalRConnection = new signalR.HubConnectionBuilder()
                        .withUrl(`${signalRUrl}/chathub?access_token=${accessToken}`)
                        .withAutomaticReconnect().build();

                    signalRConnection.on("ReceiveMessage", (message) => {
                        if (message.conversationId.toLowerCase() === currentConversationId.toLowerCase()) {
                            const isMe = message.senderId.toLowerCase() === currentUserId.toLowerCase();
                            if (!isMe) {
                                appendNewMessage(message);
                            }
                        }
                    });

                    await signalRConnection.start();
                    messageInput.disabled = false;
                    sendBtn.disabled = false;
                }

                async function initializeChat() {
                    currentPage = 1;
                    isLoadingMessages = false;
                    allMessagesLoaded = false;
                    messagesContainer.innerHTML = '<div class="text-center text-gray-400">Initializing...</div>';

                    try {
                        const response = await fetch(`${apiUrl}/conversations/find-or-create`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + accessToken },
                            body: JSON.stringify({ recipientId: providerId })
                        });

                        if (!response.ok) throw new Error(`Failed to start conversation. Status: ${response.status}`);

                        const conversation = await response.json();
                        currentConversationId = conversation.id;
                        providerNameEl.textContent = `Chat with ${conversation.otherParticipant.fullName}`;

                        messagesContainer.innerHTML = '';
                        await setupSignalRConnection();
                        await loadMessageHistory();
                    } catch (error) {
                        console.error(error);
                        messagesContainer.innerHTML = `<div class="text-center text-red-500">${error.message}</div>`;
                    }
                }

                // Event Listeners
                if (openChatBtn) {
                    openChatBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        if (!accessToken) {
                            showToast("Please log in to chat with provider", 'error');
                            return;
                        }
                        chatModal.classList.remove('hidden');
                        document.body.classList.add('overflow-hidden');
                        initializeChat();
                    });
                }

                if (closeChatBtn) {
                    closeChatBtn.addEventListener('click', () => {
                    chatModal.classList.add('hidden');
                    document.body.classList.remove('overflow-hidden');
                        if (signalRConnection) {
                            signalRConnection.stop().then(() => signalRConnection = null);
                        }
                    });
                }

                messageForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const messageContent = messageInput.value.trim();
                    if (messageContent && signalRConnection && currentConversationId) {
                        const tempMessage = { 
                            content: messageContent, 
                            senderId: currentUserId,
                            sentAt: new Date().toISOString()
                        };
                        appendNewMessage(tempMessage);

                        signalRConnection.invoke("SendMessageAsync", currentConversationId, providerId, messageContent, productId)
                            .catch(err => {
                                console.error("Failed to send message:", err);
                                alert("Could not send message. Please try again.");
                            });
                        messageInput.value = '';
                    }
                });

                messagesContainer.addEventListener('scroll', () => {
                    if (messagesContainer.scrollTop === 0 && currentConversationId) {
                        loadMessageHistory();
                    }
                });
            </text>
        }
        });
    </script>
}