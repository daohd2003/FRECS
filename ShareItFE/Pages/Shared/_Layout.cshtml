@using System.Security.Claims
@using Microsoft.Extensions.Configuration
@using Microsoft.Extensions.Hosting
@using ShareItFE.Extensions
@inject IConfiguration Configuration
@inject IWebHostEnvironment Environment
@{
    var currentUserRole = User.FindFirst(ClaimTypes.Role)?.Value;
    var currentUserId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    var isAuthenticated = User.Identity?.IsAuthenticated ?? false;
    var isAdminOrStaff = currentUserRole == "admin" || currentUserRole == "staff";
}
@RenderSection("Styles", required: false)
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="google-site-verification" content="0VYMzguWzsfU-kB4G1Z_C5Md0zZK9x5c7vUswq4Ck78" />
    <title>@ViewData["Title"] - FRECS</title>
    
    <!-- FRECS Favicon -->
    <link rel="apple-touch-icon" sizes="180x180" href="~/favicon_io/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="~/favicon_io/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="~/favicon_io/favicon-16x16.png">
    <link rel="manifest" href="~/favicon_io/site.webmanifest">
    <link rel="shortcut icon" href="~/favicon_io/favicon.ico" type="image/x-icon">
    <script>
        const currentEnvironment = '@Environment.EnvironmentName';
        const apiRootUrl = '@(Configuration[$"ApiSettings:{Environment.EnvironmentName}:RootUrl"] ?? "https://localhost:7256")';
        // Global API settings for JavaScript
        window.apiSettings = {
            environment: currentEnvironment,
            baseUrl: '@(Configuration[$"ApiSettings:{Environment.EnvironmentName}:BaseUrl"] ?? "https://localhost:7256/api")',
            rootUrl: '@(Configuration[$"ApiSettings:{Environment.EnvironmentName}:RootUrl"] ?? "https://localhost:7256")',
            frontendUrl: '@(Configuration[$"FrontendSettings:{Environment.EnvironmentName}:BaseUrl"] ?? "https://localhost:7045")'
        };
        console.log('Environment:', currentEnvironment);
        console.log('API Settings:', window.apiSettings);
        
        @if (isAuthenticated)
        {
            <text>
        // Floating chat config for authenticated users
        window.adminChatConfig = {
            currentUserId: '@currentUserId',
            accessToken: '@Context.Request.Cookies["AccessToken"]',
            apiBaseUrl: '@(Configuration[$"ApiSettings:{Environment.EnvironmentName}:BaseUrl"] ?? "https://localhost:7256/api")',
            signalRRootUrl: '@(Configuration[$"ApiSettings:{Environment.EnvironmentName}:RootUrl"] ?? "https://localhost:7256")'
        };
            </text>
        }
    </script>
    <link rel="stylesheet" href="~/lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/css/site.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/ShareItFE.styles.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/chatbot.css" />
    <link rel="stylesheet" href="~/css/chat.css" asp-append-version="true" />
    @if (isAuthenticated)
    {
        <link rel="stylesheet" href="~/css/floating-chat.css" asp-append-version="true" />
    }
</head>
<body>
    @await Component.InvokeAsync("Header")
    <main role="main" class="main-content-area">
        @RenderBody()
    </main>
    @{
        var tiktokUrl = "https://www.tiktok.com/@frecs.luxury.fash?is_from_webapp=1&sender_device=pc";
    }
    <footer class="main-footer">
        <div class="max-width-container">
            <!-- Social Links Section -->
            <div class="footer-social-section">
                <span class="footer-social-label">Community:</span>
                <div class="footer-social-buttons">
                    <a href="https://www.facebook.com/profile.php?id=61584893848772" target="_blank" class="footer-social-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>
                        Fanpage
                    </a>
                    <a href="@tiktokUrl" target="_blank" class="footer-social-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M19.59 6.69a4.83 4.83 0 0 1-3.77-4.25V2h-3.45v13.67a2.89 2.89 0 0 1-5.2 1.74 2.89 2.89 0 0 1 2.31-4.64 2.93 2.93 0 0 1 .88.13V9.4a6.84 6.84 0 0 0-1-.05A6.33 6.33 0 0 0 5 20.1a6.34 6.34 0 0 0 10.86-4.43v-7a8.16 8.16 0 0 0 4.77 1.52v-3.4a4.85 4.85 0 0 1-1-.1z" /></svg>
                        Tiktok
                    </a>
                    <a href="https://www.facebook.com/profile.php?id=61584893848772" target="_blank" class="footer-social-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M17 2H7a5 5 0 0 0-5 5v10a5 5 0 0 0 5 5h10a5 5 0 0 0 5-5V7a5 5 0 0 0-5-5zm-5 16c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6zm6.5-11a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/></svg>
                        FB group
                    </a>
                    <a href="https://discord.com/channels/1402690724440440965/1434153642142863462" target="_blank" class="footer-social-btn">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/></svg>
                        Discord
                    </a>
                </div>
            </div>

            <!-- Main Footer Content -->
            <div class="footer-main-content">
                <div class="footer-brand-section">
                    <div class="footer-brand-logo-group">
                        <svg xmlns="http://www.w3.org/2000/svg" class="footer-brand-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M6.7,16.2l-2.8,2.8a1,1,0,0,0,0,1.4l7.1,7.1a1,1,0,0,0,1.4,0l7.1-7.1a1,1,0,0,0,0-1.4l-2.8-2.8" />
                            <path d="M8.1,14.8,3,20H21l-5.1-5.2" />
                            <path d="M12,2a4,4,0,0,0-4,4v2.4a4,4,0,0,0,8,0V6A4,4,0,0,0,12,2Z" />
                            <line x1="10" y1="12" x2="14" y2="12" />
                        </svg>
                        <span class="footer-brand-name">FRECS</span>
                    </div>
                </div>
                <div class="footer-company-info">
                    <p class="footer-company-name">FRECS Fashion Rental Platform</p>
                    <div class="footer-company-row">
                        <div class="footer-info-item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg>
                            <span>FPT University, Da Nang, Vietnam</span>
                        </div>
                        <div class="footer-info-item">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                            <span>frecsfashion@gmail.com</span>
                        </div>
                    </div>
                    <p class="footer-company-detail">Website Manager: Ha Danh Dao - Position: Administrator - Phone: 0347350184</p>
                </div>
            </div>

            <!-- Footer Bottom -->
            <div class="footer-bottom-bar">
                <p class="footer-copyright">&copy; @DateTime.Now.Year FRECS</p>
                <div class="footer-policy-links">
                    <a href="/Policies?policy=exchange-and-return-policy" class="footer-policy-link">Exchange and Return Policy</a>
                    <a href="/Policies?policy=privacy-policy" class="footer-policy-link">Privacy Policy</a>
                    <a href="/Policies?policy=product-inspection-policy" class="footer-policy-link">Product Inspection Policy</a>
                    <a href="/Policies?policy=rental-and-sales-policy" class="footer-policy-link">Rental and Sales Policy</a>
                    <a href="/Policies?policy=terms-of-service" class="footer-policy-link">Terms of Service</a>
                </div>
            </div>
        </div>
    </footer>
    <script src="~/lib/jquery/dist/jquery.min.js"></script>
    <script src="~/lib/bootstrap/dist/js/bootstrap.bundle.min.js"></script>
    <script src="~/js/site.js" asp-append-version="true"></script>
    <script src="~/js/toast-manager.js" asp-append-version="true"></script>
    <script src="~/js/notification.js" asp-append-version="true"></script>

    <!-- TempData Toast Messages -->
    @{
        var toastMessages = TempData.GetToastMessagesJson();
    }
    <script type="application/json" id="tempdata-messages">@Html.Raw(toastMessages)</script>

    <script src="~/js/dist/browser/signalr.js"></script>
    @if (isAuthenticated)
    {
        <script src="~/js/floating-chat-manager.js" asp-append-version="true"></script>
    }
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Xử lý menu người dùng
            const userMenuButton = document.getElementById('userMenuButton');
            const userMenuDropdown = document.getElementById('userMenuDropdown');

            if (userMenuButton && userMenuDropdown) {
                userMenuButton.addEventListener('click', function (event) {
                    event.stopPropagation();
                    const isHidden = userMenuDropdown.style.display === 'none' || userMenuDropdown.style.display === '';
                    userMenuDropdown.style.display = isHidden ? 'block' : 'none';
                });
            }

            // Xử lý menu di động
            const mobileMenuButton = document.getElementById('mobileMenuButton');
            const mobileMenu = document.getElementById('mobileMenu');
            const menuIconOpen = document.getElementById('menuIconOpen');
            const menuIconClose = document.getElementById('menuIconClose');

            if (mobileMenuButton && mobileMenu && menuIconOpen && menuIconClose) {
                mobileMenuButton.addEventListener('click', function (event) {
                    event.stopPropagation();
                    const isMenuOpen = mobileMenu.style.display === 'block';
                    mobileMenu.style.display = isMenuOpen ? 'none' : 'block';
                    menuIconOpen.style.display = isMenuOpen ? 'block' : 'none';
                    menuIconClose.style.display = isMenuOpen ? 'none' : 'block';
                });
            }

            // Đóng dropdown khi click ra ngoài
            window.addEventListener('click', function (event) {
                // Close user dropdown if click outside
                if (userMenuDropdown && userMenuDropdown.style.display === 'block') {
                    if (!userMenuButton.contains(event.target)) {
                        userMenuDropdown.style.display = 'none';
                    }
                }
                
                // Close mobile menu if click outside
                if (mobileMenu && mobileMenu.style.display === 'block') {
                    if (!mobileMenuButton.contains(event.target) && !mobileMenu.contains(event.target)) {
                        mobileMenu.style.display = 'none';
                        if (menuIconOpen && menuIconClose) {
                            menuIconOpen.style.display = 'block';
                            menuIconClose.style.display = 'none';
                        }
                    }
                }
            });

            // START: Thêm code cho SignalR Real-time Notification
            // Logic này sẽ được thực thi sau khi trang đã tải xong
            const notificationMenu = document.querySelector('.notification-menu');
            if (notificationMenu) {
                const userId = notificationMenu.getAttribute('data-userid');

                if (userId) {
                    // 1. Khởi tạo kết nối đến SignalR Hub
                    const connection = new signalR.HubConnectionBuilder()
                        .withUrl(apiRootUrl + "/notificationHub")
                        .withAutomaticReconnect()
                        .build();

                    // 2. Lắng nghe sự kiện 'ReceiveNotification' từ server
                    connection.on("ReceiveNotification", (message) => {
                        console.log("Real-time notification received: ", message);

                        // Đây là nơi bạn cập nhật giao diện
                        // Ví dụ: làm cho biểu tượng chuông hiện số thông báo mới
                        const notificationCountSpan = document.getElementById('notificationCount');
                        if (notificationCountSpan) {
                            notificationCountSpan.style.display = 'flex';
                            let currentCount = parseInt(notificationCountSpan.innerText) || 0;
                            notificationCountSpan.innerText = currentCount + 1;
                        }

                        // Bạn cũng có thể gọi một hàm từ notification.js để tải lại danh sách thông báo
                        if (window.loadNotifications) {
                            window.loadNotifications(userId);
                        }
                    });

                    // 3. Bắt đầu kết nối và tham gia vào nhóm của người dùng
                    async function startSignalR() {
                        try {
                            await connection.start();
                            console.log("SignalR Connected.");
                            // Gọi phương thức trên Hub để tham gia nhóm thông báo riêng
                            await connection.invoke("JoinCustomerNotificationGroup", userId);
                            console.log(`User ${userId} has joined their notification group.`);
                        } catch (err) {
                            console.error("SignalR Connection Error: ", err);
                            // Thử lại sau 5 giây nếu kết nối thất bại
                            setTimeout(startSignalR, 5000);
                        }
                    }

                    startSignalR();
                }
            }
            // END: Thêm code cho SignalR Real-time Notification

            // START: ActiveUsersHub Connection (for admin tracking)
            @if (isAuthenticated)
            {
                <text>
            const activeUsersConnection = new signalR.HubConnectionBuilder()
                .withUrl(apiRootUrl + "/activeUsersHub", {
                    accessTokenFactory: () => window.adminChatConfig?.accessToken || '@Context.Request.Cookies["AccessToken"]'
                })
                .withAutomaticReconnect()
                .configureLogging(signalR.LogLevel.Information)
                .build();

            activeUsersConnection.start().catch(() => {});
                </text>
            }
            // END: ActiveUsersHub Connection
        });
    </script>

    @await RenderSectionAsync("Scripts", required: false)
</body>
</html>