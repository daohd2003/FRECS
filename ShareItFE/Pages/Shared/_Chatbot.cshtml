@inject IConfiguration Configuration
@inject IWebHostEnvironment Environment
@using System.Security.Claims

@{
    var currentUserId = User.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    var isLoggedIn = User.Identity?.IsAuthenticated ?? false;
}

<div id="chatToggleBtn" class="chat-toggle-btn">
    <img src="~/images/chatbot-icon.png" alt="Open Chatbot" />
</div>

<div id="chatbotWidget" class="chatbot-widget hidden">
    <div class="chat-header">
        <div class="header-left">
            <img src="~/images/chatbot-icon.png" alt="Meta AI Icon" class="meta-ai-icon" /> AI Assistant
        </div>
        <div class="header-right">
            <span id="clearChatBtn" class="clear-btn" style="cursor: pointer" title="Clear chat history">🗑️</span>
            <span id="collapseChatBtn" class="collapse-btn">-</span>
        </div>
    </div>
    <div class="chat-body" id="chatBody"></div>

    <div class="quick-suggestions" id="quickSuggestions">
        <div class="suggestions-header">
            <div class="suggestions-label">Quick suggestions:</div>
            <button type="button" class="toggle-suggestions-btn" id="toggleSuggestionsBtn" title="Toggle suggestions">
                <span class="toggle-icon">▼</span>
            </button>
        </div>
        <div class="suggestions-container" id="suggestionsContainer"></div>
    </div>

    <form id="chatForm" class="chat-input-form">
        <input type="text" id="chatInput" class="chat-input" placeholder="Ask me about clothing..." autocomplete="off" />
        <button type="submit" class="chat-send-btn">▶</button>
    </form>
</div>

    <script>
        const API_BASE_URL = '@(Configuration[$"ApiSettings:{Environment.EnvironmentName}:BaseUrl"] ?? "https://localhost:7256/api")';
        const CHAT_STORAGE_KEY = 'frecs_chat_history_v1';
        const CURRENT_USER_ID = '@currentUserId';
        const IS_LOGGED_IN = @(isLoggedIn.ToString().ToLower());

        document.addEventListener('DOMContentLoaded', () => {
            const chatToggleBtn = document.getElementById('chatToggleBtn');
            const chatbotWidget = document.getElementById('chatbotWidget');
            const collapseChatBtn = document.getElementById('collapseChatBtn');
            const clearChatBtn = document.getElementById('clearChatBtn');
            const chatForm = document.getElementById('chatForm');
            const chatInput = document.getElementById('chatInput');
            const chatBody = document.getElementById('chatBody');
            const quickSuggestions = document.getElementById('quickSuggestions');
            const suggestionsContainer = document.getElementById('suggestionsContainer');
            const toggleSuggestionsBtn = document.getElementById('toggleSuggestionsBtn');
            const toggleIcon = toggleSuggestionsBtn.querySelector('.toggle-icon');

            // Vietnamese events calendar
            const vietnameseEvents = [
                { month: 1, day: 1, name: "New Year", query: "Show me outfits for New Year celebration", daysBeforeToShow: 7 },
                { month: 1, day: 29, name: "Lunar New Year (Tet)", query: "Show me traditional outfits for Tet celebration", daysBeforeToShow: 15 }, // Approximate date, varies yearly
                { month: 2, day: 14, name: "Valentine's Day", query: "Show me romantic outfits for Valentine's Day", daysBeforeToShow: 7 },
                { month: 3, day: 8, name: "International Women's Day", query: "Show me elegant outfits for Women's Day celebration", daysBeforeToShow: 7 },
                { month: 4, day: 30, name: "Reunification Day", query: "Show me formal outfits for national holiday", daysBeforeToShow: 5 },
                { month: 5, day: 1, name: "Labor Day", query: "Show me casual outfits for Labor Day", daysBeforeToShow: 5 },
                { month: 6, day: 1, name: "Children's Day", query: "Show me fun outfits for family celebration", daysBeforeToShow: 5 },
                { month: 9, day: 2, name: "National Day", query: "Show me patriotic and formal outfits", daysBeforeToShow: 5 },
                { month: 10, day: 20, name: "Vietnamese Women's Day", query: "Show me beautiful outfits for Vietnamese Women's Day", daysBeforeToShow: 10 },
                { month: 11, day: 20, name: "Teachers' Day", query: "Show me elegant outfits for Teachers' Day", daysBeforeToShow: 10 },
                { month: 12, day: 24, name: "Christmas Eve", query: "Show me festive outfits for Christmas", daysBeforeToShow: 10 },
                { month: 12, day: 25, name: "Christmas", query: "Show me Christmas party outfits", daysBeforeToShow: 10 }
            ];

            // Check for upcoming events
            function getUpcomingEventSuggestions() {
                const now = new Date();
                // Reset to start of day for date-only comparison
                const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                
                const upcomingEvents = [];
                
                for (const event of vietnameseEvents) {
                    // Create event date (at start of day)
                    let eventDate = new Date(today.getFullYear(), event.month - 1, event.day);
                    
                    // Calculate days until event (can be negative if event passed)
                    const daysUntilEvent = Math.round((eventDate - today) / (1000 * 60 * 60 * 24));
                    
                    // Show suggestion if:
                    // - Event is within N days BEFORE (daysUntilEvent between 0 and daysBeforeToShow)
                    // - OR it's the event day itself (daysUntilEvent === 0)
                    if (daysUntilEvent >= 0 && daysUntilEvent <= event.daysBeforeToShow) {
                        upcomingEvents.push({
                            query: event.query,
                            daysUntil: daysUntilEvent,
                            name: event.name,
                            priority: daysUntilEvent // Closer events have higher priority (lower number)
                        });
                    }
                    // If event has passed this year, check next year's event
                    else if (daysUntilEvent < 0) {
                        eventDate = new Date(today.getFullYear() + 1, event.month - 1, event.day);
                        const daysUntilNextYear = Math.round((eventDate - today) / (1000 * 60 * 60 * 24));
                        
                        if (daysUntilNextYear >= 0 && daysUntilNextYear <= event.daysBeforeToShow) {
                            upcomingEvents.push({
                                query: event.query,
                                daysUntil: daysUntilNextYear,
                                name: event.name,
                                priority: daysUntilNextYear
                            });
                        }
                    }
                }
                
                // Sort by priority (closest events first)
                upcomingEvents.sort((a, b) => a.priority - b.priority);
                
                return upcomingEvents.slice(0, 2).map(e => e.query); // Return max 2 event suggestions
            }

            // Quick suggestion templates
            const suggestionSets = {
                initial: IS_LOGGED_IN ? [
                    "What would you recommend for me?",
                    "Show me similar items to my previous rentals",
                    "What's new in my favorite categories?",
                    "Show me items in my usual size"
                ] : [
                    "Show me formal wear",
                    "What casual outfits do you have?",
                    "I need black clothing",
                    "Show me shirts available"
                ],
                followUp: [
                    "Show more options",
                    "What sizes are available?",
                    "Do you have this in other colors?",
                    "What's the price range?"
                ]
            };

            function saveHistory(history) {
                try { 
                    localStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(history));
                    // Set timestamp for last activity
                    localStorage.setItem(CHAT_STORAGE_KEY + '_timestamp', Date.now().toString());
                } catch {}
            }

            function loadHistory() {
                try {
                    const raw = localStorage.getItem(CHAT_STORAGE_KEY);
                    if (!raw) return [];
                    
                    // Check if history is older than 24 hours (optional - auto cleanup)
                    const timestamp = localStorage.getItem(CHAT_STORAGE_KEY + '_timestamp');
                    if (timestamp) {
                        const hoursSinceLastActivity = (Date.now() - parseInt(timestamp)) / (1000 * 60 * 60);
                        if (hoursSinceLastActivity > 24) {
                            // Clear old history
                            localStorage.removeItem(CHAT_STORAGE_KEY);
                            localStorage.removeItem(CHAT_STORAGE_KEY + '_timestamp');
                            return [];
                        }
                    }
                    
                    return JSON.parse(raw);
                } catch { return []; }
            }

            function renderHistory(history) {
                chatBody.innerHTML = '';
                history.forEach(msg => {
                    const roleClass = msg.role === 'user' ? 'user' : 'bot';
                    chatBody.innerHTML += `<div class="chat-bubble ${roleClass}">${msg.html ?? escapeHtml(msg.content)}</div>`;
                });
                chatBody.scrollTop = chatBody.scrollHeight;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.innerText = text ?? '';
                return div.innerHTML;
            }

            function toggleChatbot() {
                chatbotWidget.classList.toggle('hidden');
                chatToggleBtn.style.display = chatbotWidget.classList.contains('hidden') ? 'flex' : 'none';
            }

            // Initialize visibility
            chatbotWidget.classList.add('hidden');
            chatToggleBtn.style.display = 'flex';

            function renderSuggestions(suggestions) {
                suggestionsContainer.innerHTML = '';
                suggestions.forEach(suggestion => {
                    const btn = document.createElement('button');
                    btn.className = 'suggestion-btn';
                    btn.textContent = suggestion;
                    btn.type = 'button';
                    btn.addEventListener('click', () => {
                        chatInput.value = suggestion;
                        chatForm.dispatchEvent(new Event('submit'));
                    });
                    suggestionsContainer.appendChild(btn);
                });
            }

            function updateSuggestions(history) {
                // Show initial suggestions if chat is empty or just greeting
                if (history.length <= 1) {
                    // Get event-based suggestions
                    const eventSuggestions = getUpcomingEventSuggestions();
                    
                    // Merge event suggestions with regular initial suggestions
                    let allSuggestions = [];
                    if (eventSuggestions.length > 0) {
                        // Add event suggestions first (they are more timely/relevant)
                        allSuggestions = [...eventSuggestions];
                        // Then add some regular suggestions (limit total to 4-5)
                        const remainingSlots = 4 - eventSuggestions.length;
                        if (remainingSlots > 0) {
                            allSuggestions.push(...suggestionSets.initial.slice(0, remainingSlots));
                        }
                    } else {
                        // No events, use regular suggestions
                        allSuggestions = suggestionSets.initial;
                    }
                    
                    renderSuggestions(allSuggestions);
                    quickSuggestions.style.display = 'block';
                } else {
                    // Hide suggestions after user starts chatting
                    quickSuggestions.style.display = 'none';
                }
            }

            function toggleSuggestionsCollapse() {
                const isCollapsed = suggestionsContainer.classList.toggle('collapsed');
                toggleIcon.textContent = isCollapsed ? '▶' : '▼';
                toggleSuggestionsBtn.title = isCollapsed ? 'Show suggestions' : 'Hide suggestions';
            }

            function getGreetingMessage() {
                return IS_LOGGED_IN 
                    ? 'Hello! Welcome back to FRECS! I can help you find new items or recommend products based on your previous rentals. How can I assist you today?'
                    : 'Hello! I am your FRECS assistant. How can I help you find the perfect outfit today?';
            }

            function clearChatHistory() {
                if (confirm('Are you sure you want to clear the chat history?')) {
                    localStorage.removeItem(CHAT_STORAGE_KEY);
                    localStorage.removeItem(CHAT_STORAGE_KEY + '_timestamp');
                    history = [{ role: 'bot', content: getGreetingMessage() }];
                    saveHistory(history);
                    renderHistory(history);
                    updateSuggestions(history);
                }
            }

            // Wire events
            chatToggleBtn.addEventListener('click', toggleChatbot);
            collapseChatBtn.addEventListener('click', toggleChatbot);
            clearChatBtn.addEventListener('click', clearChatHistory);
            toggleSuggestionsBtn.addEventListener('click', toggleSuggestionsCollapse);

            // Initialize history and greeting
            let history = loadHistory();
            if (history.length === 0) {
                history.push({ role: 'bot', content: getGreetingMessage() });
                saveHistory(history);
            }
            renderHistory(history);
            updateSuggestions(history);

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const question = chatInput.value.trim();
                if (!question) return;

                // Push user message
                history.push({ role: 'user', content: question });
                saveHistory(history);
                renderHistory(history);
                updateSuggestions(history);

                chatInput.value = '';

                try {
                    // Build URL with userId if logged in
                    let apiUrl = `${API_BASE_URL}/AiSearch/ask?question=${encodeURIComponent(question)}`;
                    if (IS_LOGGED_IN && CURRENT_USER_ID) {
                        apiUrl += `&userId=${CURRENT_USER_ID}`;
                    }

                    const res = await fetch(apiUrl);
                    if (!res.ok) throw new Error(`Error ${res.status}`);

                    const data = await res.json();
                    const answer = data.answer || "Sorry, I couldn't find a suitable answer. Please try rephrasing your question.";
                    const answerHtml = answer
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>')
                        .replace(/\n/g, '<br/>' );

                    history.push({ role: 'bot', content: answer, html: answerHtml });
                    saveHistory(history);
                    renderHistory(history);
                } catch (err) {
                    const errorMsg = `Sorry, I encountered an error while processing your request. Please try again later.`;
                    history.push({ role: 'bot', content: errorMsg });
                    saveHistory(history);
                    renderHistory(history);
                }
            });
        });
    </script>
