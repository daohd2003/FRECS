@inject IConfiguration Configuration
@inject IWebHostEnvironment Environment

<div id="chatToggleBtn" class="chat-toggle-btn">
    <img src="~/images/chatbot-icon.png" alt="Open Chatbot" />
</div>

<div id="chatbotWidget" class="chatbot-widget hidden">
    <div class="chat-header">
        <div class="header-left">
            <img src="~/images/chatbot-icon.png" alt="Meta AI Icon" class="meta-ai-icon" /> AI Assistant
        </div>
        <div class="header-right">
            <span id="collapseChatBtn" class="collapse-btn">-</span>
        </div>
    </div>
    <div class="chat-body" id="chatBody"></div>

    <form id="chatForm" class="chat-input-form">
        <input type="text" id="chatInput" class="chat-input" placeholder="Enter your question..." autocomplete="off" />
        <button type="submit" class="chat-send-btn">Send</button>
    </form>
</div>

    <script>
        const API_BASE_URL = '@(Configuration[$"ApiSettings:{Environment.EnvironmentName}:BaseUrl"] ?? "https://localhost:7256/api")';
        const CHAT_STORAGE_KEY = 'frecs_chat_history_v1';

        document.addEventListener('DOMContentLoaded', () => {
            const chatToggleBtn = document.getElementById('chatToggleBtn');
            const chatbotWidget = document.getElementById('chatbotWidget');
            const collapseChatBtn = document.getElementById('collapseChatBtn');
            const chatForm = document.getElementById('chatForm');
            const chatInput = document.getElementById('chatInput');
            const chatBody = document.getElementById('chatBody');

            function saveHistory(history) {
                try { sessionStorage.setItem(CHAT_STORAGE_KEY, JSON.stringify(history)); } catch {}
            }

            function loadHistory() {
                try {
                    const raw = sessionStorage.getItem(CHAT_STORAGE_KEY);
                    return raw ? JSON.parse(raw) : [];
                } catch { return []; }
            }

            function renderHistory(history) {
                chatBody.innerHTML = '';
                history.forEach(msg => {
                    const roleClass = msg.role === 'user' ? 'user' : 'bot';
                    chatBody.innerHTML += `<div class="chat-bubble ${roleClass}">${msg.html ?? escapeHtml(msg.content)}</div>`;
                });
                chatBody.scrollTop = chatBody.scrollHeight;
            }

            function escapeHtml(text) {
                const div = document.createElement('div');
                div.innerText = text ?? '';
                return div.innerHTML;
            }

            function toggleChatbot() {
                chatbotWidget.classList.toggle('hidden');
                chatToggleBtn.style.display = chatbotWidget.classList.contains('hidden') ? 'flex' : 'none';
            }

            // Initialize visibility
            chatbotWidget.classList.add('hidden');
            chatToggleBtn.style.display = 'flex';

            // Wire events
            chatToggleBtn.addEventListener('click', toggleChatbot);
            collapseChatBtn.addEventListener('click', toggleChatbot);

            // Initialize history and greeting
            let history = loadHistory();
            if (history.length === 0) {
                history.push({ role: 'bot', content: 'Hello! How can I help you with FRECS today?' });
                saveHistory(history);
            }
            renderHistory(history);

            chatForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const question = chatInput.value.trim();
                if (!question) return;

                // Push user message
                history.push({ role: 'user', content: question });
                saveHistory(history);
                renderHistory(history);

                chatInput.value = '';

                try {
                    const res = await fetch(`${API_BASE_URL}/AiSearch/ask?question=${encodeURIComponent(question)}`);
                    if (!res.ok) throw new Error(`Error ${res.status}`);

                    const data = await res.json();
                    const answer = data.answer || "Sorry, I don't have a suitable answer.";
                    const answerHtml = answer
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/\[(.*?)\]\((.*?)\)/g, '<a href="$2" target="_blank">$1</a>')
                        .replace(/\n/g, '<br/>' );

                    history.push({ role: 'bot', content: answer, html: answerHtml });
                    saveHistory(history);
                    renderHistory(history);
                } catch (err) {
                    const errorMsg = `Error calling API: ${err.message}`;
                    history.push({ role: 'bot', content: errorMsg });
                    saveHistory(history);
                    renderHistory(history);
                }
            });
        });
    </script>
